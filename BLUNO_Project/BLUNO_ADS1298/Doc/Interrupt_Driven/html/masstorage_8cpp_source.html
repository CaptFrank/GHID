<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ADS1298_BLE_Sensor_Interrupt_Driven: GHID_Framework/Src/Included Libraries/USB_Host_Shield_2.0-master/masstorage.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ADS1298_BLE_Sensor_Interrupt_Driven
   &#160;<span id="projectnumber">ver2.0</span>
   </div>
   <div id="projectbrief">A Sensor node made of the ADS1298 interrupt driven</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">GHID_Framework/Src/Included Libraries/USB_Host_Shield_2.0-master/masstorage.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="masstorage_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (C) 2011 Circuits At Home, LTD. All rights reserved.</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">This software may be distributed and modified under the terms of the GNU</span>
<a name="l00004"></a>00004 <span class="comment">General Public License version 2 (GPL2) as published by the Free Software</span>
<a name="l00005"></a>00005 <span class="comment">Foundation and appearing in the file GPL2.TXT included in the packaging of</span>
<a name="l00006"></a>00006 <span class="comment">this file. Please note that GPL2 Section 2[b] requires that all works based</span>
<a name="l00007"></a>00007 <span class="comment">on this software must also be made publicly available under the terms of</span>
<a name="l00008"></a>00008 <span class="comment">the GPL2 (&quot;Copyleft&quot;).</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment">Contact information</span>
<a name="l00011"></a>00011 <span class="comment">-------------------</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment">Circuits At Home, LTD</span>
<a name="l00014"></a>00014 <span class="comment">Web      :  http://www.circuitsathome.com</span>
<a name="l00015"></a>00015 <span class="comment">e-mail   :  support@circuitsathome.com</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="masstorage_8h.html">masstorage.h</a>&quot;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="keyword">const</span> uint8_t <a class="code" href="class_bulk_only.html#a9e487226408578a2971570bcf7de62fe">BulkOnly::epDataInIndex</a> = 1;
<a name="l00021"></a>00021 <span class="keyword">const</span> uint8_t <a class="code" href="class_bulk_only.html#a8d527bdc285870f3571481a4fd982721">BulkOnly::epDataOutIndex</a> = 2;
<a name="l00022"></a>00022 <span class="keyword">const</span> uint8_t <a class="code" href="class_bulk_only.html#a03cd96b415990821bdce43b4004c85e4">BulkOnly::epInterruptInIndex</a> = 3;
<a name="l00023"></a>00023 
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="comment">// Interface code</span>
<a name="l00027"></a>00027 
<a name="l00029"></a>00029 
<a name="l00036"></a><a class="code" href="class_bulk_only.html#a597193e88b168e96878d383619f1377d">00036</a> uint32_t <a class="code" href="class_bulk_only.html#a597193e88b168e96878d383619f1377d">BulkOnly::GetCapacity</a>(uint8_t lun) {
<a name="l00037"></a>00037         <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun])
<a name="l00038"></a>00038                 <span class="keywordflow">return</span> <a class="code" href="class_bulk_only.html#a73c3f6b8f6f79ad60e5ba05e560b277d">CurrentCapacity</a>[lun];
<a name="l00039"></a>00039         <span class="keywordflow">return</span> 0LU;
<a name="l00040"></a>00040 }
<a name="l00041"></a>00041 
<a name="l00048"></a><a class="code" href="class_bulk_only.html#ac97cfb7558681af4cfaa11fcccc00170">00048</a> uint16_t <a class="code" href="class_bulk_only.html#ac97cfb7558681af4cfaa11fcccc00170">BulkOnly::GetSectorSize</a>(uint8_t lun) {
<a name="l00049"></a>00049         <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun])
<a name="l00050"></a>00050                 <span class="keywordflow">return</span> <a class="code" href="class_bulk_only.html#aa4e2711c6279d48c63e82a63ad458421">CurrentSectorSize</a>[lun];
<a name="l00051"></a>00051         <span class="keywordflow">return</span> 0U;
<a name="l00052"></a>00052 }
<a name="l00053"></a>00053 
<a name="l00060"></a><a class="code" href="class_bulk_only.html#aa6d74267dc98daeb0552fa234739ab08">00060</a> <span class="keywordtype">bool</span> <a class="code" href="class_bulk_only.html#aa6d74267dc98daeb0552fa234739ab08">BulkOnly::LUNIsGood</a>(uint8_t lun) {
<a name="l00061"></a>00061         <span class="keywordflow">return</span> <a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun];
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 
<a name="l00070"></a><a class="code" href="class_bulk_only.html#ab0976e6d4f5fdeff800f3769e7b287c9">00070</a> <span class="keywordtype">boolean</span> <a class="code" href="class_bulk_only.html#ab0976e6d4f5fdeff800f3769e7b287c9">BulkOnly::WriteProtected</a>(uint8_t lun) {
<a name="l00071"></a>00071         <span class="keywordflow">return</span> <a class="code" href="class_bulk_only.html#af763ffffdd131949322d583fb4cd2737">WriteOk</a>[lun];
<a name="l00072"></a>00072 }
<a name="l00073"></a>00073 
<a name="l00083"></a><a class="code" href="class_bulk_only.html#abec80bf6c8306115de66c0f87389bbd3">00083</a> uint8_t <a class="code" href="class_bulk_only.html#abec80bf6c8306115de66c0f87389bbd3">BulkOnly::SCSITransaction6</a>(<a class="code" href="struct_c_d_b6.html">CDB6_t</a> *cdb, uint16_t buf_size, <span class="keywordtype">void</span> *buf, uint8_t dir) {
<a name="l00084"></a>00084         <span class="comment">// promote buf_size to 32bits.</span>
<a name="l00085"></a>00085         <a class="code" href="struct_command_block_wrapper.html">CommandBlockWrapper</a> cbw = <a class="code" href="masstorage_8h.html#a16bd83701afd2cf52d741ab0b6a7e479">CommandBlockWrapper</a>(++<a class="code" href="class_bulk_only.html#a7ae682d50badd1386a06f30f35a32d1d">dCBWTag</a>, (uint32_t)buf_size, cdb, dir);
<a name="l00086"></a>00086         <span class="comment">//SetCurLUN(cdb-&gt;LUN);</span>
<a name="l00087"></a>00087         <span class="keywordflow">return</span> (HandleSCSIError(Transaction(&amp;cbw, buf_size, buf)));
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 
<a name="l00099"></a><a class="code" href="class_bulk_only.html#af07ab48c6b9e6bdb4f0d050adbae518d">00099</a> uint8_t <a class="code" href="class_bulk_only.html#af07ab48c6b9e6bdb4f0d050adbae518d">BulkOnly::SCSITransaction10</a>(<a class="code" href="struct_c_d_b10.html">CDB10_t</a> *cdb, uint16_t buf_size, <span class="keywordtype">void</span> *buf, uint8_t dir) {
<a name="l00100"></a>00100         <span class="comment">// promote buf_size to 32bits.</span>
<a name="l00101"></a>00101         <a class="code" href="struct_command_block_wrapper.html">CommandBlockWrapper</a> cbw = <a class="code" href="masstorage_8h.html#a16bd83701afd2cf52d741ab0b6a7e479">CommandBlockWrapper</a>(++<a class="code" href="class_bulk_only.html#a7ae682d50badd1386a06f30f35a32d1d">dCBWTag</a>, (uint32_t)buf_size, cdb, dir);
<a name="l00102"></a>00102         <span class="comment">//SetCurLUN(cdb-&gt;LUN);</span>
<a name="l00103"></a>00103         <span class="keywordflow">return</span> (HandleSCSIError(Transaction(&amp;cbw, buf_size, buf)));
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00114"></a><a class="code" href="class_bulk_only.html#ae7561d686d0b1374b5f9937d6ec8a035">00114</a> uint8_t <a class="code" href="class_bulk_only.html#ae7561d686d0b1374b5f9937d6ec8a035">BulkOnly::LockMedia</a>(uint8_t lun, uint8_t lock) {
<a name="l00115"></a>00115         Notify(PSTR(<span class="stringliteral">&quot;\r\nLockMedia\r\n&quot;</span>), 0x80);
<a name="l00116"></a>00116         Notify(PSTR(<span class="stringliteral">&quot;---------\r\n&quot;</span>), 0x80);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         <a class="code" href="struct_c_d_b6.html">CDB6_t</a> cdb = <a class="code" href="masstorage_8h.html#a56ab0baf4e98a591274bf8d1acf96d85">CDB6_t</a>(<a class="code" href="masstorage_8h.html#ac6435ab2e468a79816db996b0a16c024">SCSI_CMD_PREVENT_REMOVAL</a>, lun, (uint8_t)0, lock);
<a name="l00119"></a>00119         <span class="keywordflow">return</span> <a class="code" href="class_bulk_only.html#abec80bf6c8306115de66c0f87389bbd3">SCSITransaction6</a>(&amp;cdb, (uint16_t)0, NULL, (uint8_t)<a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>);
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00130"></a><a class="code" href="class_bulk_only.html#a2fc74b11c2ecce30e89f84cc1efe0c81">00130</a> uint8_t <a class="code" href="class_bulk_only.html#a2fc74b11c2ecce30e89f84cc1efe0c81">BulkOnly::MediaCTL</a>(uint8_t lun, uint8_t ctl) {
<a name="l00131"></a>00131         Notify(PSTR(<span class="stringliteral">&quot;\r\nMediaCTL\r\n&quot;</span>), 0x80);
<a name="l00132"></a>00132         Notify(PSTR(<span class="stringliteral">&quot;-----------------\r\n&quot;</span>), 0x80);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134         uint8_t rcode = <a class="code" href="masstorage_8h.html#a128e4910df8d7770c6f9af7700b9ccb1">MASS_ERR_UNIT_NOT_READY</a>;
<a name="l00135"></a>00135         <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>) {
<a name="l00136"></a>00136                 <a class="code" href="struct_c_d_b6.html">CDB6_t</a> cdb = <a class="code" href="masstorage_8h.html#a56ab0baf4e98a591274bf8d1acf96d85">CDB6_t</a>(<a class="code" href="masstorage_8h.html#a17b47e6ce4b10688ac30666c16b14d86">SCSI_CMD_START_STOP_UNIT</a>, lun, ctl &amp; 0x03, 0);
<a name="l00137"></a>00137                 rcode = <a class="code" href="class_bulk_only.html#abec80bf6c8306115de66c0f87389bbd3">SCSITransaction6</a>(&amp;cdb, (uint16_t)0, NULL, (uint8_t)<a class="code" href="masstorage_8h.html#ad74d783991b5eea6ad8ef2feb2ce03ea">MASS_CMD_DIR_OUT</a>);
<a name="l00138"></a>00138         } <span class="keywordflow">else</span> {
<a name="l00139"></a>00139                 SetCurLUN(lun);
<a name="l00140"></a>00140         }
<a name="l00141"></a>00141         <span class="keywordflow">return</span> rcode;
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 
<a name="l00154"></a><a class="code" href="class_bulk_only.html#a470a8f0ffd6694d9dfc834da5efa627a">00154</a> uint8_t <a class="code" href="class_bulk_only.html#a470a8f0ffd6694d9dfc834da5efa627a">BulkOnly::Read</a>(uint8_t lun, uint32_t addr, uint16_t bsize, uint8_t blocks, uint8_t *buf) {
<a name="l00155"></a>00155         <span class="keywordflow">if</span>(!<a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun]) <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#aec47def0928045fdca474d78db866c39">MASS_ERR_NO_MEDIA</a>;
<a name="l00156"></a>00156         Notify(PSTR(<span class="stringliteral">&quot;\r\nRead LUN:\t&quot;</span>), 0x80);
<a name="l00157"></a>00157         D_PrintHex&lt;uint8_t &gt; (lun, 0x90);
<a name="l00158"></a>00158         Notify(PSTR(<span class="stringliteral">&quot;\r\nLBA:\t\t&quot;</span>), 0x90);
<a name="l00159"></a>00159         D_PrintHex&lt;uint32_t &gt; (addr, 0x90);
<a name="l00160"></a>00160         Notify(PSTR(<span class="stringliteral">&quot;\r\nblocks:\t\t&quot;</span>), 0x90);
<a name="l00161"></a>00161         D_PrintHex&lt;uint8_t &gt; (blocks, 0x90);
<a name="l00162"></a>00162         Notify(PSTR(<span class="stringliteral">&quot;\r\nblock size:\t&quot;</span>), 0x90);
<a name="l00163"></a>00163         D_PrintHex&lt;uint16_t &gt; (bsize, 0x90);
<a name="l00164"></a>00164         Notify(PSTR(<span class="stringliteral">&quot;\r\n---------\r\n&quot;</span>), 0x80);
<a name="l00165"></a>00165         <a class="code" href="struct_c_d_b10.html">CDB10_t</a> cdb = <a class="code" href="masstorage_8h.html#af952fd9270407996656ba95772511002">CDB10_t</a>(<a class="code" href="masstorage_8h.html#ad3900f141fb70afb8def054384805a2e">SCSI_CMD_READ_10</a>, lun, blocks, addr);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 again:
<a name="l00168"></a>00168         uint8_t er = <a class="code" href="class_bulk_only.html#af07ab48c6b9e6bdb4f0d050adbae518d">SCSITransaction10</a>(&amp;cdb, ((uint16_t)bsize * blocks), buf, (uint8_t)<a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <span class="keywordflow">if</span>(er == <a class="code" href="masstorage_8h.html#a13aee9eab965d570a4a00463cd20ca29">MASS_ERR_STALL</a>) {
<a name="l00171"></a>00171                 <a class="code" href="class_bulk_only.html#a2fc74b11c2ecce30e89f84cc1efe0c81">MediaCTL</a>(lun, 1);
<a name="l00172"></a>00172                 delay(150);
<a name="l00173"></a>00173                 <span class="keywordflow">if</span>(!TestUnitReady(lun)) <span class="keywordflow">goto</span> again;
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175         <span class="keywordflow">return</span> er;
<a name="l00176"></a>00176 }
<a name="l00177"></a>00177 
<a name="l00188"></a><a class="code" href="class_bulk_only.html#a45d327ddf87e01607c3a5b1849936053">00188</a> uint8_t <a class="code" href="class_bulk_only.html#a45d327ddf87e01607c3a5b1849936053">BulkOnly::Write</a>(uint8_t lun, uint32_t addr, uint16_t bsize, uint8_t blocks, <span class="keyword">const</span> uint8_t * buf) {
<a name="l00189"></a>00189         <span class="keywordflow">if</span>(!<a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun]) <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#aec47def0928045fdca474d78db866c39">MASS_ERR_NO_MEDIA</a>;
<a name="l00190"></a>00190         <span class="keywordflow">if</span>(!<a class="code" href="class_bulk_only.html#af763ffffdd131949322d583fb4cd2737">WriteOk</a>[lun]) <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#ac8c588cb96077b615de2bd53f77d4c15">MASS_ERR_WRITE_PROTECTED</a>;
<a name="l00191"></a>00191         Notify(PSTR(<span class="stringliteral">&quot;\r\nWrite LUN:\t&quot;</span>), 0x80);
<a name="l00192"></a>00192         D_PrintHex&lt;uint8_t &gt; (lun, 0x90);
<a name="l00193"></a>00193         Notify(PSTR(<span class="stringliteral">&quot;\r\nLBA:\t\t&quot;</span>), 0x90);
<a name="l00194"></a>00194         D_PrintHex&lt;uint32_t &gt; (addr, 0x90);
<a name="l00195"></a>00195         Notify(PSTR(<span class="stringliteral">&quot;\r\nblocks:\t\t&quot;</span>), 0x90);
<a name="l00196"></a>00196         D_PrintHex&lt;uint8_t &gt; (blocks, 0x90);
<a name="l00197"></a>00197         Notify(PSTR(<span class="stringliteral">&quot;\r\nblock size:\t&quot;</span>), 0x90);
<a name="l00198"></a>00198         D_PrintHex&lt;uint16_t &gt; (bsize, 0x90);
<a name="l00199"></a>00199         Notify(PSTR(<span class="stringliteral">&quot;\r\n---------\r\n&quot;</span>), 0x80);
<a name="l00200"></a>00200         <a class="code" href="struct_c_d_b10.html">CDB10_t</a> cdb = <a class="code" href="masstorage_8h.html#af952fd9270407996656ba95772511002">CDB10_t</a>(<a class="code" href="masstorage_8h.html#ad1733ce8730cdaab39b9b868b73128a0">SCSI_CMD_WRITE_10</a>, lun, blocks, addr);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 again:
<a name="l00203"></a>00203         uint8_t er = <a class="code" href="class_bulk_only.html#af07ab48c6b9e6bdb4f0d050adbae518d">SCSITransaction10</a>(&amp;cdb, ((uint16_t)bsize * blocks), (<span class="keywordtype">void</span>*)buf, (uint8_t)<a class="code" href="masstorage_8h.html#ad74d783991b5eea6ad8ef2feb2ce03ea">MASS_CMD_DIR_OUT</a>);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         <span class="keywordflow">if</span>(er == <a class="code" href="masstorage_8h.html#a1b4efb4cfc2b0d4a912abe587a145b84">MASS_ERR_WRITE_STALL</a>) {
<a name="l00206"></a>00206                 <a class="code" href="class_bulk_only.html#a2fc74b11c2ecce30e89f84cc1efe0c81">MediaCTL</a>(lun, 1);
<a name="l00207"></a>00207                 delay(150);
<a name="l00208"></a>00208                 <span class="keywordflow">if</span>(!TestUnitReady(lun)) <span class="keywordflow">goto</span> again;
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210         <span class="keywordflow">return</span> er;
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment">// End of user functions, the remaining code below is driver internals.</span>
<a name="l00214"></a>00214 <span class="comment">// Only developer serviceable parts below!</span>
<a name="l00215"></a>00215 
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="comment">// Main driver code</span>
<a name="l00219"></a>00219 
<a name="l00221"></a>00221 
<a name="l00222"></a><a class="code" href="class_bulk_only.html#a530fb250b0a0c92b48bc57e2957ace25">00222</a> <a class="code" href="class_bulk_only.html#a530fb250b0a0c92b48bc57e2957ace25">BulkOnly::BulkOnly</a>(USB *p) :
<a name="l00223"></a>00223 pUsb(p),
<a name="l00224"></a>00224 bAddress(0),
<a name="l00225"></a>00225 bIface(0),
<a name="l00226"></a>00226 bNumEP(1),
<a name="l00227"></a>00227 qNextPollTime(0),
<a name="l00228"></a>00228 bPollEnable(false),
<a name="l00229"></a>00229 <span class="comment">//dCBWTag(0),</span>
<a name="l00230"></a>00230 bLastUsbError(0) {
<a name="l00231"></a>00231         ClearAllEP();
<a name="l00232"></a>00232         <a class="code" href="class_bulk_only.html#a7ae682d50badd1386a06f30f35a32d1d">dCBWTag</a> = 0;
<a name="l00233"></a>00233         <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>)
<a name="l00234"></a>00234                 <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;RegisterDeviceClass(<span class="keyword">this</span>);
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00251"></a><a class="code" href="class_bulk_only.html#aa8fe167a7af12dce9964fa5a430c53ea">00251</a> uint8_t <a class="code" href="class_bulk_only.html#aa8fe167a7af12dce9964fa5a430c53ea">BulkOnly::ConfigureDevice</a>(uint8_t parent, uint8_t port, <span class="keywordtype">bool</span> lowspeed) {
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         <span class="keyword">const</span> uint8_t constBufSize = <span class="keyword">sizeof</span> (USB_DEVICE_DESCRIPTOR);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         uint8_t buf[constBufSize];
<a name="l00256"></a>00256         USB_DEVICE_DESCRIPTOR * udd = <span class="keyword">reinterpret_cast&lt;</span>USB_DEVICE_DESCRIPTOR*<span class="keyword">&gt;</span>(buf);
<a name="l00257"></a>00257         uint8_t rcode;
<a name="l00258"></a>00258         UsbDevice *p = NULL;
<a name="l00259"></a>00259         EpInfo *oldep_ptr = NULL;
<a name="l00260"></a>00260         USBTRACE(<span class="stringliteral">&quot;MS ConfigureDevice\r\n&quot;</span>);
<a name="l00261"></a>00261         ClearAllEP();
<a name="l00262"></a>00262         AddressPool &amp;addrPool = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;GetAddressPool();
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>)
<a name="l00266"></a>00266                 <span class="keywordflow">return</span> USB_ERROR_CLASS_INSTANCE_ALREADY_IN_USE;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         <span class="comment">// &lt;TECHNICAL&gt;</span>
<a name="l00269"></a>00269         <span class="comment">// Get pointer to pseudo device with address 0 assigned</span>
<a name="l00270"></a>00270         p = addrPool.GetUsbDevicePtr(0);
<a name="l00271"></a>00271         <span class="keywordflow">if</span>(!p) {
<a name="l00272"></a>00272                 <span class="keywordflow">return</span> USB_ERROR_ADDRESS_NOT_FOUND_IN_POOL;
<a name="l00273"></a>00273         }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="keywordflow">if</span>(!p-&gt;epinfo) {
<a name="l00276"></a>00276                 USBTRACE(<span class="stringliteral">&quot;epinfo\r\n&quot;</span>);
<a name="l00277"></a>00277                 <span class="keywordflow">return</span> USB_ERROR_EPINFO_IS_NULL;
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <span class="comment">// Save old pointer to EP_RECORD of address 0</span>
<a name="l00281"></a>00281         oldep_ptr = p-&gt;epinfo;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         <span class="comment">// Temporary assign new pointer to epInfo to p-&gt;epinfo in order to avoid toggle inconsistence</span>
<a name="l00284"></a>00284         p-&gt;epinfo = <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286         p-&gt;lowspeed = lowspeed;
<a name="l00287"></a>00287         <span class="comment">// Get device descriptor</span>
<a name="l00288"></a>00288         rcode = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;getDevDescr(0, 0, constBufSize, (uint8_t*)buf);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290         <span class="comment">// Restore p-&gt;epinfo</span>
<a name="l00291"></a>00291         p-&gt;epinfo = oldep_ptr;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <span class="keywordflow">if</span>(rcode) {
<a name="l00294"></a>00294                 <span class="keywordflow">goto</span> FailGetDevDescr;
<a name="l00295"></a>00295         }
<a name="l00296"></a>00296         <span class="comment">// Allocate new address according to device class</span>
<a name="l00297"></a>00297         <a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a> = addrPool.AllocAddress(parent, <span class="keyword">false</span>, port);
<a name="l00298"></a>00298 
<a name="l00299"></a>00299         <span class="keywordflow">if</span>(!<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>)
<a name="l00300"></a>00300                 <span class="keywordflow">return</span> USB_ERROR_OUT_OF_ADDRESS_SPACE_IN_POOL;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302         <span class="comment">// Extract Max Packet Size from the device descriptor</span>
<a name="l00303"></a>00303         <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[0].maxPktSize = udd-&gt;bMaxPacketSize0;
<a name="l00304"></a>00304         <span class="comment">// Steal and abuse from epInfo structure to save on memory.</span>
<a name="l00305"></a>00305         <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[1].epAddr = udd-&gt;bNumConfigurations;
<a name="l00306"></a>00306         <span class="comment">// &lt;/TECHNICAL&gt;</span>
<a name="l00307"></a>00307         <span class="keywordflow">return</span> USB_ERROR_CONFIG_REQUIRES_ADDITIONAL_RESET;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 FailGetDevDescr:
<a name="l00310"></a>00310 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span>        NotifyFailGetDevDescr(rcode);
<a name="l00312"></a>00312 <span class="preprocessor">#endif</span>
<a name="l00313"></a>00313 <span class="preprocessor"></span>        rcode = USB_ERROR_FailGetDevDescr;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <a class="code" href="class_bulk_only.html#a8a9b213d1800db2d8e661d242b57b195">Release</a>();
<a name="l00316"></a>00316         <span class="keywordflow">return</span> rcode;
<a name="l00317"></a>00317 };
<a name="l00318"></a>00318 
<a name="l00326"></a><a class="code" href="class_bulk_only.html#a51870da9badc037166b86da60bcda6ea">00326</a> uint8_t <a class="code" href="class_bulk_only.html#a51870da9badc037166b86da60bcda6ea">BulkOnly::Init</a>(uint8_t parent, uint8_t port, <span class="keywordtype">bool</span> lowspeed) {
<a name="l00327"></a>00327         uint8_t rcode;
<a name="l00328"></a>00328         uint8_t num_of_conf = <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[1].epAddr; <span class="comment">// number of configurations</span>
<a name="l00329"></a>00329         <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[1].epAddr = 0;
<a name="l00330"></a>00330         USBTRACE(<span class="stringliteral">&quot;MS Init\r\n&quot;</span>);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         AddressPool &amp;addrPool = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;GetAddressPool();
<a name="l00333"></a>00333         UsbDevice *p = addrPool.GetUsbDevicePtr(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335         <span class="keywordflow">if</span>(!p)
<a name="l00336"></a>00336                 <span class="keywordflow">return</span> USB_ERROR_ADDRESS_NOT_FOUND_IN_POOL;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338         <span class="comment">// Assign new address to the device</span>
<a name="l00339"></a>00339         delay(2000);
<a name="l00340"></a>00340         rcode = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;setAddr(0, 0, <a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>);
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <span class="keywordflow">if</span>(rcode) {
<a name="l00343"></a>00343                 p-&gt;lowspeed = <span class="keyword">false</span>;
<a name="l00344"></a>00344                 addrPool.FreeAddress(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>);
<a name="l00345"></a>00345                 <a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a> = 0;
<a name="l00346"></a>00346                 USBTRACE2(<span class="stringliteral">&quot;setAddr:&quot;</span>, rcode);
<a name="l00347"></a>00347                 <span class="keywordflow">return</span> rcode;
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350         USBTRACE2(<span class="stringliteral">&quot;Addr:&quot;</span>, <a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         p-&gt;lowspeed = <span class="keyword">false</span>;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         p = addrPool.GetUsbDevicePtr(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         <span class="keywordflow">if</span>(!p)
<a name="l00357"></a>00357                 <span class="keywordflow">return</span> USB_ERROR_ADDRESS_NOT_FOUND_IN_POOL;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         p-&gt;lowspeed = lowspeed;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         <span class="comment">// Assign epInfo to epinfo pointer</span>
<a name="l00362"></a>00362         rcode = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;setEpInfoEntry(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, 1, <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>);
<a name="l00363"></a>00363 
<a name="l00364"></a>00364         <span class="keywordflow">if</span>(rcode)
<a name="l00365"></a>00365                 <span class="keywordflow">goto</span> FailSetDevTblEntry;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367         USBTRACE2(<span class="stringliteral">&quot;NC:&quot;</span>, num_of_conf);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         <span class="keywordflow">for</span>(uint8_t i = 0; i &lt; num_of_conf; i++) {
<a name="l00370"></a>00370                 ConfigDescParser&lt; USB_CLASS_MASS_STORAGE,
<a name="l00371"></a>00371                         <a class="code" href="masstorage_8h.html#aaf635eb9151eb63855fe227584bb00eb">MASS_SUBCLASS_SCSI</a>,
<a name="l00372"></a>00372                         <a class="code" href="masstorage_8h.html#a17a026f7d64e8daf27b45c295755fdf0">MASS_PROTO_BBB</a>,
<a name="l00373"></a>00373                         CP_MASK_COMPARE_CLASS |
<a name="l00374"></a>00374                         CP_MASK_COMPARE_SUBCLASS |
<a name="l00375"></a>00375                         CP_MASK_COMPARE_PROTOCOL &gt; BulkOnlyParser(<span class="keyword">this</span>);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377                 rcode = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;getConfDescr(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, 0, i, &amp;BulkOnlyParser);
<a name="l00378"></a>00378 
<a name="l00379"></a>00379                 <span class="keywordflow">if</span>(rcode)
<a name="l00380"></a>00380                         <span class="keywordflow">goto</span> FailGetConfDescr;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382                 <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a6cb56ebd0307845321340919e2b35952">bNumEP</a> &gt; 1)
<a name="l00383"></a>00383                         <span class="keywordflow">break</span>;
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a6cb56ebd0307845321340919e2b35952">bNumEP</a> &lt; 3)
<a name="l00387"></a>00387                 <span class="keywordflow">return</span> USB_DEV_CONFIG_ERROR_DEVICE_NOT_SUPPORTED;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389         <span class="comment">// Assign epInfo to epinfo pointer</span>
<a name="l00390"></a>00390         <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;setEpInfoEntry(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, <a class="code" href="class_bulk_only.html#a6cb56ebd0307845321340919e2b35952">bNumEP</a>, <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>);
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         USBTRACE2(<span class="stringliteral">&quot;Conf:&quot;</span>, <a class="code" href="class_bulk_only.html#ab54f472ec9cd39abdb9f90867943d162">bConfNum</a>);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394         <span class="comment">// Set Configuration Value</span>
<a name="l00395"></a>00395         rcode = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;setConf(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, 0, <a class="code" href="class_bulk_only.html#ab54f472ec9cd39abdb9f90867943d162">bConfNum</a>);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         <span class="keywordflow">if</span>(rcode)
<a name="l00398"></a>00398                 <span class="keywordflow">goto</span> FailSetConfDescr;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400         <span class="comment">//Linux does a 1sec delay after this.</span>
<a name="l00401"></a>00401         delay(1000);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403         rcode = GetMaxLUN(&amp;<a class="code" href="class_bulk_only.html#a6bbdd41bf6efc4060f3c36da7d6ed8b2">bMaxLUN</a>);
<a name="l00404"></a>00404         <span class="keywordflow">if</span>(rcode)
<a name="l00405"></a>00405                 <span class="keywordflow">goto</span> FailGetMaxLUN;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407         <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a6bbdd41bf6efc4060f3c36da7d6ed8b2">bMaxLUN</a> &gt;= MASS_MAX_SUPPORTED_LUN) <a class="code" href="class_bulk_only.html#a6bbdd41bf6efc4060f3c36da7d6ed8b2">bMaxLUN</a> = MASS_MAX_SUPPORTED_LUN - 1;
<a name="l00408"></a>00408         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;MaxLUN&quot;</span>), <a class="code" href="class_bulk_only.html#a6bbdd41bf6efc4060f3c36da7d6ed8b2">bMaxLUN</a>);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         delay(1000); <span class="comment">// Delay a bit for slow firmware.</span>
<a name="l00411"></a>00411 
<a name="l00412"></a>00412         <span class="keywordflow">for</span>(uint8_t lun = 0; lun &lt;= <a class="code" href="class_bulk_only.html#a6bbdd41bf6efc4060f3c36da7d6ed8b2">bMaxLUN</a>; lun++) {
<a name="l00413"></a>00413                 <a class="code" href="struct_inquiry_response.html">InquiryResponse</a> response;
<a name="l00414"></a>00414                 rcode = Inquiry(lun, <span class="keyword">sizeof</span> (<a class="code" href="struct_inquiry_response.html">InquiryResponse</a>), (uint8_t*) &amp; response);
<a name="l00415"></a>00415                 <span class="keywordflow">if</span>(rcode) {
<a name="l00416"></a>00416                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Inquiry&quot;</span>), rcode);
<a name="l00417"></a>00417                 } <span class="keywordflow">else</span> {
<a name="l00418"></a>00418 <span class="preprocessor">#if 0</span>
<a name="l00419"></a>00419 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;LUN %i `&quot;</span>, lun);
<a name="l00420"></a>00420                         uint8_t *buf = response.VendorID;
<a name="l00421"></a>00421                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; 28; i++) printf(<span class="stringliteral">&quot;%c&quot;</span>, buf[i]);
<a name="l00422"></a>00422                         printf(<span class="stringliteral">&quot;&#39;\r\nQualifier %1.1X &quot;</span>, response.PeripheralQualifier);
<a name="l00423"></a>00423                         printf(<span class="stringliteral">&quot;Device type %2.2X &quot;</span>, response.DeviceType);
<a name="l00424"></a>00424                         printf(<span class="stringliteral">&quot;RMB %1.1X &quot;</span>, response.Removable);
<a name="l00425"></a>00425                         printf(<span class="stringliteral">&quot;SSCS %1.1X &quot;</span>, response.SCCS);
<a name="l00426"></a>00426                         uint8_t sv = response.Version;
<a name="l00427"></a>00427                         printf(<span class="stringliteral">&quot;SCSI version %2.2X\r\nDevice conforms to &quot;</span>, sv);
<a name="l00428"></a>00428                         <span class="keywordflow">switch</span>(sv) {
<a name="l00429"></a>00429                                 <span class="keywordflow">case</span> 0:
<a name="l00430"></a>00430                                         printf(<span class="stringliteral">&quot;No specific&quot;</span>);
<a name="l00431"></a>00431                                         <span class="keywordflow">break</span>;
<a name="l00432"></a>00432                                 <span class="keywordflow">case</span> 1:
<a name="l00433"></a>00433                                         printf(<span class="stringliteral">&quot;ANSI X3.131-1986 (ANSI 1)&quot;</span>);
<a name="l00434"></a>00434                                         <span class="keywordflow">break</span>;
<a name="l00435"></a>00435                                 <span class="keywordflow">case</span> 2:
<a name="l00436"></a>00436                                         printf(<span class="stringliteral">&quot;ANSI X3.131-1994 (ANSI 2)&quot;</span>);
<a name="l00437"></a>00437                                         <span class="keywordflow">break</span>;
<a name="l00438"></a>00438                                 <span class="keywordflow">case</span> 3:
<a name="l00439"></a>00439                                         printf(<span class="stringliteral">&quot;ANSI INCITS 301-1997 (SPC)&quot;</span>);
<a name="l00440"></a>00440                                         <span class="keywordflow">break</span>;
<a name="l00441"></a>00441                                 <span class="keywordflow">case</span> 4:
<a name="l00442"></a>00442                                         printf(<span class="stringliteral">&quot;ANSI INCITS 351-2001 (SPC-2)&quot;</span>);
<a name="l00443"></a>00443                                         <span class="keywordflow">break</span>;
<a name="l00444"></a>00444                                 <span class="keywordflow">case</span> 5:
<a name="l00445"></a>00445                                         printf(<span class="stringliteral">&quot;ANSI INCITS 408-2005 (SPC-4)&quot;</span>);
<a name="l00446"></a>00446                                         <span class="keywordflow">break</span>;
<a name="l00447"></a>00447                                 <span class="keywordflow">case</span> 6:
<a name="l00448"></a>00448                                         printf(<span class="stringliteral">&quot;T10/1731-D (SPC-4)&quot;</span>);
<a name="l00449"></a>00449                                         <span class="keywordflow">break</span>;
<a name="l00450"></a>00450                                 <span class="keywordflow">default</span>:
<a name="l00451"></a>00451                                         printf(<span class="stringliteral">&quot;unknown&quot;</span>);
<a name="l00452"></a>00452                         }
<a name="l00453"></a>00453                         printf(<span class="stringliteral">&quot; standards.\r\n&quot;</span>);
<a name="l00454"></a>00454 <span class="preprocessor">#endif</span>
<a name="l00455"></a>00455 <span class="preprocessor"></span>                        uint8_t tries = 0xf0;
<a name="l00456"></a>00456                         <span class="keywordflow">while</span>((rcode = TestUnitReady(lun))) {
<a name="l00457"></a>00457                                 <span class="keywordflow">if</span>(rcode == 0x08) <span class="keywordflow">break</span>; <span class="comment">// break on no media, this is OK to do.</span>
<a name="l00458"></a>00458                                 <span class="comment">// try to lock media and spin up</span>
<a name="l00459"></a>00459                                 <span class="keywordflow">if</span>(tries &lt; 14) {
<a name="l00460"></a>00460                                         <a class="code" href="class_bulk_only.html#ae7561d686d0b1374b5f9937d6ec8a035">LockMedia</a>(lun, 1);
<a name="l00461"></a>00461                                         <a class="code" href="class_bulk_only.html#a2fc74b11c2ecce30e89f84cc1efe0c81">MediaCTL</a>(lun, 1); <span class="comment">// I actually have a USB stick that needs this!</span>
<a name="l00462"></a>00462                                 } <span class="keywordflow">else</span> delay(2 * (tries + 1));
<a name="l00463"></a>00463                                 tries++;
<a name="l00464"></a>00464                                 <span class="keywordflow">if</span>(!tries) <span class="keywordflow">break</span>;
<a name="l00465"></a>00465                         }
<a name="l00466"></a>00466                         <span class="keywordflow">if</span>(!rcode) {
<a name="l00467"></a>00467                                 delay(1000);
<a name="l00468"></a>00468                                 <a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun] = CheckLUN(lun);
<a name="l00469"></a>00469                                 <span class="keywordflow">if</span>(!<a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun]) <a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun] = CheckLUN(lun);
<a name="l00470"></a>00470                         }
<a name="l00471"></a>00471                 }
<a name="l00472"></a>00472         }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 
<a name="l00475"></a>00475         CheckMedia();
<a name="l00476"></a>00476 
<a name="l00477"></a>00477         rcode = <a class="code" href="class_bulk_only.html#a3d253a0bc8f1ac5b7fe1c9e7078691e3">OnInit</a>();
<a name="l00478"></a>00478 
<a name="l00479"></a>00479         <span class="keywordflow">if</span>(rcode)
<a name="l00480"></a>00480                 <span class="keywordflow">goto</span> FailOnInit;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span>        USBTRACE(<span class="stringliteral">&quot;MS configured\r\n\r\n&quot;</span>);
<a name="l00484"></a>00484 <span class="preprocessor">#endif</span>
<a name="l00485"></a>00485 <span class="preprocessor"></span>
<a name="l00486"></a>00486         <a class="code" href="class_bulk_only.html#a21961ad1130480f534ef3e91f24c56a0">bPollEnable</a> = <span class="keyword">true</span>;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488         <span class="comment">//USBTRACE(&quot;Poll enabled\r\n&quot;);</span>
<a name="l00489"></a>00489         <span class="keywordflow">return</span> 0;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 FailSetConfDescr:
<a name="l00492"></a>00492 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span>        NotifyFailSetConfDescr();
<a name="l00494"></a>00494         <span class="keywordflow">goto</span> Fail;
<a name="l00495"></a>00495 <span class="preprocessor">#endif</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span>
<a name="l00497"></a>00497 FailOnInit:
<a name="l00498"></a>00498 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00499"></a>00499 <span class="preprocessor"></span>        USBTRACE(<span class="stringliteral">&quot;OnInit:&quot;</span>);
<a name="l00500"></a>00500         <span class="keywordflow">goto</span> Fail;
<a name="l00501"></a>00501 <span class="preprocessor">#endif</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span>
<a name="l00503"></a>00503 FailGetMaxLUN:
<a name="l00504"></a>00504 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00505"></a>00505 <span class="preprocessor"></span>        USBTRACE(<span class="stringliteral">&quot;GetMaxLUN:&quot;</span>);
<a name="l00506"></a>00506         <span class="keywordflow">goto</span> Fail;
<a name="l00507"></a>00507 <span class="preprocessor">#endif</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span>
<a name="l00509"></a>00509         <span class="comment">//#ifdef DEBUG_USB_HOST</span>
<a name="l00510"></a>00510         <span class="comment">//FailInvalidSectorSize:</span>
<a name="l00511"></a>00511         <span class="comment">//        USBTRACE(&quot;Sector Size is NOT VALID: &quot;);</span>
<a name="l00512"></a>00512         <span class="comment">//        goto Fail;</span>
<a name="l00513"></a>00513         <span class="comment">//#endif</span>
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 FailSetDevTblEntry:
<a name="l00516"></a>00516 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span>        NotifyFailSetDevTblEntry();
<a name="l00518"></a>00518         <span class="keywordflow">goto</span> Fail;
<a name="l00519"></a>00519 <span class="preprocessor">#endif</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span>
<a name="l00521"></a>00521 FailGetConfDescr:
<a name="l00522"></a>00522 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span>        NotifyFailGetConfDescr();
<a name="l00524"></a>00524 <span class="preprocessor">#endif</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span>
<a name="l00526"></a>00526 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00527"></a>00527 <span class="preprocessor"></span>Fail:
<a name="l00528"></a>00528         NotifyFail(rcode);
<a name="l00529"></a>00529 <span class="preprocessor">#endif</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span>        <a class="code" href="class_bulk_only.html#a8a9b213d1800db2d8e661d242b57b195">Release</a>();
<a name="l00531"></a>00531         <span class="keywordflow">return</span> rcode;
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 
<a name="l00543"></a><a class="code" href="class_bulk_only.html#a13d33906543d5d6b44620f430dc729ff">00543</a> <span class="keywordtype">void</span> <a class="code" href="class_bulk_only.html#a13d33906543d5d6b44620f430dc729ff">BulkOnly::EndpointXtract</a>(uint8_t conf, uint8_t iface, uint8_t alt, uint8_t proto, <span class="keyword">const</span> USB_ENDPOINT_DESCRIPTOR * pep) {
<a name="l00544"></a>00544         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Conf.Val&quot;</span>), conf);
<a name="l00545"></a>00545         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Iface Num&quot;</span>), iface);
<a name="l00546"></a>00546         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Alt.Set&quot;</span>), alt);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548         <a class="code" href="class_bulk_only.html#ab54f472ec9cd39abdb9f90867943d162">bConfNum</a> = conf;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550         uint8_t index;
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         <span class="keywordflow">if</span>((pep-&gt;bmAttributes &amp; 0x03) == 3 &amp;&amp; (pep-&gt;bEndpointAddress &amp; 0x80) == 0x80)
<a name="l00553"></a>00553                 index = <a class="code" href="class_bulk_only.html#a03cd96b415990821bdce43b4004c85e4">epInterruptInIndex</a>;
<a name="l00554"></a>00554         <span class="keywordflow">else</span>
<a name="l00555"></a>00555                 <span class="keywordflow">if</span>((pep-&gt;bmAttributes &amp; 0x02) == 2)
<a name="l00556"></a>00556                 index = ((pep-&gt;bEndpointAddress &amp; 0x80) == 0x80) ? <a class="code" href="class_bulk_only.html#a9e487226408578a2971570bcf7de62fe">epDataInIndex</a> : <a class="code" href="class_bulk_only.html#a8d527bdc285870f3571481a4fd982721">epDataOutIndex</a>;
<a name="l00557"></a>00557         <span class="keywordflow">else</span>
<a name="l00558"></a>00558                 <span class="keywordflow">return</span>;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="comment">// Fill in the endpoint info structure</span>
<a name="l00561"></a>00561         <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[index].epAddr = (pep-&gt;bEndpointAddress &amp; 0x0F);
<a name="l00562"></a>00562         <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[index].maxPktSize = (uint8_t)pep-&gt;wMaxPacketSize;
<a name="l00563"></a>00563         <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[index].epAttribs = 0;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565         <a class="code" href="class_bulk_only.html#a6cb56ebd0307845321340919e2b35952">bNumEP</a>++;
<a name="l00566"></a>00566 
<a name="l00567"></a>00567         <a class="code" href="class_bulk_only.html#ac8a1d7b2ef82d9f6da44928c78039964">PrintEndpointDescriptor</a>(pep);
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 
<a name="l00575"></a><a class="code" href="class_bulk_only.html#a8a9b213d1800db2d8e661d242b57b195">00575</a> uint8_t <a class="code" href="class_bulk_only.html#a8a9b213d1800db2d8e661d242b57b195">BulkOnly::Release</a>() {
<a name="l00576"></a>00576         ClearAllEP();
<a name="l00577"></a>00577         <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;GetAddressPool().FreeAddress(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>);
<a name="l00578"></a>00578         <span class="keywordflow">return</span> 0;
<a name="l00579"></a>00579 }
<a name="l00580"></a>00580 
<a name="l00587"></a>00587 <span class="keywordtype">boolean</span> BulkOnly::CheckLUN(uint8_t lun) {
<a name="l00588"></a>00588         uint8_t rcode;
<a name="l00589"></a>00589         <a class="code" href="struct_capacity.html">Capacity</a> capacity;
<a name="l00590"></a>00590         <span class="keywordflow">for</span>(uint8_t i = 0; i &lt; 8; i++) capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[i] = 0;
<a name="l00591"></a>00591 
<a name="l00592"></a>00592         rcode = ReadCapacity10(lun, (uint8_t*)capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>);
<a name="l00593"></a>00593         <span class="keywordflow">if</span>(rcode) {
<a name="l00594"></a>00594                 <span class="comment">//printf(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ReadCapacity returned %i\r\n&quot;, rcode);</span>
<a name="l00595"></a>00595                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;CAPACITY OK ON LUN&quot;</span>), lun);
<a name="l00598"></a>00598         <span class="keywordflow">for</span>(uint8_t i = 0; i &lt; 8 <span class="comment">/*sizeof (Capacity)*/</span>; i++)
<a name="l00599"></a>00599                 D_PrintHex&lt;uint8_t &gt; (capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[i], 0x80);
<a name="l00600"></a>00600         Notify(PSTR(<span class="stringliteral">&quot;\r\n\r\n&quot;</span>), 0x80);
<a name="l00601"></a>00601         <span class="comment">// Only 512/1024/2048/4096 are valid values!</span>
<a name="l00602"></a>00602         uint32_t c = BMAKE32(capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[4], capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[5], capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[6], capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[7]);
<a name="l00603"></a>00603         <span class="keywordflow">if</span>(c != 0x0200LU &amp;&amp; c != 0x0400LU &amp;&amp; c != 0x0800LU &amp;&amp; c != 0x1000LU) {
<a name="l00604"></a>00604                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606         <span class="comment">// Store capacity information.</span>
<a name="l00607"></a>00607         <a class="code" href="class_bulk_only.html#aa4e2711c6279d48c63e82a63ad458421">CurrentSectorSize</a>[lun] = (uint16_t)(c); <span class="comment">// &amp; 0xFFFF);</span>
<a name="l00608"></a>00608 
<a name="l00609"></a>00609         <a class="code" href="class_bulk_only.html#a73c3f6b8f6f79ad60e5ba05e560b277d">CurrentCapacity</a>[lun] = BMAKE32(capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[0], capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[1], capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[2], capacity.<a class="code" href="struct_capacity.html#ae6dd521cd2ece3d6fa6fe58180fb9e8a">data</a>[3]) + 1;
<a name="l00610"></a>00610         <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a73c3f6b8f6f79ad60e5ba05e560b277d">CurrentCapacity</a>[lun] == <span class="comment">/*0xffffffffLU */</span> 0x01LU || <a class="code" href="class_bulk_only.html#a73c3f6b8f6f79ad60e5ba05e560b277d">CurrentCapacity</a>[lun] == 0x00LU) {
<a name="l00611"></a>00611                 <span class="comment">// Buggy firmware will report 0xffffffff or 0 for no media</span>
<a name="l00612"></a>00612                 <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a73c3f6b8f6f79ad60e5ba05e560b277d">CurrentCapacity</a>[lun])
<a name="l00613"></a>00613                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;BUGGY FIRMWARE. CAPACITY FAIL ON LUN&quot;</span>), lun);
<a name="l00614"></a>00614                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616         delay(20);
<a name="l00617"></a>00617         Page3F(lun);
<a name="l00618"></a>00618         <span class="keywordflow">if</span>(!TestUnitReady(lun)) <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00619"></a>00619         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00620"></a>00620 }
<a name="l00621"></a>00621 
<a name="l00627"></a>00627 <span class="keywordtype">void</span> BulkOnly::CheckMedia() {
<a name="l00628"></a>00628         <span class="keywordflow">for</span>(uint8_t lun = 0; lun &lt;= <a class="code" href="class_bulk_only.html#a6bbdd41bf6efc4060f3c36da7d6ed8b2">bMaxLUN</a>; lun++) {
<a name="l00629"></a>00629                 <span class="keywordflow">if</span>(TestUnitReady(lun)) {
<a name="l00630"></a>00630                         <a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun] = <span class="keyword">false</span>;
<a name="l00631"></a>00631                         <span class="keywordflow">continue</span>;
<a name="l00632"></a>00632                 }
<a name="l00633"></a>00633                 <span class="keywordflow">if</span>(!<a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun])
<a name="l00634"></a>00634                         <a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun] = CheckLUN(lun);
<a name="l00635"></a>00635         }
<a name="l00636"></a>00636 <span class="preprocessor">#if 0</span>
<a name="l00637"></a>00637 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;}}}}}}}}}}}}}}}}STATUS &quot;</span>);
<a name="l00638"></a>00638         <span class="keywordflow">for</span>(uint8_t lun = 0; lun &lt;= <a class="code" href="class_bulk_only.html#a6bbdd41bf6efc4060f3c36da7d6ed8b2">bMaxLUN</a>; lun++) {
<a name="l00639"></a>00639                 <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun])
<a name="l00640"></a>00640                         printf(<span class="stringliteral">&quot;#&quot;</span>);
<a name="l00641"></a>00641                 <span class="keywordflow">else</span> printf(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00642"></a>00642         }
<a name="l00643"></a>00643         printf(<span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l00644"></a>00644 <span class="preprocessor">#endif</span>
<a name="l00645"></a>00645 <span class="preprocessor"></span>        <a class="code" href="class_bulk_only.html#a2d422ee0745cd7c04afff905278c4233">qNextPollTime</a> = millis() + 2000;
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00653"></a><a class="code" href="class_bulk_only.html#a51b8a76f5e16697476ce2dcff2514bc6">00653</a> uint8_t <a class="code" href="class_bulk_only.html#a51b8a76f5e16697476ce2dcff2514bc6">BulkOnly::Poll</a>() {
<a name="l00654"></a>00654         <span class="comment">//uint8_t rcode = 0;</span>
<a name="l00655"></a>00655 
<a name="l00656"></a>00656         <span class="keywordflow">if</span>(!<a class="code" href="class_bulk_only.html#a21961ad1130480f534ef3e91f24c56a0">bPollEnable</a>)
<a name="l00657"></a>00657                 <span class="keywordflow">return</span> 0;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659         <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a2d422ee0745cd7c04afff905278c4233">qNextPollTime</a> &lt;= millis()) {
<a name="l00660"></a>00660                 CheckMedia();
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662         <span class="comment">//rcode = 0;</span>
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         <span class="keywordflow">return</span> 0;
<a name="l00665"></a>00665 }
<a name="l00666"></a>00666 
<a name="l00668"></a>00668 
<a name="l00669"></a>00669 
<a name="l00670"></a>00670 <span class="comment">// SCSI code</span>
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 
<a name="l00674"></a>00674 
<a name="l00681"></a>00681 uint8_t BulkOnly::GetMaxLUN(uint8_t *plun) {
<a name="l00682"></a>00682         uint8_t ret = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;ctrlReq(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, 0, <a class="code" href="masstorage_8h.html#affadc780007914e4b4de088b4df8ddf6">bmREQ_MASSIN</a>, <a class="code" href="masstorage_8h.html#a3fc37932ad8bcc25c185fb1efbc099b8">MASS_REQ_GET_MAX_LUN</a>, 0, 0, <a class="code" href="class_bulk_only.html#ac18ad598cd9a1ee99f49d51a572a50a4">bIface</a>, 1, 1, plun, NULL);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684         <span class="keywordflow">if</span>(ret == hrSTALL)
<a name="l00685"></a>00685                 *plun = 0;
<a name="l00686"></a>00686 
<a name="l00687"></a>00687         <span class="keywordflow">return</span> 0;
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00698"></a>00698 uint8_t BulkOnly::Inquiry(uint8_t lun, uint16_t bsize, uint8_t *buf) {
<a name="l00699"></a>00699         Notify(PSTR(<span class="stringliteral">&quot;\r\nInquiry\r\n&quot;</span>), 0x80);
<a name="l00700"></a>00700         Notify(PSTR(<span class="stringliteral">&quot;---------\r\n&quot;</span>), 0x80);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702         <a class="code" href="struct_c_d_b6.html">CDB6_t</a> cdb = <a class="code" href="masstorage_8h.html#a56ab0baf4e98a591274bf8d1acf96d85">CDB6_t</a>(<a class="code" href="masstorage_8h.html#ac1f82346efef75cf197abb8e29cc5f44">SCSI_CMD_INQUIRY</a>, lun, 0LU, (uint8_t)bsize, 0);
<a name="l00703"></a>00703         uint8_t rc = <a class="code" href="class_bulk_only.html#abec80bf6c8306115de66c0f87389bbd3">SCSITransaction6</a>(&amp;cdb, bsize, buf, (uint8_t)<a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>);
<a name="l00704"></a>00704 
<a name="l00705"></a>00705         <span class="keywordflow">return</span> rc;
<a name="l00706"></a>00706 }
<a name="l00707"></a>00707 
<a name="l00714"></a>00714 uint8_t BulkOnly::TestUnitReady(uint8_t lun) {
<a name="l00715"></a>00715         <span class="comment">//SetCurLUN(lun);</span>
<a name="l00716"></a>00716         <span class="keywordflow">if</span>(!<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>)
<a name="l00717"></a>00717                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a128e4910df8d7770c6f9af7700b9ccb1">MASS_ERR_UNIT_NOT_READY</a>;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719         Notify(PSTR(<span class="stringliteral">&quot;\r\nTestUnitReady\r\n&quot;</span>), 0x80);
<a name="l00720"></a>00720         Notify(PSTR(<span class="stringliteral">&quot;-----------------\r\n&quot;</span>), 0x80);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         <a class="code" href="struct_c_d_b6.html">CDB6_t</a> cdb = <a class="code" href="masstorage_8h.html#a56ab0baf4e98a591274bf8d1acf96d85">CDB6_t</a>(<a class="code" href="masstorage_8h.html#aa84c8ac327fad55b9d0e40fea9eda699">SCSI_CMD_TEST_UNIT_READY</a>, lun, (uint8_t)0, 0);
<a name="l00723"></a>00723         <span class="keywordflow">return</span> <a class="code" href="class_bulk_only.html#abec80bf6c8306115de66c0f87389bbd3">SCSITransaction6</a>(&amp;cdb, 0, NULL, (uint8_t)<a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725 }
<a name="l00726"></a>00726 
<a name="l00738"></a>00738 uint8_t BulkOnly::ModeSense6(uint8_t lun, uint8_t pc, uint8_t page, uint8_t subpage, uint8_t len, uint8_t * pbuf) {
<a name="l00739"></a>00739         Notify(PSTR(<span class="stringliteral">&quot;\r\rModeSense\r\n&quot;</span>), 0x80);
<a name="l00740"></a>00740         Notify(PSTR(<span class="stringliteral">&quot;------------\r\n&quot;</span>), 0x80);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742         <a class="code" href="struct_c_d_b6.html">CDB6_t</a> cdb = <a class="code" href="masstorage_8h.html#a56ab0baf4e98a591274bf8d1acf96d85">CDB6_t</a>(<a class="code" href="masstorage_8h.html#aa84c8ac327fad55b9d0e40fea9eda699">SCSI_CMD_TEST_UNIT_READY</a>, lun, (uint32_t)((((pc &lt;&lt; 6) | page) &lt;&lt; 8) | subpage), len, 0);
<a name="l00743"></a>00743         <span class="keywordflow">return</span> <a class="code" href="class_bulk_only.html#abec80bf6c8306115de66c0f87389bbd3">SCSITransaction6</a>(&amp;cdb, len, pbuf, (uint8_t)<a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>);
<a name="l00744"></a>00744 }
<a name="l00745"></a>00745 
<a name="l00754"></a>00754 uint8_t BulkOnly::ReadCapacity10(uint8_t lun, uint8_t *buf) {
<a name="l00755"></a>00755         Notify(PSTR(<span class="stringliteral">&quot;\r\nReadCapacity\r\n&quot;</span>), 0x80);
<a name="l00756"></a>00756         Notify(PSTR(<span class="stringliteral">&quot;---------------\r\n&quot;</span>), 0x80);
<a name="l00757"></a>00757 
<a name="l00758"></a>00758         <a class="code" href="struct_c_d_b10.html">CDB10_t</a> cdb = <a class="code" href="masstorage_8h.html#af952fd9270407996656ba95772511002">CDB10_t</a>(<a class="code" href="masstorage_8h.html#a1f08c7a277432486b2f875035df6790b">SCSI_CMD_READ_CAPACITY_10</a>, lun);
<a name="l00759"></a>00759         <span class="keywordflow">return</span> <a class="code" href="class_bulk_only.html#af07ab48c6b9e6bdb4f0d050adbae518d">SCSITransaction10</a>(&amp;cdb, 8, buf, (uint8_t)<a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>);
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00770"></a>00770 uint8_t BulkOnly::Page3F(uint8_t lun) {
<a name="l00771"></a>00771         uint8_t buf[192];
<a name="l00772"></a>00772         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; 192; i++) {
<a name="l00773"></a>00773                 buf[i] = 0x00;
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775         <a class="code" href="class_bulk_only.html#af763ffffdd131949322d583fb4cd2737">WriteOk</a>[lun] = <span class="keyword">true</span>;
<a name="l00776"></a>00776         uint8_t rc = ModeSense6(lun, 0, 0x3f, 0, 192, buf);
<a name="l00777"></a>00777         <span class="keywordflow">if</span>(!rc) {
<a name="l00778"></a>00778                 <a class="code" href="class_bulk_only.html#af763ffffdd131949322d583fb4cd2737">WriteOk</a>[lun] = ((buf[2] &amp; 0x80) == 0);
<a name="l00779"></a>00779                 Notify(PSTR(<span class="stringliteral">&quot;Mode Sense: &quot;</span>), 0x80);
<a name="l00780"></a>00780                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; 4; i++) {
<a name="l00781"></a>00781                         D_PrintHex&lt;uint8_t &gt; (buf[i], 0x80);
<a name="l00782"></a>00782                         Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l00783"></a>00783                 }
<a name="l00784"></a>00784                 Notify(PSTR(<span class="stringliteral">&quot;\r\n&quot;</span>), 0x80);
<a name="l00785"></a>00785         }
<a name="l00786"></a>00786         <span class="keywordflow">return</span> rc;
<a name="l00787"></a>00787 }
<a name="l00788"></a>00788 
<a name="l00797"></a>00797 uint8_t BulkOnly::RequestSense(uint8_t lun, uint16_t size, uint8_t *buf) {
<a name="l00798"></a>00798         Notify(PSTR(<span class="stringliteral">&quot;\r\nRequestSense\r\n&quot;</span>), 0x80);
<a name="l00799"></a>00799         Notify(PSTR(<span class="stringliteral">&quot;----------------\r\n&quot;</span>), 0x80);
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         <a class="code" href="struct_c_d_b6.html">CDB6_t</a> cdb = <a class="code" href="masstorage_8h.html#a56ab0baf4e98a591274bf8d1acf96d85">CDB6_t</a>(<a class="code" href="masstorage_8h.html#ad0ffafc58d70417e80425b2ee80c1769">SCSI_CMD_REQUEST_SENSE</a>, lun, 0LU, (uint8_t)size, 0);
<a name="l00802"></a>00802         <a class="code" href="struct_command_block_wrapper.html">CommandBlockWrapper</a> cbw = <a class="code" href="masstorage_8h.html#a16bd83701afd2cf52d741ab0b6a7e479">CommandBlockWrapper</a>(++<a class="code" href="class_bulk_only.html#a7ae682d50badd1386a06f30f35a32d1d">dCBWTag</a>, (uint32_t)size, &amp;cdb, (uint8_t)<a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>);
<a name="l00803"></a>00803         <span class="comment">//SetCurLUN(lun);</span>
<a name="l00804"></a>00804         <span class="keywordflow">return</span> Transaction(&amp;cbw, size, buf);
<a name="l00805"></a>00805 }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807 
<a name="l00809"></a>00809 
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 <span class="comment">// USB code</span>
<a name="l00812"></a>00812 
<a name="l00813"></a>00813 
<a name="l00815"></a>00815 
<a name="l00822"></a>00822 uint8_t BulkOnly::ClearEpHalt(uint8_t index) {
<a name="l00823"></a>00823         <span class="keywordflow">if</span>(index == 0)
<a name="l00824"></a>00824                 <span class="keywordflow">return</span> 0;
<a name="l00825"></a>00825 
<a name="l00826"></a>00826         uint8_t ret = 0;
<a name="l00827"></a>00827 
<a name="l00828"></a>00828         <span class="keywordflow">while</span>((ret = (<a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;ctrlReq(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, 0, USB_SETUP_HOST_TO_DEVICE | USB_SETUP_TYPE_STANDARD | USB_SETUP_RECIPIENT_ENDPOINT, USB_REQUEST_CLEAR_FEATURE, USB_FEATURE_ENDPOINT_HALT, 0, ((index == <a class="code" href="class_bulk_only.html#a9e487226408578a2971570bcf7de62fe">epDataInIndex</a>) ? (0x80 | <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[index].epAddr) : <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[index].epAddr), 0, 0, NULL, NULL)) == 0x01))
<a name="l00829"></a>00829                 delay(6);
<a name="l00830"></a>00830 
<a name="l00831"></a>00831         <span class="keywordflow">if</span>(ret) {
<a name="l00832"></a>00832                 ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;ClearEpHalt&quot;</span>), ret);
<a name="l00833"></a>00833                 ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;EP&quot;</span>), ((index == <a class="code" href="class_bulk_only.html#a9e487226408578a2971570bcf7de62fe">epDataInIndex</a>) ? (0x80 | <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[index].epAddr) : <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[index].epAddr));
<a name="l00834"></a>00834                 <span class="keywordflow">return</span> ret;
<a name="l00835"></a>00835         }
<a name="l00836"></a>00836         <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[index].bmSndToggle = 0;
<a name="l00837"></a>00837         <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[index].bmRcvToggle = 0;
<a name="l00838"></a>00838         <span class="comment">// epAttribs = 0;</span>
<a name="l00839"></a>00839         <span class="keywordflow">return</span> 0;
<a name="l00840"></a>00840 }
<a name="l00841"></a>00841 
<a name="l00846"></a>00846 <span class="keywordtype">void</span> BulkOnly::Reset() {
<a name="l00847"></a>00847         <span class="keywordflow">while</span>(<a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;ctrlReq(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, 0, <a class="code" href="masstorage_8h.html#a86a509a216410b0e356f0fa91c48cdc0">bmREQ_MASSOUT</a>, <a class="code" href="masstorage_8h.html#a172c269d960fa57ce6dfeaacc6f6197f">MASS_REQ_BOMSR</a>, 0, 0, <a class="code" href="class_bulk_only.html#ac18ad598cd9a1ee99f49d51a572a50a4">bIface</a>, 0, 0, NULL, NULL) == 0x01) delay(6);
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 
<a name="l00855"></a>00855 uint8_t BulkOnly::ResetRecovery() {
<a name="l00856"></a>00856         Notify(PSTR(<span class="stringliteral">&quot;\r\nResetRecovery\r\n&quot;</span>), 0x80);
<a name="l00857"></a>00857         Notify(PSTR(<span class="stringliteral">&quot;-----------------\r\n&quot;</span>), 0x80);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859         delay(6);
<a name="l00860"></a>00860         Reset();
<a name="l00861"></a>00861         delay(6);
<a name="l00862"></a>00862         ClearEpHalt(<a class="code" href="class_bulk_only.html#a9e487226408578a2971570bcf7de62fe">epDataInIndex</a>);
<a name="l00863"></a>00863         delay(6);
<a name="l00864"></a>00864         <a class="code" href="class_bulk_only.html#a20ff3cc4bb15c557f57a8c6200b412d1">bLastUsbError</a> = ClearEpHalt(<a class="code" href="class_bulk_only.html#a8d527bdc285870f3571481a4fd982721">epDataOutIndex</a>);
<a name="l00865"></a>00865         delay(6);
<a name="l00866"></a>00866         <span class="keywordflow">return</span> <a class="code" href="class_bulk_only.html#a20ff3cc4bb15c557f57a8c6200b412d1">bLastUsbError</a>;
<a name="l00867"></a>00867 }
<a name="l00868"></a>00868 
<a name="l00874"></a>00874 <span class="keywordtype">void</span> BulkOnly::ClearAllEP() {
<a name="l00875"></a>00875         <span class="keywordflow">for</span>(uint8_t i = 0; i &lt; <a class="code" href="masstorage_8h.html#ab4baa1ea500923e1fc59e5991f05fe99">MASS_MAX_ENDPOINTS</a>; i++) {
<a name="l00876"></a>00876                 <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[i].epAddr = 0;
<a name="l00877"></a>00877                 <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[i].maxPktSize = (i) ? 0 : 8;
<a name="l00878"></a>00878                 <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[i].epAttribs = 0;
<a name="l00879"></a>00879 
<a name="l00880"></a>00880                 <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[i].bmNakPower = USB_NAK_DEFAULT;
<a name="l00881"></a>00881         }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883         <span class="keywordflow">for</span>(uint8_t i = 0; i &lt; MASS_MAX_SUPPORTED_LUN; i++) {
<a name="l00884"></a>00884                 <a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[i] = <span class="keyword">false</span>;
<a name="l00885"></a>00885                 <a class="code" href="class_bulk_only.html#af763ffffdd131949322d583fb4cd2737">WriteOk</a>[i] = <span class="keyword">false</span>;
<a name="l00886"></a>00886                 <a class="code" href="class_bulk_only.html#a73c3f6b8f6f79ad60e5ba05e560b277d">CurrentCapacity</a>[i] = 0lu;
<a name="l00887"></a>00887                 <a class="code" href="class_bulk_only.html#aa4e2711c6279d48c63e82a63ad458421">CurrentSectorSize</a>[i] = 0;
<a name="l00888"></a>00888         }
<a name="l00889"></a>00889 
<a name="l00890"></a>00890         <a class="code" href="class_bulk_only.html#ac18ad598cd9a1ee99f49d51a572a50a4">bIface</a> = 0;
<a name="l00891"></a>00891         <a class="code" href="class_bulk_only.html#a6cb56ebd0307845321340919e2b35952">bNumEP</a> = 1;
<a name="l00892"></a>00892         <a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a> = 0;
<a name="l00893"></a>00893         <a class="code" href="class_bulk_only.html#a2d422ee0745cd7c04afff905278c4233">qNextPollTime</a> = 0;
<a name="l00894"></a>00894         <a class="code" href="class_bulk_only.html#a21961ad1130480f534ef3e91f24c56a0">bPollEnable</a> = <span class="keyword">false</span>;
<a name="l00895"></a>00895         <a class="code" href="class_bulk_only.html#a20ff3cc4bb15c557f57a8c6200b412d1">bLastUsbError</a> = 0;
<a name="l00896"></a>00896         <a class="code" href="class_bulk_only.html#a6bbdd41bf6efc4060f3c36da7d6ed8b2">bMaxLUN</a> = 0;
<a name="l00897"></a>00897         <a class="code" href="class_bulk_only.html#a24c051d401f5f1a9ce65c1bc25ab02dd">bTheLUN</a> = 0;
<a name="l00898"></a>00898 }
<a name="l00899"></a>00899 
<a name="l00907"></a>00907 <span class="keywordtype">bool</span> BulkOnly::IsValidCSW(<a class="code" href="struct_command_status_wrapper.html">CommandStatusWrapper</a> *pcsw, <a class="code" href="struct_command_block_wrapper_base.html">CommandBlockWrapperBase</a> *pcbw) {
<a name="l00908"></a>00908         <span class="keywordflow">if</span>(pcsw-&gt;<a class="code" href="struct_command_status_wrapper.html#a498a87759e737395829b6ff4b6420ad1">dCSWSignature</a> != <a class="code" href="masstorage_8h.html#af92587f54f4d56af3dd2fb3a474c0b33">MASS_CSW_SIGNATURE</a>) {
<a name="l00909"></a>00909                 Notify(PSTR(<span class="stringliteral">&quot;CSW:Sig error\r\n&quot;</span>), 0x80);
<a name="l00910"></a>00910                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00911"></a>00911         }
<a name="l00912"></a>00912         <span class="keywordflow">if</span>(pcsw-&gt;<a class="code" href="struct_command_status_wrapper.html#af872c29cfee3fb74e7ad9471ee4461fb">dCSWTag</a> != pcbw-&gt;<a class="code" href="struct_command_block_wrapper_base.html#a0898a332eec2d598b80a896ff66d5549">dCBWTag</a>) {
<a name="l00913"></a>00913                 Notify(PSTR(<span class="stringliteral">&quot;CSW:Wrong tag\r\n&quot;</span>), 0x80);
<a name="l00914"></a>00914                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00915"></a>00915         }
<a name="l00916"></a>00916         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00917"></a>00917 }
<a name="l00918"></a>00918 
<a name="l00926"></a>00926 uint8_t BulkOnly::HandleUsbError(uint8_t error, uint8_t index) {
<a name="l00927"></a>00927         uint8_t count = 3;
<a name="l00928"></a>00928 
<a name="l00929"></a>00929         <a class="code" href="class_bulk_only.html#a20ff3cc4bb15c557f57a8c6200b412d1">bLastUsbError</a> = error;
<a name="l00930"></a>00930         <span class="comment">//if (error)</span>
<a name="l00931"></a>00931         <span class="comment">//ClearEpHalt(index);</span>
<a name="l00932"></a>00932         <span class="keywordflow">while</span>(error &amp;&amp; count) {
<a name="l00933"></a>00933                 <span class="keywordflow">if</span>(error != hrSUCCESS) {
<a name="l00934"></a>00934                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;USB Error&quot;</span>), error);
<a name="l00935"></a>00935                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Index&quot;</span>), index);
<a name="l00936"></a>00936                 }
<a name="l00937"></a>00937                 <span class="keywordflow">switch</span>(error) {
<a name="l00938"></a>00938                                 <span class="comment">// case hrWRONGPID:</span>
<a name="l00939"></a>00939                         <span class="keywordflow">case</span> hrSUCCESS:
<a name="l00940"></a>00940                                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a450c2a67aa2b6a1f6593113dcb847569">MASS_ERR_SUCCESS</a>;
<a name="l00941"></a>00941                         <span class="keywordflow">case</span> hrBUSY:
<a name="l00942"></a>00942                                 <span class="comment">// SIE is busy, just hang out and try again.</span>
<a name="l00943"></a>00943                                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#ab8e02094ea448728c4229e348c90cc54">MASS_ERR_UNIT_BUSY</a>;
<a name="l00944"></a>00944                         <span class="keywordflow">case</span> hrTIMEOUT:
<a name="l00945"></a>00945                         <span class="keywordflow">case</span> hrJERR: <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a75359f810ebeccd313e4ad9c3a88f231">MASS_ERR_DEVICE_DISCONNECTED</a>;
<a name="l00946"></a>00946                         <span class="keywordflow">case</span> hrSTALL:
<a name="l00947"></a>00947                                 <span class="keywordflow">if</span>(index == 0)
<a name="l00948"></a>00948                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a13aee9eab965d570a4a00463cd20ca29">MASS_ERR_STALL</a>;
<a name="l00949"></a>00949                                 ClearEpHalt(index);
<a name="l00950"></a>00950                                 <span class="keywordflow">if</span>(index != <a class="code" href="class_bulk_only.html#a9e487226408578a2971570bcf7de62fe">epDataInIndex</a>)
<a name="l00951"></a>00951                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a1b4efb4cfc2b0d4a912abe587a145b84">MASS_ERR_WRITE_STALL</a>;
<a name="l00952"></a>00952                                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a13aee9eab965d570a4a00463cd20ca29">MASS_ERR_STALL</a>;
<a name="l00953"></a>00953 
<a name="l00954"></a>00954                         <span class="keywordflow">case</span> hrNAK:
<a name="l00955"></a>00955                                 <span class="keywordflow">if</span>(index == 0)
<a name="l00956"></a>00956                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#ab8e02094ea448728c4229e348c90cc54">MASS_ERR_UNIT_BUSY</a>;
<a name="l00957"></a>00957                                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#ab8e02094ea448728c4229e348c90cc54">MASS_ERR_UNIT_BUSY</a>;
<a name="l00958"></a>00958 
<a name="l00959"></a>00959                         <span class="keywordflow">case</span> hrTOGERR:
<a name="l00960"></a>00960                                 <span class="comment">// Handle a very super rare corner case, where toggles become de-synched.</span>
<a name="l00961"></a>00961                                 <span class="comment">// I have only ran into one device that has this firmware bug, and this is</span>
<a name="l00962"></a>00962                                 <span class="comment">// the only clean way to get back into sync with the buggy device firmware.</span>
<a name="l00963"></a>00963                                 <span class="comment">//   --AJK</span>
<a name="l00964"></a>00964                                 <span class="keywordflow">if</span>(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a> &amp;&amp; <a class="code" href="class_bulk_only.html#ab54f472ec9cd39abdb9f90867943d162">bConfNum</a>) {
<a name="l00965"></a>00965                                         error = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;setConf(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, 0, <a class="code" href="class_bulk_only.html#ab54f472ec9cd39abdb9f90867943d162">bConfNum</a>);
<a name="l00966"></a>00966 
<a name="l00967"></a>00967                                         <span class="keywordflow">if</span>(error)
<a name="l00968"></a>00968                                                 <span class="keywordflow">break</span>;
<a name="l00969"></a>00969                                 }
<a name="l00970"></a>00970                                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a450c2a67aa2b6a1f6593113dcb847569">MASS_ERR_SUCCESS</a>;
<a name="l00971"></a>00971                         <span class="keywordflow">default</span>:
<a name="l00972"></a>00972                                 ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;\r\nUSB&quot;</span>), error);
<a name="l00973"></a>00973                                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a6c2dcf2fe5e2bead7ce82793de900eaf">MASS_ERR_GENERAL_USB_ERROR</a>;
<a name="l00974"></a>00974                 }
<a name="l00975"></a>00975                 count--;
<a name="l00976"></a>00976         } <span class="comment">// while</span>
<a name="l00977"></a>00977 
<a name="l00978"></a>00978         <span class="keywordflow">return</span> ((error &amp;&amp; !count) ? <a class="code" href="masstorage_8h.html#a6c2dcf2fe5e2bead7ce82793de900eaf">MASS_ERR_GENERAL_USB_ERROR</a> : <a class="code" href="masstorage_8h.html#a450c2a67aa2b6a1f6593113dcb847569">MASS_ERR_SUCCESS</a>);
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981 <span class="preprocessor">#if MS_WANT_PARSER</span>
<a name="l00982"></a>00982 <span class="preprocessor"></span>
<a name="l00983"></a>00983 uint8_t BulkOnly::Transaction(<a class="code" href="struct_command_block_wrapper.html">CommandBlockWrapper</a> *pcbw, uint16_t buf_size, <span class="keywordtype">void</span> *buf) {
<a name="l00984"></a>00984         <span class="keywordflow">return</span> Transaction(<a class="code" href="struct_command_block_wrapper.html">CommandBlockWrapper</a> *pcbw, uint16_t buf_size, <span class="keywordtype">void</span> *buf, 0);
<a name="l00985"></a>00985 }
<a name="l00986"></a>00986 <span class="preprocessor">#endif</span>
<a name="l00987"></a>00987 <span class="preprocessor"></span>
<a name="l00997"></a>00997 uint8_t BulkOnly::Transaction(<a class="code" href="struct_command_block_wrapper.html">CommandBlockWrapper</a> *pcbw, uint16_t buf_size, <span class="keywordtype">void</span> *buf
<a name="l00998"></a>00998 #<span class="keywordflow">if</span> MS_WANT_PARSER
<a name="l00999"></a>00999         , uint8_t flags
<a name="l01000"></a>01000 #endif
<a name="l01001"></a>01001         ) {
<a name="l01002"></a>01002 
<a name="l01003"></a>01003 <span class="preprocessor">#if MS_WANT_PARSER</span>
<a name="l01004"></a>01004 <span class="preprocessor"></span>        uint16_t bytes = (pcbw-&gt;<a class="code" href="struct_command_block_wrapper_base.html#a62c537797107ada830b86e1f2d629164">dCBWDataTransferLength</a> &gt; buf_size) ? buf_size : pcbw-&gt;<a class="code" href="struct_command_block_wrapper_base.html#a62c537797107ada830b86e1f2d629164">dCBWDataTransferLength</a>;
<a name="l01005"></a>01005         printf(<span class="stringliteral">&quot;Transfersize %i\r\n&quot;</span>, bytes);
<a name="l01006"></a>01006         delay(1000);
<a name="l01007"></a>01007 
<a name="l01008"></a>01008         <span class="keywordtype">boolean</span> callback = (flags &amp; <a class="code" href="masstorage_8h.html#a597e2a0f4ee36172c260976af9805415">MASS_TRANS_FLG_CALLBACK</a>) == <a class="code" href="masstorage_8h.html#a597e2a0f4ee36172c260976af9805415">MASS_TRANS_FLG_CALLBACK</a>;
<a name="l01009"></a>01009 <span class="preprocessor">#else</span>
<a name="l01010"></a>01010 <span class="preprocessor"></span>        uint16_t bytes = buf_size;
<a name="l01011"></a>01011 <span class="preprocessor">#endif</span>
<a name="l01012"></a>01012 <span class="preprocessor"></span>        <span class="keywordtype">boolean</span> write = (pcbw-&gt;<a class="code" href="struct_command_block_wrapper_base.html#a396b36ceef993c32f28b1354727a5e9e">bmCBWFlags</a> &amp; <a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>) != <a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>;
<a name="l01013"></a>01013         uint8_t ret = 0;
<a name="l01014"></a>01014         uint8_t usberr;
<a name="l01015"></a>01015         <a class="code" href="struct_command_status_wrapper.html">CommandStatusWrapper</a> csw; <span class="comment">// up here, we allocate ahead to save cpu cycles.</span>
<a name="l01016"></a>01016         SetCurLUN(pcbw-&gt;<a class="code" href="struct_command_block_wrapper.html#a2a16bb9a98e3ee4eaac8fea6310b4e01">bmCBWLUN</a>);
<a name="l01017"></a>01017         ErrorMessage&lt;uint32_t &gt; (PSTR(<span class="stringliteral">&quot;CBW.dCBWTag&quot;</span>), pcbw-&gt;<a class="code" href="struct_command_block_wrapper_base.html#a0898a332eec2d598b80a896ff66d5549">dCBWTag</a>);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         <span class="keywordflow">while</span>((usberr = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;outTransfer(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[<a class="code" href="class_bulk_only.html#a8d527bdc285870f3571481a4fd982721">epDataOutIndex</a>].epAddr, sizeof (<a class="code" href="struct_command_block_wrapper.html">CommandBlockWrapper</a>), (uint8_t*)pcbw)) == hrBUSY) delay(1);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021         ret = HandleUsbError(usberr, epDataOutIndex);
<a name="l01022"></a>01022         <span class="comment">//ret = HandleUsbError(pUsb-&gt;outTransfer(bAddress, epInfo[epDataOutIndex].epAddr, sizeof (CommandBlockWrapper), (uint8_t*)pcbw), epDataOutIndex);</span>
<a name="l01023"></a>01023         <span class="keywordflow">if</span>(ret) {
<a name="l01024"></a>01024                 ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;============================ CBW&quot;</span>), ret);
<a name="l01025"></a>01025         } <span class="keywordflow">else</span> {
<a name="l01026"></a>01026                 <span class="keywordflow">if</span>(bytes) {
<a name="l01027"></a>01027                         <span class="keywordflow">if</span>(!write) {
<a name="l01028"></a>01028 <span class="preprocessor">#if MS_WANT_PARSER</span>
<a name="l01029"></a>01029 <span class="preprocessor"></span>                                <span class="keywordflow">if</span>(callback) {
<a name="l01030"></a>01030                                         uint8_t rbuf[bytes];
<a name="l01031"></a>01031                                         <span class="keywordflow">while</span>((usberr = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;inTransfer(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[<a class="code" href="class_bulk_only.html#a9e487226408578a2971570bcf7de62fe">epDataInIndex</a>].epAddr, &amp;bytes, rbuf)) == hrBUSY) delay(1);
<a name="l01032"></a>01032                                         <span class="keywordflow">if</span>(usberr == hrSUCCESS) ((USBReadParser*)buf)-&gt;Parse(bytes, rbuf, 0);
<a name="l01033"></a>01033                                 } <span class="keywordflow">else</span> {
<a name="l01034"></a>01034 <span class="preprocessor">#endif</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span>                                        <span class="keywordflow">while</span>((usberr = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;inTransfer(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[epDataInIndex].epAddr, &amp;bytes, (uint8_t*)buf)) == hrBUSY) delay(1);
<a name="l01036"></a>01036 <span class="preprocessor">#if MS_WANT_PARSER</span>
<a name="l01037"></a>01037 <span class="preprocessor"></span>
<a name="l01038"></a>01038                                 }
<a name="l01039"></a>01039 <span class="preprocessor">#endif</span>
<a name="l01040"></a>01040 <span class="preprocessor"></span>                                ret = HandleUsbError(usberr, epDataInIndex);
<a name="l01041"></a>01041                         } <span class="keywordflow">else</span> {
<a name="l01042"></a>01042                                 <span class="keywordflow">while</span>((usberr = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;outTransfer(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[epDataOutIndex].epAddr, bytes, (uint8_t*)buf)) == hrBUSY) delay(1);
<a name="l01043"></a>01043                                 ret = HandleUsbError(usberr, epDataOutIndex);
<a name="l01044"></a>01044                         }
<a name="l01045"></a>01045                         <span class="keywordflow">if</span>(ret) {
<a name="l01046"></a>01046                                 ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;============================ DAT&quot;</span>), ret);
<a name="l01047"></a>01047                         }
<a name="l01048"></a>01048                 }
<a name="l01049"></a>01049         }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051         {
<a name="l01052"></a>01052                 bytes = <span class="keyword">sizeof</span> (<a class="code" href="struct_command_status_wrapper.html">CommandStatusWrapper</a>);
<a name="l01053"></a>01053                 <span class="keywordtype">int</span> tries = 2;
<a name="l01054"></a>01054                 <span class="keywordflow">while</span>(tries--) {
<a name="l01055"></a>01055                         <span class="keywordflow">while</span>((usberr = <a class="code" href="class_bulk_only.html#a6b4ae384eea3aacd8bf916439621973a">pUsb</a>-&gt;inTransfer(<a class="code" href="class_bulk_only.html#a9968a2119df66fa0093b020e318d8ac6">bAddress</a>, <a class="code" href="class_bulk_only.html#aee2247fd0a251e4da36e8c09bbe6917f">epInfo</a>[epDataInIndex].epAddr, &amp;bytes, (uint8_t*) &amp; csw)) == hrBUSY) delay(1);
<a name="l01056"></a>01056                         <span class="keywordflow">if</span>(!usberr) <span class="keywordflow">break</span>;
<a name="l01057"></a>01057                         ClearEpHalt(epDataInIndex);
<a name="l01058"></a>01058                         <span class="keywordflow">if</span>(tries) ResetRecovery();
<a name="l01059"></a>01059                 }
<a name="l01060"></a>01060                 <span class="keywordflow">if</span>(!ret) {
<a name="l01061"></a>01061                         Notify(PSTR(<span class="stringliteral">&quot;CBW:\t\tOK\r\n&quot;</span>), 0x80);
<a name="l01062"></a>01062                         Notify(PSTR(<span class="stringliteral">&quot;Data Stage:\tOK\r\n&quot;</span>), 0x80);
<a name="l01063"></a>01063                 } <span class="keywordflow">else</span> {
<a name="l01064"></a>01064                         <span class="comment">// Throw away csw, IT IS NOT OF ANY USE.</span>
<a name="l01065"></a>01065                         ResetRecovery();
<a name="l01066"></a>01066                         <span class="keywordflow">return</span> ret;
<a name="l01067"></a>01067                 }
<a name="l01068"></a>01068                 ret = HandleUsbError(usberr, epDataInIndex);
<a name="l01069"></a>01069                 <span class="keywordflow">if</span>(ret) {
<a name="l01070"></a>01070                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;============================ CSW&quot;</span>), ret);
<a name="l01071"></a>01071                 }
<a name="l01072"></a>01072                 <span class="keywordflow">if</span>(usberr == hrSUCCESS) {
<a name="l01073"></a>01073                         <span class="keywordflow">if</span>(IsValidCSW(&amp;csw, pcbw)) {
<a name="l01074"></a>01074                                 <span class="comment">//ErrorMessage&lt;uint32_t &gt; (PSTR(&quot;CSW.dCBWTag&quot;), csw.dCSWTag);</span>
<a name="l01075"></a>01075                                 <span class="comment">//ErrorMessage&lt;uint8_t &gt; (PSTR(&quot;bCSWStatus&quot;), csw.bCSWStatus);</span>
<a name="l01076"></a>01076                                 <span class="comment">//ErrorMessage&lt;uint32_t &gt; (PSTR(&quot;dCSWDataResidue&quot;), csw.dCSWDataResidue);</span>
<a name="l01077"></a>01077                                 Notify(PSTR(<span class="stringliteral">&quot;CSW:\t\tOK\r\n\r\n&quot;</span>), 0x80);
<a name="l01078"></a>01078                                 <span class="keywordflow">return</span> csw.bCSWStatus;
<a name="l01079"></a>01079                         } <span class="keywordflow">else</span> {
<a name="l01080"></a>01080                                 <span class="comment">// NOTE! Sometimes this is caused by the reported residue being wrong.</span>
<a name="l01081"></a>01081                                 <span class="comment">// Get a different device. It isn&#39;t compliant, and should have never passed Q&amp;A.</span>
<a name="l01082"></a>01082                                 <span class="comment">// I own one... 05e3:0701 Genesys Logic, Inc. USB 2.0 IDE Adapter.</span>
<a name="l01083"></a>01083                                 <span class="comment">// Other devices that exhibit this behavior exist in the wild too.</span>
<a name="l01084"></a>01084                                 <span class="comment">// Be sure to check quirks in the Linux source code before reporting a bug. --xxxajk</span>
<a name="l01085"></a>01085                                 Notify(PSTR(<span class="stringliteral">&quot;Invalid CSW\r\n&quot;</span>), 0x80);
<a name="l01086"></a>01086                                 ResetRecovery();
<a name="l01087"></a>01087                                 <span class="comment">//return MASS_ERR_SUCCESS;</span>
<a name="l01088"></a>01088                                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a8521fd3c4b7901296d3edae0632c162d">MASS_ERR_INVALID_CSW</a>;
<a name="l01089"></a>01089                         }
<a name="l01090"></a>01090                 }
<a name="l01091"></a>01091         }
<a name="l01092"></a>01092         <span class="keywordflow">return</span> ret;
<a name="l01093"></a>01093 }
<a name="l01094"></a>01094 
<a name="l01101"></a>01101 uint8_t BulkOnly::SetCurLUN(uint8_t lun) {
<a name="l01102"></a>01102         <span class="keywordflow">if</span>(lun &gt; <a class="code" href="class_bulk_only.html#a6bbdd41bf6efc4060f3c36da7d6ed8b2">bMaxLUN</a>)
<a name="l01103"></a>01103                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a5341c969f1daf8a9e8d345c0ba36fa54">MASS_ERR_INVALID_LUN</a>;
<a name="l01104"></a>01104         <a class="code" href="class_bulk_only.html#a24c051d401f5f1a9ce65c1bc25ab02dd">bTheLUN</a> = lun;
<a name="l01105"></a>01105         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a450c2a67aa2b6a1f6593113dcb847569">MASS_ERR_SUCCESS</a>;
<a name="l01106"></a>01106 };
<a name="l01107"></a>01107 
<a name="l01114"></a>01114 uint8_t BulkOnly::HandleSCSIError(uint8_t status) {
<a name="l01115"></a>01115         uint8_t ret = 0;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117         <span class="keywordflow">switch</span>(status) {
<a name="l01118"></a>01118                 <span class="keywordflow">case</span> 0: <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a450c2a67aa2b6a1f6593113dcb847569">MASS_ERR_SUCCESS</a>;
<a name="l01119"></a>01119 
<a name="l01120"></a>01120                 <span class="keywordflow">case</span> 2:
<a name="l01121"></a>01121                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Phase Error&quot;</span>), status);
<a name="l01122"></a>01122                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;LUN&quot;</span>), <a class="code" href="class_bulk_only.html#a24c051d401f5f1a9ce65c1bc25ab02dd">bTheLUN</a>);
<a name="l01123"></a>01123                         ResetRecovery();
<a name="l01124"></a>01124                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a2815b1980ee4f05d2712a6492b5272b3">MASS_ERR_GENERAL_SCSI_ERROR</a>;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126                 <span class="keywordflow">case</span> 1:
<a name="l01127"></a>01127                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;SCSI Error&quot;</span>), status);
<a name="l01128"></a>01128                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;LUN&quot;</span>), <a class="code" href="class_bulk_only.html#a24c051d401f5f1a9ce65c1bc25ab02dd">bTheLUN</a>);
<a name="l01129"></a>01129                         <a class="code" href="struct_request_sense_responce.html">RequestSenseResponce</a> rsp;
<a name="l01130"></a>01130 
<a name="l01131"></a>01131                         ret = RequestSense(<a class="code" href="class_bulk_only.html#a24c051d401f5f1a9ce65c1bc25ab02dd">bTheLUN</a>, <span class="keyword">sizeof</span> (<a class="code" href="struct_request_sense_responce.html">RequestSenseResponce</a>), (uint8_t*) &amp; rsp);
<a name="l01132"></a>01132 
<a name="l01133"></a>01133                         <span class="keywordflow">if</span>(ret) {
<a name="l01134"></a>01134                                 <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a2815b1980ee4f05d2712a6492b5272b3">MASS_ERR_GENERAL_SCSI_ERROR</a>;
<a name="l01135"></a>01135                         }
<a name="l01136"></a>01136                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Response Code&quot;</span>), rsp.bResponseCode);
<a name="l01137"></a>01137                         <span class="keywordflow">if</span>(rsp.bResponseCode &amp; 0x80) {
<a name="l01138"></a>01138                                 Notify(PSTR(<span class="stringliteral">&quot;Information field: &quot;</span>), 0x80);
<a name="l01139"></a>01139                                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; 4; i++) {
<a name="l01140"></a>01140                                         D_PrintHex&lt;uint8_t &gt; (rsp.CmdSpecificInformation[i], 0x80);
<a name="l01141"></a>01141                                         Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l01142"></a>01142                                 }
<a name="l01143"></a>01143                                 Notify(PSTR(<span class="stringliteral">&quot;\r\n&quot;</span>), 0x80);
<a name="l01144"></a>01144                         }
<a name="l01145"></a>01145                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Sense Key&quot;</span>), rsp.bmSenseKey);
<a name="l01146"></a>01146                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Add Sense Code&quot;</span>), rsp.bAdditionalSenseCode);
<a name="l01147"></a>01147                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Add Sense Qual&quot;</span>), rsp.bAdditionalSenseQualifier);
<a name="l01148"></a>01148                         <span class="comment">// warning, this is not testing ASQ, only SK and ASC.</span>
<a name="l01149"></a>01149                         <span class="keywordflow">switch</span>(rsp.bmSenseKey) {
<a name="l01150"></a>01150                                 <span class="keywordflow">case</span> <a class="code" href="masstorage_8h.html#ae7ab5840b35001bba68d7adae4abcd11">SCSI_S_UNIT_ATTENTION</a>:
<a name="l01151"></a>01151                                         <span class="keywordflow">switch</span>(rsp.bAdditionalSenseCode) {
<a name="l01152"></a>01152                                                 <span class="keywordflow">case</span> <a class="code" href="masstorage_8h.html#a9fd5f74b6bac6c95990f5f211c04894b">SCSI_ASC_MEDIA_CHANGED</a>:
<a name="l01153"></a>01153                                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a6ddc06e45101114eb7842a7ee57f7d43">MASS_ERR_MEDIA_CHANGED</a>;
<a name="l01154"></a>01154                                                 <span class="keywordflow">default</span>:
<a name="l01155"></a>01155                                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a128e4910df8d7770c6f9af7700b9ccb1">MASS_ERR_UNIT_NOT_READY</a>;
<a name="l01156"></a>01156                                         }
<a name="l01157"></a>01157                                 <span class="keywordflow">case</span> <a class="code" href="masstorage_8h.html#a613422ba27c89fe5d72d06d216c9f2a5">SCSI_S_NOT_READY</a>:
<a name="l01158"></a>01158                                         <span class="keywordflow">switch</span>(rsp.bAdditionalSenseCode) {
<a name="l01159"></a>01159                                                 <span class="keywordflow">case</span> <a class="code" href="masstorage_8h.html#ac0c79fb555815317d46e9af6192d959d">SCSI_ASC_MEDIUM_NOT_PRESENT</a>:
<a name="l01160"></a>01160                                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#aec47def0928045fdca474d78db866c39">MASS_ERR_NO_MEDIA</a>;
<a name="l01161"></a>01161                                                 <span class="keywordflow">default</span>:
<a name="l01162"></a>01162                                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a128e4910df8d7770c6f9af7700b9ccb1">MASS_ERR_UNIT_NOT_READY</a>;
<a name="l01163"></a>01163                                         }
<a name="l01164"></a>01164                                 <span class="keywordflow">case</span> <a class="code" href="masstorage_8h.html#a3f36c4b24d404a7bde02e6bf3f87a0cd">SCSI_S_ILLEGAL_REQUEST</a>:
<a name="l01165"></a>01165                                         <span class="keywordflow">switch</span>(rsp.bAdditionalSenseCode) {
<a name="l01166"></a>01166                                                 <span class="keywordflow">case</span> <a class="code" href="masstorage_8h.html#ac6d64023e2b8137eed90917f362ab262">SCSI_ASC_LBA_OUT_OF_RANGE</a>:
<a name="l01167"></a>01167                                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a57edffb4395696374818f80202aedca4">MASS_ERR_BAD_LBA</a>;
<a name="l01168"></a>01168                                                 <span class="keywordflow">default</span>:
<a name="l01169"></a>01169                                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#ac3364cf841936aa8c3107e14c06ff65f">MASS_ERR_CMD_NOT_SUPPORTED</a>;
<a name="l01170"></a>01170                                         }
<a name="l01171"></a>01171                                 <span class="keywordflow">default</span>:
<a name="l01172"></a>01172                                         <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a2815b1980ee4f05d2712a6492b5272b3">MASS_ERR_GENERAL_SCSI_ERROR</a>;
<a name="l01173"></a>01173                         }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175                         <span class="comment">// case 4: return MASS_ERR_UNIT_BUSY; // Busy means retry later.</span>
<a name="l01176"></a>01176                         <span class="comment">//    case 0x05/0x14: we stalled out</span>
<a name="l01177"></a>01177                         <span class="comment">//    case 0x15/0x16: we naked out.</span>
<a name="l01178"></a>01178                 <span class="keywordflow">default</span>:
<a name="l01179"></a>01179                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;Gen SCSI Err&quot;</span>), status);
<a name="l01180"></a>01180                         ErrorMessage&lt;uint8_t &gt; (PSTR(<span class="stringliteral">&quot;LUN&quot;</span>), <a class="code" href="class_bulk_only.html#a24c051d401f5f1a9ce65c1bc25ab02dd">bTheLUN</a>);
<a name="l01181"></a>01181                         <span class="keywordflow">return</span> status;
<a name="l01182"></a>01182         } <span class="comment">// switch</span>
<a name="l01183"></a>01183 }
<a name="l01184"></a>01184 
<a name="l01185"></a>01185 
<a name="l01187"></a>01187 
<a name="l01188"></a>01188 
<a name="l01189"></a>01189 <span class="comment">// Debugging code</span>
<a name="l01190"></a>01190 
<a name="l01191"></a>01191 
<a name="l01193"></a>01193 
<a name="l01198"></a><a class="code" href="class_bulk_only.html#ac8a1d7b2ef82d9f6da44928c78039964">01198</a> <span class="keywordtype">void</span> <a class="code" href="class_bulk_only.html#ac8a1d7b2ef82d9f6da44928c78039964">BulkOnly::PrintEndpointDescriptor</a>(<span class="keyword">const</span> USB_ENDPOINT_DESCRIPTOR * ep_ptr) {
<a name="l01199"></a>01199         Notify(PSTR(<span class="stringliteral">&quot;Endpoint descriptor:&quot;</span>), 0x80);
<a name="l01200"></a>01200         Notify(PSTR(<span class="stringliteral">&quot;\r\nLength:\t\t&quot;</span>), 0x80);
<a name="l01201"></a>01201         D_PrintHex&lt;uint8_t &gt; (ep_ptr-&gt;bLength, 0x80);
<a name="l01202"></a>01202         Notify(PSTR(<span class="stringliteral">&quot;\r\nType:\t\t&quot;</span>), 0x80);
<a name="l01203"></a>01203         D_PrintHex&lt;uint8_t &gt; (ep_ptr-&gt;bDescriptorType, 0x80);
<a name="l01204"></a>01204         Notify(PSTR(<span class="stringliteral">&quot;\r\nAddress:\t&quot;</span>), 0x80);
<a name="l01205"></a>01205         D_PrintHex&lt;uint8_t &gt; (ep_ptr-&gt;bEndpointAddress, 0x80);
<a name="l01206"></a>01206         Notify(PSTR(<span class="stringliteral">&quot;\r\nAttributes:\t&quot;</span>), 0x80);
<a name="l01207"></a>01207         D_PrintHex&lt;uint8_t &gt; (ep_ptr-&gt;bmAttributes, 0x80);
<a name="l01208"></a>01208         Notify(PSTR(<span class="stringliteral">&quot;\r\nMaxPktSize:\t&quot;</span>), 0x80);
<a name="l01209"></a>01209         D_PrintHex&lt;uint16_t &gt; (ep_ptr-&gt;wMaxPacketSize, 0x80);
<a name="l01210"></a>01210         Notify(PSTR(<span class="stringliteral">&quot;\r\nPoll Intrv:\t&quot;</span>), 0x80);
<a name="l01211"></a>01211         D_PrintHex&lt;uint8_t &gt; (ep_ptr-&gt;bInterval, 0x80);
<a name="l01212"></a>01212         Notify(PSTR(<span class="stringliteral">&quot;\r\n&quot;</span>), 0x80);
<a name="l01213"></a>01213 }
<a name="l01214"></a>01214 
<a name="l01215"></a>01215 
<a name="l01217"></a>01217 
<a name="l01218"></a>01218 
<a name="l01219"></a>01219 <span class="comment">// misc/to kill/to-do</span>
<a name="l01220"></a>01220 
<a name="l01221"></a>01221 
<a name="l01223"></a>01223 
<a name="l01224"></a>01224 <span class="comment">/* We won&#39;t be needing this... */</span>
<a name="l01225"></a><a class="code" href="class_bulk_only.html#a52f54376dcd7f5baf17718105e8f085d">01225</a> uint8_t <a class="code" href="class_bulk_only.html#a470a8f0ffd6694d9dfc834da5efa627a">BulkOnly::Read</a>(uint8_t lun, uint32_t addr, uint16_t bsize, uint8_t blocks, USBReadParser * prs) {
<a name="l01226"></a>01226 <span class="preprocessor">#if MS_WANT_PARSER</span>
<a name="l01227"></a>01227 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(!<a class="code" href="class_bulk_only.html#a9f9d9b0925a2cb6b2fb8b10e4d581d28">LUNOk</a>[lun]) <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#aec47def0928045fdca474d78db866c39">MASS_ERR_NO_MEDIA</a>;
<a name="l01228"></a>01228         Notify(PSTR(<span class="stringliteral">&quot;\r\nRead (With parser)\r\n&quot;</span>), 0x80);
<a name="l01229"></a>01229         Notify(PSTR(<span class="stringliteral">&quot;---------\r\n&quot;</span>), 0x80);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231         <a class="code" href="struct_command_block_wrapper.html">CommandBlockWrapper</a> cbw = <a class="code" href="masstorage_8h.html#a16bd83701afd2cf52d741ab0b6a7e479">CommandBlockWrapper</a>();
<a name="l01232"></a>01232 
<a name="l01233"></a>01233         cbw.<a class="code" href="struct_command_block_wrapper_base.html#a133ffc8ac9be6ce284f10efece567748">dCBWSignature</a> = <a class="code" href="masstorage_8h.html#a439c9558fff25c40219c0f20244e666d">MASS_CBW_SIGNATURE</a>;
<a name="l01234"></a>01234         cbw.<a class="code" href="struct_command_block_wrapper_base.html#a0898a332eec2d598b80a896ff66d5549">dCBWTag</a> = ++<a class="code" href="class_bulk_only.html#a7ae682d50badd1386a06f30f35a32d1d">dCBWTag</a>;
<a name="l01235"></a>01235         cbw.<a class="code" href="struct_command_block_wrapper_base.html#a62c537797107ada830b86e1f2d629164">dCBWDataTransferLength</a> = ((uint32_t)bsize * blocks);
<a name="l01236"></a>01236         cbw.<a class="code" href="struct_command_block_wrapper_base.html#a396b36ceef993c32f28b1354727a5e9e">bmCBWFlags</a> = <a class="code" href="masstorage_8h.html#a012ee34e4ce8d644c2f75099867b26c0">MASS_CMD_DIR_IN</a>,
<a name="l01237"></a>01237                 cbw.<a class="code" href="struct_command_block_wrapper.html#a2a16bb9a98e3ee4eaac8fea6310b4e01">bmCBWLUN</a> = lun;
<a name="l01238"></a>01238         cbw.<a class="code" href="struct_command_block_wrapper.html#a069c89f584abbf45c13ebb85ca906494">bmCBWCBLength</a> = 10;
<a name="l01239"></a>01239 
<a name="l01240"></a>01240         cbw.<a class="code" href="struct_command_block_wrapper.html#a2f5feafb5e1c993454c1ccd14a17965a">CBWCB</a>[0] = <a class="code" href="masstorage_8h.html#ad3900f141fb70afb8def054384805a2e">SCSI_CMD_READ_10</a>;
<a name="l01241"></a>01241         cbw.<a class="code" href="struct_command_block_wrapper.html#a2f5feafb5e1c993454c1ccd14a17965a">CBWCB</a>[8] = blocks;
<a name="l01242"></a>01242         cbw.<a class="code" href="struct_command_block_wrapper.html#a2f5feafb5e1c993454c1ccd14a17965a">CBWCB</a>[2] = ((addr &gt;&gt; 24) &amp; 0xff);
<a name="l01243"></a>01243         cbw.<a class="code" href="struct_command_block_wrapper.html#a2f5feafb5e1c993454c1ccd14a17965a">CBWCB</a>[3] = ((addr &gt;&gt; 16) &amp; 0xff);
<a name="l01244"></a>01244         cbw.<a class="code" href="struct_command_block_wrapper.html#a2f5feafb5e1c993454c1ccd14a17965a">CBWCB</a>[4] = ((addr &gt;&gt; 8) &amp; 0xff);
<a name="l01245"></a>01245         cbw.<a class="code" href="struct_command_block_wrapper.html#a2f5feafb5e1c993454c1ccd14a17965a">CBWCB</a>[5] = (addr &amp; 0xff);
<a name="l01246"></a>01246 
<a name="l01247"></a>01247         <span class="keywordflow">return</span> HandleSCSIError(Transaction(&amp;cbw, bsize, prs, 1));
<a name="l01248"></a>01248 <span class="preprocessor">#else</span>
<a name="l01249"></a>01249 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="masstorage_8h.html#a4c80ae6c61331a0dd2a1950a25829a85">MASS_ERR_NOT_IMPLEMENTED</a>;
<a name="l01250"></a>01250 <span class="preprocessor">#endif</span>
<a name="l01251"></a>01251 <span class="preprocessor"></span>}
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Fri Jul 11 2014 11:29:24 for ADS1298_BLE_Sensor_Interrupt_Driven by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
