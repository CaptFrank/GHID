<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>GHID Framework: Included Libraries/USB_Host_Shield_2.0-master/Wii.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">GHID Framework
   &#160;<span id="projectnumber">version 2.0</span>
   </div>
   <div id="projectbrief">A Generic human interface device framework</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_wii_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Included Libraries/USB_Host_Shield_2.0-master/Wii.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_wii_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (C) 2012 Kristian Lauszus, TKJ Electronics. All rights reserved.</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment"> This software may be distributed and modified under the terms of the GNU</span>
<a name="l00004"></a>00004 <span class="comment"> General Public License version 2 (GPL2) as published by the Free Software</span>
<a name="l00005"></a>00005 <span class="comment"> Foundation and appearing in the file GPL2.TXT included in the packaging of</span>
<a name="l00006"></a>00006 <span class="comment"> this file. Please note that GPL2 Section 2[b] requires that all works based</span>
<a name="l00007"></a>00007 <span class="comment"> on this software must also be made publicly available under the terms of</span>
<a name="l00008"></a>00008 <span class="comment"> the GPL2 (&quot;Copyleft&quot;).</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment"> Contact information</span>
<a name="l00011"></a>00011 <span class="comment"> -------------------</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment"> Kristian Lauszus, TKJ Electronics</span>
<a name="l00014"></a>00014 <span class="comment"> Web      :  http://www.tkjelectronics.com</span>
<a name="l00015"></a>00015 <span class="comment"> e-mail   :  kristianl@tkjelectronics.com</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment"> IR camera support added by Allan Glover (adglover9.81@gmail.com) and Kristian Lauszus</span>
<a name="l00018"></a>00018 <span class="comment"> */</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="_wii_8h.html">Wii.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="comment">// To enable serial debugging see &quot;settings.h&quot;</span>
<a name="l00022"></a>00022 <span class="comment">//#define EXTRADEBUG // Uncomment to get even more debugging data</span>
<a name="l00023"></a>00023 <span class="comment">//#define PRINTREPORT // Uncomment to print the report send by the Wii controllers</span>
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="_wii_8cpp.html#af5ea8a5a5c056b0c0ea268910f8c5bc0">00025</a> <span class="keyword">const</span> uint8_t WII_LEDS[] <a class="code" href="acm_2acm__terminal_2pgmstrings_8h.html#a3fa5cb2801cd8b7c78af8a465a662564">PROGMEM</a> = {
<a name="l00026"></a>00026         0x00, <span class="comment">// OFF</span>
<a name="l00027"></a>00027         0x10, <span class="comment">// LED1</span>
<a name="l00028"></a>00028         0x20, <span class="comment">// LED2</span>
<a name="l00029"></a>00029         0x40, <span class="comment">// LED3</span>
<a name="l00030"></a>00030         0x80, <span class="comment">// LED4</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032         0x90, <span class="comment">// LED5</span>
<a name="l00033"></a>00033         0xA0, <span class="comment">// LED6</span>
<a name="l00034"></a>00034         0xC0, <span class="comment">// LED7</span>
<a name="l00035"></a>00035         0xD0, <span class="comment">// LED8</span>
<a name="l00036"></a>00036         0xE0, <span class="comment">// LED9</span>
<a name="l00037"></a>00037         0xF0, <span class="comment">// LED10</span>
<a name="l00038"></a>00038 };
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="keyword">const</span> uint32_t WII_BUTTONS[] <a class="code" href="acm_2acm__terminal_2pgmstrings_8h.html#a3fa5cb2801cd8b7c78af8a465a662564">PROGMEM</a> = {
<a name="l00041"></a>00041         0x00008, <span class="comment">// UP</span>
<a name="l00042"></a>00042         0x00002, <span class="comment">// RIGHT</span>
<a name="l00043"></a>00043         0x00004, <span class="comment">// DOWN</span>
<a name="l00044"></a>00044         0x00001, <span class="comment">// LEFT</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046         0, <span class="comment">// Skip</span>
<a name="l00047"></a>00047         0x00010, <span class="comment">// PLUS</span>
<a name="l00048"></a>00048         0x00100, <span class="comment">// TWO</span>
<a name="l00049"></a>00049         0x00200, <span class="comment">// ONE</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051         0x01000, <span class="comment">// MINUS</span>
<a name="l00052"></a>00052         0x08000, <span class="comment">// HOME</span>
<a name="l00053"></a>00053         0x10000, <span class="comment">// Z</span>
<a name="l00054"></a>00054         0x20000, <span class="comment">// C</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056         0x00400, <span class="comment">// B</span>
<a name="l00057"></a>00057         0x00800, <span class="comment">// A</span>
<a name="l00058"></a>00058 };
<a name="l00059"></a>00059 <span class="keyword">const</span> uint32_t WII_PROCONTROLLER_BUTTONS[] <a class="code" href="acm_2acm__terminal_2pgmstrings_8h.html#a3fa5cb2801cd8b7c78af8a465a662564">PROGMEM</a> = {
<a name="l00060"></a>00060         0x00100, <span class="comment">// UP</span>
<a name="l00061"></a>00061         0x00080, <span class="comment">// RIGHT</span>
<a name="l00062"></a>00062         0x00040, <span class="comment">// DOWN</span>
<a name="l00063"></a>00063         0x00200, <span class="comment">// LEFT</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         0, <span class="comment">// Skip</span>
<a name="l00066"></a>00066         0x00004, <span class="comment">// PLUS</span>
<a name="l00067"></a>00067         0x20000, <span class="comment">// L3</span>
<a name="l00068"></a>00068         0x10000, <span class="comment">// R3</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070         0x00010, <span class="comment">// MINUS</span>
<a name="l00071"></a>00071         0x00008, <span class="comment">// HOME</span>
<a name="l00072"></a>00072         0, 0, <span class="comment">// Skip</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074         0x04000, <span class="comment">// B</span>
<a name="l00075"></a>00075         0x01000, <span class="comment">// A</span>
<a name="l00076"></a>00076         0x00800, <span class="comment">// X</span>
<a name="l00077"></a>00077         0x02000, <span class="comment">// Y</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         0x00020, <span class="comment">// L</span>
<a name="l00080"></a>00080         0x00002, <span class="comment">// R</span>
<a name="l00081"></a>00081         0x08000, <span class="comment">// ZL</span>
<a name="l00082"></a>00082         0x00400, <span class="comment">// ZR</span>
<a name="l00083"></a>00083 };
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="class_w_i_i.html#a6597cb0e240a8ccb4ebdb236daef712e">00085</a> <a class="code" href="class_w_i_i.html#a6597cb0e240a8ccb4ebdb236daef712e">WII::WII</a>(<a class="code" href="class_b_t_d.html">BTD</a> *p, <span class="keywordtype">bool</span> pair) :
<a name="l00086"></a>00086 pBtd(p) <span class="comment">// pointer to USB class instance - mandatory</span>
<a name="l00087"></a>00087 {
<a name="l00088"></a>00088         <span class="keywordflow">if</span>(pBtd)
<a name="l00089"></a>00089                 pBtd-&gt;<a class="code" href="class_b_t_d.html#a4adfc7e51ad3b3c03e7c37d1af159e73">registerServiceClass</a>(<span class="keyword">this</span>); <span class="comment">// Register it as a Bluetooth service</span>
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         pBtd-&gt;<a class="code" href="class_b_t_d.html#a0c8cc2a2dd2cda3e760b8b4c1a2d169c">pairWithWii</a> = <a class="code" href="class_w_i_i.html#a39c3101b26cc549d5258018b3d05c608">pair</a>;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         HIDBuffer[0] = 0xA2; <span class="comment">// HID BT DATA_request (0xA0) | Report Type (Output 0x02)</span>
<a name="l00094"></a>00094 
<a name="l00095"></a>00095         <span class="comment">/* Set device cid for the control and intterrupt channelse - LSB */</span>
<a name="l00096"></a>00096         control_dcid[0] = 0x60; <span class="comment">//0x0060</span>
<a name="l00097"></a>00097         control_dcid[1] = 0x00;
<a name="l00098"></a>00098         interrupt_dcid[0] = 0x61; <span class="comment">//0x0061</span>
<a name="l00099"></a>00099         interrupt_dcid[1] = 0x00;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101         <a class="code" href="class_w_i_i.html#a769ee2f9a0088da097438bc3cc677f7c">Reset</a>();
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="class_w_i_i.html#a769ee2f9a0088da097438bc3cc677f7c">00104</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#a769ee2f9a0088da097438bc3cc677f7c">WII::Reset</a>() {
<a name="l00105"></a>00105         <a class="code" href="class_w_i_i.html#ae25a8ea1b0713801e0209e795b4596fa">wiimoteConnected</a> = <span class="keyword">false</span>;
<a name="l00106"></a>00106         <a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a> = <span class="keyword">false</span>;
<a name="l00107"></a>00107         <a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a> = <span class="keyword">false</span>;
<a name="l00108"></a>00108         activateNunchuck = <span class="keyword">false</span>;
<a name="l00109"></a>00109         motionValuesReset = <span class="keyword">false</span>;
<a name="l00110"></a>00110         activeConnection = <span class="keyword">false</span>;
<a name="l00111"></a>00111         motionPlusInside = <span class="keyword">false</span>;
<a name="l00112"></a>00112         pBtd-&gt;<a class="code" href="class_b_t_d.html#a962a5714c225dcb633434f02e3657583">wiiUProController</a> = <span class="keyword">false</span>;
<a name="l00113"></a>00113         <a class="code" href="class_w_i_i.html#a461f5b7a5f2bc874e107fc776c284b16">wiiUProControllerConnected</a> = <span class="keyword">false</span>;
<a name="l00114"></a>00114         l2cap_event_flag = 0; <span class="comment">// Reset flags</span>
<a name="l00115"></a>00115         l2cap_state = <a class="code" href="_b_t_d_8h.html#a15cc1db556ad9a4ec6144ca8a42f8919">L2CAP_WAIT</a>;
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="class_w_i_i.html#aabe4780f258dada1c0564a4ac7607370">00118</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#aabe4780f258dada1c0564a4ac7607370">WII::disconnect</a>() { <span class="comment">// Use this void to disconnect any of the controllers</span>
<a name="l00119"></a>00119         <span class="keywordflow">if</span>(!motionPlusInside) { <span class="comment">// The old Wiimote needs a delay after the first command or it will automatically reconnect</span>
<a name="l00120"></a>00120                 <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a>) {
<a name="l00121"></a>00121 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>                        Notify(PSTR(<span class="stringliteral">&quot;\r\nDeactivating Motion Plus&quot;</span>), 0x80);
<a name="l00123"></a>00123 <span class="preprocessor">#endif</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>                        initExtension1(); <span class="comment">// This will disable the Motion Plus extension</span>
<a name="l00125"></a>00125                 }
<a name="l00126"></a>00126                 timer = millis() + 1000; <span class="comment">// We have to wait for the message before the rest of the channels can be deactivated</span>
<a name="l00127"></a>00127         } <span class="keywordflow">else</span>
<a name="l00128"></a>00128                 timer = millis(); <span class="comment">// Don&#39;t wait</span>
<a name="l00129"></a>00129         <span class="comment">// First the HID interrupt channel has to be disconnected, then the HID control channel and finally the HCI connection</span>
<a name="l00130"></a>00130         pBtd-&gt;<a class="code" href="class_b_t_d.html#ac7053ef7ac690be3afbbdd985b163f10">l2cap_disconnection_request</a>(hci_handle, ++identifier, interrupt_scid, interrupt_dcid);
<a name="l00131"></a>00131         <a class="code" href="class_w_i_i.html#a769ee2f9a0088da097438bc3cc677f7c">Reset</a>();
<a name="l00132"></a>00132         l2cap_state = <a class="code" href="_b_t_d_8h.html#ab569b2085ad29f41d1da9c0ed352bd65">L2CAP_INTERRUPT_DISCONNECT</a>;
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a><a class="code" href="class_w_i_i.html#a81e1eb4d9ef9999a84e71d764d54dff7">00135</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#a81e1eb4d9ef9999a84e71d764d54dff7">WII::ACLData</a>(uint8_t* l2capinbuf) {
<a name="l00136"></a>00136         <span class="keywordflow">if</span>(!pBtd-&gt;<a class="code" href="class_b_t_d.html#a0f1c28a03bcbe62cc7c083f97ea27594">l2capConnectionClaimed</a> &amp;&amp; pBtd-&gt;<a class="code" href="class_b_t_d.html#a4dc8f94fe85028f3d54f13dde1e5b4ee">incomingWii</a> &amp;&amp; !<a class="code" href="class_w_i_i.html#ae25a8ea1b0713801e0209e795b4596fa">wiimoteConnected</a> &amp;&amp; !activeConnection) {
<a name="l00137"></a>00137                 <span class="keywordflow">if</span>(l2capinbuf[8] == <a class="code" href="_b_t_d_8h.html#ac4bae0c65fd00ed849cb226302d19c85">L2CAP_CMD_CONNECTION_REQUEST</a>) {
<a name="l00138"></a>00138                         <span class="keywordflow">if</span>((l2capinbuf[12] | (l2capinbuf[13] &lt;&lt; 8)) == <a class="code" href="_b_t_d_8h.html#a1465673868452307bcdab8e201430c27">HID_CTRL_PSM</a>) {
<a name="l00139"></a>00139                                 motionPlusInside = pBtd-&gt;<a class="code" href="class_b_t_d.html#a3aea445b2349e99ef057db1a4ffdd9dc">motionPlusInside</a>;
<a name="l00140"></a>00140                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#a4dc8f94fe85028f3d54f13dde1e5b4ee">incomingWii</a> = <span class="keyword">false</span>;
<a name="l00141"></a>00141                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#a0f1c28a03bcbe62cc7c083f97ea27594">l2capConnectionClaimed</a> = <span class="keyword">true</span>; <span class="comment">// Claim that the incoming connection belongs to this service</span>
<a name="l00142"></a>00142                                 activeConnection = <span class="keyword">true</span>;
<a name="l00143"></a>00143                                 hci_handle = pBtd-&gt;<a class="code" href="class_b_t_d.html#aa3bb6c692701cb33dfad1ea4d68b6f98">hci_handle</a>; <span class="comment">// Store the HCI Handle for the connection</span>
<a name="l00144"></a>00144                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a15cc1db556ad9a4ec6144ca8a42f8919">L2CAP_WAIT</a>;
<a name="l00145"></a>00145                         }
<a name="l00146"></a>00146                 }
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148         <span class="comment">//if((l2capinbuf[0] | (uint16_t)l2capinbuf[1] &lt;&lt; 8) == (hci_handle | 0x2000U)) { // acl_handle_ok or it&#39;s a new connection</span>
<a name="l00149"></a>00149         <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a3aa6623f7fa8839754d3deefa6d60372">UHS_ACL_HANDLE_OK</a>(l2capinbuf, hci_handle)) { <span class="comment">// acl_handle_ok or it&#39;s a new connection</span>
<a name="l00150"></a>00150                 <span class="keywordflow">if</span>((l2capinbuf[6] | (l2capinbuf[7] &lt;&lt; 8)) == 0x0001U) { <span class="comment">//l2cap_control - Channel ID for ACL-U</span>
<a name="l00151"></a>00151                         <span class="keywordflow">if</span>(l2capinbuf[8] == <a class="code" href="_b_t_d_8h.html#a6ffcd72787c86f248192eb06a3fe18cb">L2CAP_CMD_COMMAND_REJECT</a>) {
<a name="l00152"></a>00152 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nL2CAP Command Rejected - Reason: &quot;</span>), 0x80);
<a name="l00154"></a>00154                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[13], 0x80);
<a name="l00155"></a>00155                                 Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l00156"></a>00156                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[12], 0x80);
<a name="l00157"></a>00157                                 Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l00158"></a>00158                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[17], 0x80);
<a name="l00159"></a>00159                                 Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l00160"></a>00160                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[16], 0x80);
<a name="l00161"></a>00161                                 Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l00162"></a>00162                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[15], 0x80);
<a name="l00163"></a>00163                                 Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l00164"></a>00164                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[14], 0x80);
<a name="l00165"></a>00165 <span class="preprocessor">#endif</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[8] == <a class="code" href="_b_t_d_8h.html#aef7b306479de265d725dbe5816a8227b">L2CAP_CMD_CONNECTION_RESPONSE</a>) {
<a name="l00167"></a>00167                                 <span class="keywordflow">if</span>(((l2capinbuf[16] | (l2capinbuf[17] &lt;&lt; 8)) == 0x0000) &amp;&amp; ((l2capinbuf[18] | (l2capinbuf[19] &lt;&lt; 8)) == <a class="code" href="_b_t_d_8h.html#a1be7a56cdddcdb7dedf16d4dee381e93">SUCCESSFUL</a>)) { <span class="comment">// Success</span>
<a name="l00168"></a>00168                                         <span class="keywordflow">if</span>(l2capinbuf[14] == control_dcid[0] &amp;&amp; l2capinbuf[15] == control_dcid[1]) {
<a name="l00169"></a>00169                                                 <span class="comment">//Notify(PSTR(&quot;\r\nHID Control Connection Complete&quot;), 0x80);</span>
<a name="l00170"></a>00170                                                 identifier = l2capinbuf[9];
<a name="l00171"></a>00171                                                 control_scid[0] = l2capinbuf[12];
<a name="l00172"></a>00172                                                 control_scid[1] = l2capinbuf[13];
<a name="l00173"></a>00173                                                 <a class="code" href="_b_t_d_8h.html#a5f035450f226204f021e69ad1faa2e3a">l2cap_set_flag</a>(<a class="code" href="_b_t_d_8h.html#a2e5a9c283f0912833f3e0418d3feadd7">L2CAP_FLAG_CONTROL_CONNECTED</a>);
<a name="l00174"></a>00174                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[14] == interrupt_dcid[0] &amp;&amp; l2capinbuf[15] == interrupt_dcid[1]) {
<a name="l00175"></a>00175                                                 <span class="comment">//Notify(PSTR(&quot;\r\nHID Interrupt Connection Complete&quot;), 0x80);</span>
<a name="l00176"></a>00176                                                 identifier = l2capinbuf[9];
<a name="l00177"></a>00177                                                 interrupt_scid[0] = l2capinbuf[12];
<a name="l00178"></a>00178                                                 interrupt_scid[1] = l2capinbuf[13];
<a name="l00179"></a>00179                                                 <a class="code" href="_b_t_d_8h.html#a5f035450f226204f021e69ad1faa2e3a">l2cap_set_flag</a>(<a class="code" href="_b_t_d_8h.html#aad823543553cc7500ac49d7479eb858f">L2CAP_FLAG_INTERRUPT_CONNECTED</a>);
<a name="l00180"></a>00180                                         }
<a name="l00181"></a>00181                                 }
<a name="l00182"></a>00182                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[8] == <a class="code" href="_b_t_d_8h.html#ac4bae0c65fd00ed849cb226302d19c85">L2CAP_CMD_CONNECTION_REQUEST</a>) {
<a name="l00183"></a>00183 <span class="preprocessor">#ifdef EXTRADEBUG</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nL2CAP Connection Request - PSM: &quot;</span>), 0x80);
<a name="l00185"></a>00185                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[13], 0x80);
<a name="l00186"></a>00186                                 Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l00187"></a>00187                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[12], 0x80);
<a name="l00188"></a>00188                                 Notify(PSTR(<span class="stringliteral">&quot; SCID: &quot;</span>), 0x80);
<a name="l00189"></a>00189                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[15], 0x80);
<a name="l00190"></a>00190                                 Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l00191"></a>00191                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[14], 0x80);
<a name="l00192"></a>00192                                 Notify(PSTR(<span class="stringliteral">&quot; Identifier: &quot;</span>), 0x80);
<a name="l00193"></a>00193                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[9], 0x80);
<a name="l00194"></a>00194 <span class="preprocessor">#endif</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>                                <span class="keywordflow">if</span>((l2capinbuf[12] | (l2capinbuf[13] &lt;&lt; 8)) == <a class="code" href="_b_t_d_8h.html#a1465673868452307bcdab8e201430c27">HID_CTRL_PSM</a>) {
<a name="l00196"></a>00196                                         identifier = l2capinbuf[9];
<a name="l00197"></a>00197                                         control_scid[0] = l2capinbuf[14];
<a name="l00198"></a>00198                                         control_scid[1] = l2capinbuf[15];
<a name="l00199"></a>00199                                         <a class="code" href="_b_t_d_8h.html#a5f035450f226204f021e69ad1faa2e3a">l2cap_set_flag</a>(<a class="code" href="_b_t_d_8h.html#a969a1ee84797f3ee5006c41f67373f96">L2CAP_FLAG_CONNECTION_CONTROL_REQUEST</a>);
<a name="l00200"></a>00200                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((l2capinbuf[12] | (l2capinbuf[13] &lt;&lt; 8)) == <a class="code" href="_b_t_d_8h.html#a4c5ac96db74d61d4a5a5d945a400e7da">HID_INTR_PSM</a>) {
<a name="l00201"></a>00201                                         identifier = l2capinbuf[9];
<a name="l00202"></a>00202                                         interrupt_scid[0] = l2capinbuf[14];
<a name="l00203"></a>00203                                         interrupt_scid[1] = l2capinbuf[15];
<a name="l00204"></a>00204                                         <a class="code" href="_b_t_d_8h.html#a5f035450f226204f021e69ad1faa2e3a">l2cap_set_flag</a>(<a class="code" href="_b_t_d_8h.html#a015f3b25bd7a2908c84b973dec453f45">L2CAP_FLAG_CONNECTION_INTERRUPT_REQUEST</a>);
<a name="l00205"></a>00205                                 }
<a name="l00206"></a>00206                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[8] == <a class="code" href="_b_t_d_8h.html#a8151b1fe5d940a5a7a34f43a8b8ce434">L2CAP_CMD_CONFIG_RESPONSE</a>) {
<a name="l00207"></a>00207                                 <span class="keywordflow">if</span>((l2capinbuf[16] | (l2capinbuf[17] &lt;&lt; 8)) == 0x0000) { <span class="comment">// Success</span>
<a name="l00208"></a>00208                                         <span class="keywordflow">if</span>(l2capinbuf[12] == control_dcid[0] &amp;&amp; l2capinbuf[13] == control_dcid[1]) {
<a name="l00209"></a>00209                                                 <span class="comment">//Notify(PSTR(&quot;\r\nHID Control Configuration Complete&quot;), 0x80);</span>
<a name="l00210"></a>00210                                                 identifier = l2capinbuf[9];
<a name="l00211"></a>00211                                                 <a class="code" href="_b_t_d_8h.html#a5f035450f226204f021e69ad1faa2e3a">l2cap_set_flag</a>(<a class="code" href="_b_t_d_8h.html#a0c444d5d06ec604820d426556c2f38d7">L2CAP_FLAG_CONFIG_CONTROL_SUCCESS</a>);
<a name="l00212"></a>00212                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[12] == interrupt_dcid[0] &amp;&amp; l2capinbuf[13] == interrupt_dcid[1]) {
<a name="l00213"></a>00213                                                 <span class="comment">//Notify(PSTR(&quot;\r\nHID Interrupt Configuration Complete&quot;), 0x80);</span>
<a name="l00214"></a>00214                                                 identifier = l2capinbuf[9];
<a name="l00215"></a>00215                                                 <a class="code" href="_b_t_d_8h.html#a5f035450f226204f021e69ad1faa2e3a">l2cap_set_flag</a>(<a class="code" href="_b_t_d_8h.html#a2b3cdcd3124251a40ce825da0d8dcb6f">L2CAP_FLAG_CONFIG_INTERRUPT_SUCCESS</a>);
<a name="l00216"></a>00216                                         }
<a name="l00217"></a>00217                                 }
<a name="l00218"></a>00218                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[8] == <a class="code" href="_b_t_d_8h.html#a48bcd73461d736d0ef889e1fe6e36f69">L2CAP_CMD_CONFIG_REQUEST</a>) {
<a name="l00219"></a>00219                                 <span class="keywordflow">if</span>(l2capinbuf[12] == control_dcid[0] &amp;&amp; l2capinbuf[13] == control_dcid[1]) {
<a name="l00220"></a>00220                                         <span class="comment">//Notify(PSTR(&quot;\r\nHID Control Configuration Request&quot;), 0x80);</span>
<a name="l00221"></a>00221                                         pBtd-&gt;<a class="code" href="class_b_t_d.html#a792ac4529b65235698ecf3d37982c05e">l2cap_config_response</a>(hci_handle, l2capinbuf[9], control_scid);
<a name="l00222"></a>00222                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[12] == interrupt_dcid[0] &amp;&amp; l2capinbuf[13] == interrupt_dcid[1]) {
<a name="l00223"></a>00223                                         <span class="comment">//Notify(PSTR(&quot;\r\nHID Interrupt Configuration Request&quot;), 0x80);</span>
<a name="l00224"></a>00224                                         pBtd-&gt;<a class="code" href="class_b_t_d.html#a792ac4529b65235698ecf3d37982c05e">l2cap_config_response</a>(hci_handle, l2capinbuf[9], interrupt_scid);
<a name="l00225"></a>00225                                 }
<a name="l00226"></a>00226                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[8] == <a class="code" href="_b_t_d_8h.html#a398676a2e9a2351a5a52afdddf4b660b">L2CAP_CMD_DISCONNECT_REQUEST</a>) {
<a name="l00227"></a>00227                                 <span class="keywordflow">if</span>(l2capinbuf[12] == control_dcid[0] &amp;&amp; l2capinbuf[13] == control_dcid[1]) {
<a name="l00228"></a>00228 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>                                        Notify(PSTR(<span class="stringliteral">&quot;\r\nDisconnect Request: Control Channel&quot;</span>), 0x80);
<a name="l00230"></a>00230 <span class="preprocessor">#endif</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>                                        identifier = l2capinbuf[9];
<a name="l00232"></a>00232                                         pBtd-&gt;<a class="code" href="class_b_t_d.html#a29d176d9194e5c92fbe54791fc245407">l2cap_disconnection_response</a>(hci_handle, identifier, control_dcid, control_scid);
<a name="l00233"></a>00233                                         <a class="code" href="class_w_i_i.html#a769ee2f9a0088da097438bc3cc677f7c">Reset</a>();
<a name="l00234"></a>00234                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[12] == interrupt_dcid[0] &amp;&amp; l2capinbuf[13] == interrupt_dcid[1]) {
<a name="l00235"></a>00235 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span>                                        Notify(PSTR(<span class="stringliteral">&quot;\r\nDisconnect Request: Interrupt Channel&quot;</span>), 0x80);
<a name="l00237"></a>00237 <span class="preprocessor">#endif</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span>                                        identifier = l2capinbuf[9];
<a name="l00239"></a>00239                                         pBtd-&gt;<a class="code" href="class_b_t_d.html#a29d176d9194e5c92fbe54791fc245407">l2cap_disconnection_response</a>(hci_handle, identifier, interrupt_dcid, interrupt_scid);
<a name="l00240"></a>00240                                         <a class="code" href="class_w_i_i.html#a769ee2f9a0088da097438bc3cc677f7c">Reset</a>();
<a name="l00241"></a>00241                                 }
<a name="l00242"></a>00242                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[8] == <a class="code" href="_b_t_d_8h.html#a4c64a41200714e457b397496183dc0e4">L2CAP_CMD_DISCONNECT_RESPONSE</a>) {
<a name="l00243"></a>00243                                 <span class="keywordflow">if</span>(l2capinbuf[12] == control_scid[0] &amp;&amp; l2capinbuf[13] == control_scid[1]) {
<a name="l00244"></a>00244                                         <span class="comment">//Notify(PSTR(&quot;\r\nDisconnect Response: Control Channel&quot;), 0x80);</span>
<a name="l00245"></a>00245                                         identifier = l2capinbuf[9];
<a name="l00246"></a>00246                                         <a class="code" href="_b_t_d_8h.html#a5f035450f226204f021e69ad1faa2e3a">l2cap_set_flag</a>(<a class="code" href="_b_t_d_8h.html#a27057737ae0b2246442511c01eeed192">L2CAP_FLAG_DISCONNECT_CONTROL_RESPONSE</a>);
<a name="l00247"></a>00247                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[12] == interrupt_scid[0] &amp;&amp; l2capinbuf[13] == interrupt_scid[1]) {
<a name="l00248"></a>00248                                         <span class="comment">//Notify(PSTR(&quot;\r\nDisconnect Response: Interrupt Channel&quot;), 0x80);</span>
<a name="l00249"></a>00249                                         identifier = l2capinbuf[9];
<a name="l00250"></a>00250                                         <a class="code" href="_b_t_d_8h.html#a5f035450f226204f021e69ad1faa2e3a">l2cap_set_flag</a>(<a class="code" href="_b_t_d_8h.html#acc096a05301f3cbdece4ad372cc149c3">L2CAP_FLAG_DISCONNECT_INTERRUPT_RESPONSE</a>);
<a name="l00251"></a>00251                                 }
<a name="l00252"></a>00252                         }
<a name="l00253"></a>00253 <span class="preprocessor">#ifdef EXTRADEBUG</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span>                        <span class="keywordflow">else</span> {
<a name="l00255"></a>00255                                 identifier = l2capinbuf[9];
<a name="l00256"></a>00256                                 Notify(PSTR(<span class="stringliteral">&quot;\r\nL2CAP Unknown Signaling Command: &quot;</span>), 0x80);
<a name="l00257"></a>00257                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[8], 0x80);
<a name="l00258"></a>00258                         }
<a name="l00259"></a>00259 <span class="preprocessor">#endif</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span>                } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[6] == interrupt_dcid[0] &amp;&amp; l2capinbuf[7] == interrupt_dcid[1]) { <span class="comment">// l2cap_interrupt</span>
<a name="l00261"></a>00261                         <span class="comment">//Notify(PSTR(&quot;\r\nL2CAP Interrupt&quot;), 0x80);</span>
<a name="l00262"></a>00262                         <span class="keywordflow">if</span>(l2capinbuf[8] == 0xA1) { <span class="comment">// HID_THDR_DATA_INPUT</span>
<a name="l00263"></a>00263                                 <span class="keywordflow">if</span>((l2capinbuf[9] &gt;= 0x20 &amp;&amp; l2capinbuf[9] &lt;= 0x22) || (l2capinbuf[9] &gt;= 0x30 &amp;&amp; l2capinbuf[9] &lt;= 0x37) || l2capinbuf[9] == 0x3e || l2capinbuf[9] == 0x3f) { <span class="comment">// These reports include the buttons</span>
<a name="l00264"></a>00264                                         <span class="keywordflow">if</span>((l2capinbuf[9] &gt;= 0x20 &amp;&amp; l2capinbuf[9] &lt;= 0x22) || l2capinbuf[9] == 0x31 || l2capinbuf[9] == 0x33) <span class="comment">// These reports have no extensions bytes</span>
<a name="l00265"></a>00265                                                 ButtonState = (uint32_t)((l2capinbuf[10] &amp; 0x1F) | ((uint16_t)(l2capinbuf[11] &amp; 0x9F) &lt;&lt; 8));
<a name="l00266"></a>00266                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a461f5b7a5f2bc874e107fc776c284b16">wiiUProControllerConnected</a>)
<a name="l00267"></a>00267                                                 ButtonState = (uint32_t)(((~l2capinbuf[23]) &amp; 0xFE) | ((uint16_t)(~l2capinbuf[24]) &lt;&lt; 8) | ((uint32_t)((~l2capinbuf[25]) &amp; 0x03) &lt;&lt; 16));
<a name="l00268"></a>00268                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a>) {
<a name="l00269"></a>00269                                                 <span class="keywordflow">if</span>(l2capinbuf[20] &amp; 0x02) <span class="comment">// Only update the wiimote buttons, since the extension bytes are from the Motion Plus</span>
<a name="l00270"></a>00270                                                         ButtonState = (uint32_t)((l2capinbuf[10] &amp; 0x1F) | ((uint16_t)(l2capinbuf[11] &amp; 0x9F) &lt;&lt; 8) | ((uint32_t)(ButtonState &amp; 0xFFFF0000)));
<a name="l00271"></a>00271                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a>) <span class="comment">// Update if it&#39;s a report from the Nunchuck</span>
<a name="l00272"></a>00272                                                         ButtonState = (uint32_t)((l2capinbuf[10] &amp; 0x1F) | ((uint16_t)(l2capinbuf[11] &amp; 0x9F) &lt;&lt; 8) | ((uint32_t)((~l2capinbuf[20]) &amp; 0x0C) &lt;&lt; 14));
<a name="l00273"></a>00273                                                 <span class="comment">//else if(classicControllerConnected) // Update if it&#39;s a report from the Classic Controller</span>
<a name="l00274"></a>00274                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a>) <span class="comment">// The Nunchuck is directly connected</span>
<a name="l00275"></a>00275                                                 ButtonState = (uint32_t)((l2capinbuf[10] &amp; 0x1F) | ((uint16_t)(l2capinbuf[11] &amp; 0x9F) &lt;&lt; 8) | ((uint32_t)((~l2capinbuf[20]) &amp; 0x03) &lt;&lt; 16));
<a name="l00276"></a>00276                                                 <span class="comment">//else if(classicControllerConnected) // The Classic Controller is directly connected</span>
<a name="l00277"></a>00277                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!unknownExtensionConnected)
<a name="l00278"></a>00278                                                 ButtonState = (uint32_t)((l2capinbuf[10] &amp; 0x1F) | ((uint16_t)(l2capinbuf[11] &amp; 0x9F) &lt;&lt; 8));
<a name="l00279"></a>00279 <span class="preprocessor">#ifdef PRINTREPORT</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span>                                        Notify(PSTR(<span class="stringliteral">&quot;ButtonState: &quot;</span>), 0x80);
<a name="l00281"></a>00281                                         D_PrintHex&lt;uint32_t &gt; (ButtonState, 0x80);
<a name="l00282"></a>00282                                         Notify(PSTR(<span class="stringliteral">&quot;\r\n&quot;</span>), 0x80);
<a name="l00283"></a>00283 <span class="preprocessor">#endif</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>                                        <span class="keywordflow">if</span>(ButtonState != OldButtonState) {
<a name="l00285"></a>00285                                                 ButtonClickState = ButtonState &amp; ~OldButtonState; <span class="comment">// Update click state variable</span>
<a name="l00286"></a>00286                                                 OldButtonState = ButtonState;
<a name="l00287"></a>00287                                         }
<a name="l00288"></a>00288                                 }
<a name="l00289"></a>00289                                 <span class="keywordflow">if</span>(l2capinbuf[9] == 0x31 || l2capinbuf[9] == 0x33 || l2capinbuf[9] == 0x35 || l2capinbuf[9] == 0x37) { <span class="comment">// Read the accelerometer</span>
<a name="l00290"></a>00290                                         <a class="code" href="class_w_i_i.html#afaafee11ac191ba43b6a2b989cdd137c">accXwiimote</a> = ((l2capinbuf[12] &lt;&lt; 2) | (l2capinbuf[10] &amp; 0x60 &gt;&gt; 5)) - 500;
<a name="l00291"></a>00291                                         <a class="code" href="class_w_i_i.html#aa2c14275d9e482e6add06cb34ccf1197">accYwiimote</a> = ((l2capinbuf[13] &lt;&lt; 2) | (l2capinbuf[11] &amp; 0x20 &gt;&gt; 4)) - 500;
<a name="l00292"></a>00292                                         <a class="code" href="class_w_i_i.html#acdebdaab544ffcecf8ab09adacbd28c8">accZwiimote</a> = ((l2capinbuf[14] &lt;&lt; 2) | (l2capinbuf[11] &amp; 0x40 &gt;&gt; 5)) - 500;
<a name="l00293"></a>00293                                 }
<a name="l00294"></a>00294                                 <span class="keywordflow">switch</span>(l2capinbuf[9]) {
<a name="l00295"></a>00295                                         <span class="keywordflow">case</span> 0x20: <span class="comment">// Status Information - (a1) 20 BB BB LF 00 00 VV</span>
<a name="l00296"></a>00296 <span class="preprocessor">#ifdef EXTRADEBUG</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nStatus report was received&quot;</span>), 0x80);
<a name="l00298"></a>00298 <span class="preprocessor">#endif</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span>                                                wiiState = l2capinbuf[12]; <span class="comment">// (0x01: Battery is nearly empty), (0x02:  An Extension Controller is connected), (0x04: Speaker enabled), (0x08: IR enabled), (0x10: LED1, 0x20: LED2, 0x40: LED3, 0x80: LED4)</span>
<a name="l00300"></a>00300                                                 batteryLevel = l2capinbuf[15]; <span class="comment">// Update battery level</span>
<a name="l00301"></a>00301 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>                                                <span class="keywordflow">if</span>(l2capinbuf[12] &amp; 0x01)
<a name="l00303"></a>00303                                                         Notify(PSTR(<span class="stringliteral">&quot;\r\nWARNING: Battery is nearly empty&quot;</span>), 0x80);
<a name="l00304"></a>00304 <span class="preprocessor">#endif</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>                                                <span class="keywordflow">if</span>(checkExtension) { <span class="comment">// If this is false it means that the user must have called getBatteryLevel()</span>
<a name="l00306"></a>00306                                                         <span class="keywordflow">if</span>(l2capinbuf[12] &amp; 0x02) { <span class="comment">// Check if a extension is connected</span>
<a name="l00307"></a>00307 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>                                                                <span class="keywordflow">if</span>(!unknownExtensionConnected)
<a name="l00309"></a>00309                                                                         Notify(PSTR(<span class="stringliteral">&quot;\r\nExtension connected&quot;</span>), 0x80);
<a name="l00310"></a>00310 <span class="preprocessor">#endif</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span>                                                                unknownExtensionConnected = <span class="keyword">true</span>;
<a name="l00312"></a>00312 <span class="preprocessor">#ifdef WIICAMERA</span>
<a name="l00313"></a>00313 <span class="preprocessor"></span>                                                                <span class="keywordflow">if</span>(!isIRCameraEnabled()) <span class="comment">// Don&#39;t activate the Motion Plus if we are trying to initialize the IR camera</span>
<a name="l00314"></a>00314 <span class="preprocessor">#endif</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span>                                                                        setReportMode(<span class="keyword">false</span>, 0x35); <span class="comment">// Also read the extension</span>
<a name="l00316"></a>00316                                                         } <span class="keywordflow">else</span> {
<a name="l00317"></a>00317 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00318"></a>00318 <span class="preprocessor"></span>                                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nExtension disconnected&quot;</span>), 0x80);
<a name="l00319"></a>00319 <span class="preprocessor">#endif</span>
<a name="l00320"></a>00320 <span class="preprocessor"></span>                                                                <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a>) {
<a name="l00321"></a>00321 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00322"></a>00322 <span class="preprocessor"></span>                                                                        Notify(PSTR(<span class="stringliteral">&quot; - from Motion Plus&quot;</span>), 0x80);
<a name="l00323"></a>00323 <span class="preprocessor">#endif</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>                                                                        <a class="code" href="_wii_8h.html#ac88349598e4482a310450e34af9b7ce3">wii_clear_flag</a>(<a class="code" href="_wii_8h.html#ae0ff99c8862a05df8877329982e1ef61">WII_FLAG_NUNCHUCK_CONNECTED</a>);
<a name="l00325"></a>00325                                                                         <span class="keywordflow">if</span>(!activateNunchuck) <span class="comment">// If it&#39;s already trying to initialize the Nunchuck don&#39;t set it to false</span>
<a name="l00326"></a>00326                                                                                 <a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a> = <span class="keyword">false</span>;
<a name="l00327"></a>00327                                                                         <span class="comment">//else if(classicControllerConnected)</span>
<a name="l00328"></a>00328                                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a>) {
<a name="l00329"></a>00329 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>                                                                        Notify(PSTR(<span class="stringliteral">&quot; - Nunchuck&quot;</span>), 0x80);
<a name="l00331"></a>00331 <span class="preprocessor">#endif</span>
<a name="l00332"></a>00332 <span class="preprocessor"></span>                                                                        <a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a> = <span class="keyword">false</span>; <span class="comment">// It must be the Nunchuck controller then</span>
<a name="l00333"></a>00333                                                                         <a class="code" href="_wii_8h.html#ac88349598e4482a310450e34af9b7ce3">wii_clear_flag</a>(<a class="code" href="_wii_8h.html#ae0ff99c8862a05df8877329982e1ef61">WII_FLAG_NUNCHUCK_CONNECTED</a>);
<a name="l00334"></a>00334                                                                         onInit();
<a name="l00335"></a>00335                                                                         setReportMode(<span class="keyword">false</span>, 0x31); <span class="comment">// If there is no extension connected we will read the buttons and accelerometer</span>
<a name="l00336"></a>00336                                                                 } <span class="keywordflow">else</span>
<a name="l00337"></a>00337                                                                         setReportMode(<span class="keyword">false</span>, 0x31); <span class="comment">// If there is no extension connected we will read the buttons and accelerometer</span>
<a name="l00338"></a>00338                                                         }
<a name="l00339"></a>00339                                                 } <span class="keywordflow">else</span>
<a name="l00340"></a>00340                                                         checkExtension = <span class="keyword">true</span>; <span class="comment">// Check for extensions by default</span>
<a name="l00341"></a>00341                                                 <span class="keywordflow">break</span>;
<a name="l00342"></a>00342                                         <span class="keywordflow">case</span> 0x21: <span class="comment">// Read Memory Data</span>
<a name="l00343"></a>00343                                                 <span class="keywordflow">if</span>((l2capinbuf[12] &amp; 0x0F) == 0) { <span class="comment">// No error</span>
<a name="l00344"></a>00344                                                         <span class="comment">// See: http://wiibrew.org/wiki/Wiimote/Extension_Controllers</span>
<a name="l00345"></a>00345                                                         <span class="keywordflow">if</span>(l2capinbuf[16] == 0x00 &amp;&amp; l2capinbuf[17] == 0xA4 &amp;&amp; l2capinbuf[18] == 0x20 &amp;&amp; l2capinbuf[19] == 0x00 &amp;&amp; l2capinbuf[20] == 0x00) {
<a name="l00346"></a>00346 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span>                                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nNunchuck connected&quot;</span>), 0x80);
<a name="l00348"></a>00348 <span class="preprocessor">#endif</span>
<a name="l00349"></a>00349 <span class="preprocessor"></span>                                                                <a class="code" href="_wii_8h.html#ae72da8cfcaaad9b910ff14e08b72f60d">wii_set_flag</a>(<a class="code" href="_wii_8h.html#ae0ff99c8862a05df8877329982e1ef61">WII_FLAG_NUNCHUCK_CONNECTED</a>);
<a name="l00350"></a>00350                                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[16] == 0x00 &amp;&amp; (l2capinbuf[17] == 0xA6 || l2capinbuf[17] == 0xA4) &amp;&amp; l2capinbuf[18] == 0x20 &amp;&amp; l2capinbuf[19] == 0x00 &amp;&amp; l2capinbuf[20] == 0x05) {
<a name="l00351"></a>00351 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00352"></a>00352 <span class="preprocessor"></span>                                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nMotion Plus connected&quot;</span>), 0x80);
<a name="l00353"></a>00353 <span class="preprocessor">#endif</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span>                                                                <a class="code" href="_wii_8h.html#ae72da8cfcaaad9b910ff14e08b72f60d">wii_set_flag</a>(<a class="code" href="_wii_8h.html#a34631633d4557244dc8eda52e8505acd">WII_FLAG_MOTION_PLUS_CONNECTED</a>);
<a name="l00355"></a>00355                                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[16] == 0x00 &amp;&amp; l2capinbuf[17] == 0xA4 &amp;&amp; l2capinbuf[18] == 0x20 &amp;&amp; l2capinbuf[19] == 0x04 &amp;&amp; l2capinbuf[20] == 0x05) {
<a name="l00356"></a>00356 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00357"></a>00357 <span class="preprocessor"></span>                                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nMotion Plus activated in normal mode&quot;</span>), 0x80);
<a name="l00358"></a>00358 <span class="preprocessor">#endif</span>
<a name="l00359"></a>00359 <span class="preprocessor"></span>                                                                <a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a> = <span class="keyword">true</span>;
<a name="l00360"></a>00360 <span class="preprocessor">#ifdef WIICAMERA</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span>                                                                <span class="keywordflow">if</span>(!isIRCameraEnabled()) <span class="comment">// Don&#39;t activate the Motion Plus if we are trying to initialize the IR camera</span>
<a name="l00362"></a>00362 <span class="preprocessor">#endif</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span>                                                                        setReportMode(<span class="keyword">false</span>, 0x35); <span class="comment">// Also read the extension</span>
<a name="l00364"></a>00364                                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[16] == 0x00 &amp;&amp; l2capinbuf[17] == 0xA4 &amp;&amp; l2capinbuf[18] == 0x20 &amp;&amp; l2capinbuf[19] == 0x05 &amp;&amp; l2capinbuf[20] == 0x05) {
<a name="l00365"></a>00365 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>                                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nMotion Plus activated in Nunchuck pass-through mode&quot;</span>), 0x80);
<a name="l00367"></a>00367 <span class="preprocessor">#endif</span>
<a name="l00368"></a>00368 <span class="preprocessor"></span>                                                                activateNunchuck = <span class="keyword">false</span>;
<a name="l00369"></a>00369                                                                 <a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a> = <span class="keyword">true</span>;
<a name="l00370"></a>00370                                                                 <a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a> = <span class="keyword">true</span>;
<a name="l00371"></a>00371 <span class="preprocessor">#ifdef WIICAMERA</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span>                                                                <span class="keywordflow">if</span>(!isIRCameraEnabled()) <span class="comment">// Don&#39;t activate the Motion Plus if we are trying to initialize the IR camera</span>
<a name="l00373"></a>00373 <span class="preprocessor">#endif</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span>                                                                        setReportMode(<span class="keyword">false</span>, 0x35); <span class="comment">// Also read the extension</span>
<a name="l00375"></a>00375                                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[16] == 0x00 &amp;&amp; l2capinbuf[17] == 0xA6 &amp;&amp; l2capinbuf[18] == 0x20 &amp;&amp; (l2capinbuf[19] == 0x00 || l2capinbuf[19] == 0x04 || l2capinbuf[19] == 0x05 || l2capinbuf[19] == 0x07) &amp;&amp; l2capinbuf[20] == 0x05) {
<a name="l00376"></a>00376 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span>                                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nInactive Wii Motion Plus&quot;</span>), 0x80);
<a name="l00378"></a>00378                                                                 Notify(PSTR(<span class="stringliteral">&quot;\r\nPlease unplug the Motion Plus, disconnect the Wiimote and then replug the Motion Plus Extension&quot;</span>), 0x80);
<a name="l00379"></a>00379 <span class="preprocessor">#endif</span>
<a name="l00380"></a>00380 <span class="preprocessor"></span>                                                                stateCounter = 300; <span class="comment">// Skip the rest in &quot;WII_CHECK_MOTION_PLUS_STATE&quot;</span>
<a name="l00381"></a>00381                                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l2capinbuf[16] == 0x00 &amp;&amp; l2capinbuf[17] == 0xA4 &amp;&amp; l2capinbuf[18] == 0x20 &amp;&amp; l2capinbuf[19] == 0x01 &amp;&amp; l2capinbuf[20] == 0x20) {
<a name="l00382"></a>00382 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span>                                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nWii U Pro Controller connected&quot;</span>), 0x80);
<a name="l00384"></a>00384 <span class="preprocessor">#endif</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span>                                                                <a class="code" href="class_w_i_i.html#a461f5b7a5f2bc874e107fc776c284b16">wiiUProControllerConnected</a> = <span class="keyword">true</span>;
<a name="l00386"></a>00386                                                         }
<a name="l00387"></a>00387 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span>                                                        <span class="keywordflow">else</span> {
<a name="l00389"></a>00389                                                                 Notify(PSTR(<span class="stringliteral">&quot;\r\nUnknown Device: &quot;</span>), 0x80);
<a name="l00390"></a>00390                                                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[13], 0x80);
<a name="l00391"></a>00391                                                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[14], 0x80);
<a name="l00392"></a>00392                                                                 Notify(PSTR(<span class="stringliteral">&quot;\r\nData: &quot;</span>), 0x80);
<a name="l00393"></a>00393                                                                 <span class="keywordflow">for</span>(uint8_t i = 0; i &lt; ((l2capinbuf[12] &gt;&gt; 4) + 1); i++) { <span class="comment">// bit 4-7 is the length-1</span>
<a name="l00394"></a>00394                                                                         D_PrintHex&lt;uint8_t &gt; (l2capinbuf[15 + i], 0x80);
<a name="l00395"></a>00395                                                                         Notify(PSTR(<span class="stringliteral">&quot; &quot;</span>), 0x80);
<a name="l00396"></a>00396                                                                 }
<a name="l00397"></a>00397                                                         }
<a name="l00398"></a>00398 <span class="preprocessor">#endif</span>
<a name="l00399"></a>00399 <span class="preprocessor"></span>                                                }
<a name="l00400"></a>00400 <span class="preprocessor">#ifdef EXTRADEBUG</span>
<a name="l00401"></a>00401 <span class="preprocessor"></span>                                                <span class="keywordflow">else</span> {
<a name="l00402"></a>00402                                                         Notify(PSTR(<span class="stringliteral">&quot;\r\nReport Error: &quot;</span>), 0x80);
<a name="l00403"></a>00403                                                         D_PrintHex&lt;uint8_t &gt; (l2capinbuf[13], 0x80);
<a name="l00404"></a>00404                                                         D_PrintHex&lt;uint8_t &gt; (l2capinbuf[14], 0x80);
<a name="l00405"></a>00405                                                 }
<a name="l00406"></a>00406 <span class="preprocessor">#endif</span>
<a name="l00407"></a>00407 <span class="preprocessor"></span>                                                <span class="keywordflow">break</span>;
<a name="l00408"></a>00408                                         <span class="keywordflow">case</span> 0x22: <span class="comment">// Acknowledge output report, return function result</span>
<a name="l00409"></a>00409 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00410"></a>00410 <span class="preprocessor"></span>                                                <span class="keywordflow">if</span>(l2capinbuf[13] != 0x00) { <span class="comment">// Check if there is an error</span>
<a name="l00411"></a>00411                                                         Notify(PSTR(<span class="stringliteral">&quot;\r\nCommand failed: &quot;</span>), 0x80);
<a name="l00412"></a>00412                                                         D_PrintHex&lt;uint8_t &gt; (l2capinbuf[12], 0x80);
<a name="l00413"></a>00413                                                 }
<a name="l00414"></a>00414 <span class="preprocessor">#endif</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>                                                <span class="keywordflow">break</span>;
<a name="l00416"></a>00416                                         <span class="keywordflow">case</span> 0x30: <span class="comment">// Core buttons - (a1) 30 BB BB</span>
<a name="l00417"></a>00417                                                 <span class="keywordflow">break</span>;
<a name="l00418"></a>00418                                         <span class="keywordflow">case</span> 0x31: <span class="comment">// Core Buttons and Accelerometer - (a1) 31 BB BB AA AA AA</span>
<a name="l00419"></a>00419                                                 <span class="keywordflow">break</span>;
<a name="l00420"></a>00420                                         <span class="keywordflow">case</span> 0x32: <span class="comment">// Core Buttons with 8 Extension bytes - (a1) 32 BB BB EE EE EE EE EE EE EE EE</span>
<a name="l00421"></a>00421                                                 <span class="keywordflow">break</span>;
<a name="l00422"></a>00422                                         <span class="keywordflow">case</span> 0x33: <span class="comment">// Core Buttons with Accelerometer and 12 IR bytes - (a1) 33 BB BB AA AA AA II II II II II II II II II II II II</span>
<a name="l00423"></a>00423 <span class="preprocessor">#ifdef WIICAMERA</span>
<a name="l00424"></a>00424 <span class="preprocessor"></span>                                                <span class="comment">// Read the IR data</span>
<a name="l00425"></a>00425                                                 IR_object_x1 = (l2capinbuf[15] | ((uint16_t)(l2capinbuf[17] &amp; 0x30) &lt;&lt; 4)); <span class="comment">// x position</span>
<a name="l00426"></a>00426                                                 IR_object_y1 = (l2capinbuf[16] | ((uint16_t)(l2capinbuf[17] &amp; 0xC0) &lt;&lt; 2)); <span class="comment">// y position</span>
<a name="l00427"></a>00427                                                 IR_object_s1 = (l2capinbuf[17] &amp; 0x0F); <span class="comment">// size value, 0-15</span>
<a name="l00428"></a>00428 
<a name="l00429"></a>00429                                                 IR_object_x2 = (l2capinbuf[18] | ((uint16_t)(l2capinbuf[20] &amp; 0x30) &lt;&lt; 4));
<a name="l00430"></a>00430                                                 IR_object_y2 = (l2capinbuf[19] | ((uint16_t)(l2capinbuf[20] &amp; 0xC0) &lt;&lt; 2));
<a name="l00431"></a>00431                                                 IR_object_s2 = (l2capinbuf[20] &amp; 0x0F);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433                                                 IR_object_x3 = (l2capinbuf[21] | ((uint16_t)(l2capinbuf[23] &amp; 0x30) &lt;&lt; 4));
<a name="l00434"></a>00434                                                 IR_object_y3 = (l2capinbuf[22] | ((uint16_t)(l2capinbuf[23] &amp; 0xC0) &lt;&lt; 2));
<a name="l00435"></a>00435                                                 IR_object_s3 = (l2capinbuf[23] &amp; 0x0F);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437                                                 IR_object_x4 = (l2capinbuf[24] | ((uint16_t)(l2capinbuf[26] &amp; 0x30) &lt;&lt; 4));
<a name="l00438"></a>00438                                                 IR_object_y4 = (l2capinbuf[25] | ((uint16_t)(l2capinbuf[26] &amp; 0xC0) &lt;&lt; 2));
<a name="l00439"></a>00439                                                 IR_object_s4 = (l2capinbuf[26] &amp; 0x0F);
<a name="l00440"></a>00440 <span class="preprocessor">#endif</span>
<a name="l00441"></a>00441 <span class="preprocessor"></span>                                                <span class="keywordflow">break</span>;
<a name="l00442"></a>00442                                         <span class="keywordflow">case</span> 0x34: <span class="comment">// Core Buttons with 19 Extension bytes - (a1) 34 BB BB EE EE EE EE EE EE EE EE EE EE EE EE EE EE EE EE EE EE EE</span>
<a name="l00443"></a>00443                                                 <span class="keywordflow">break</span>;
<a name="l00444"></a>00444                                                 <span class="comment">/* 0x3e and 0x3f both give unknown report types when report mode is 0x3e or 0x3f with mode number 0x05 */</span>
<a name="l00445"></a>00445                                         <span class="keywordflow">case</span> 0x3E: <span class="comment">// Core Buttons with Accelerometer and 32 IR bytes</span>
<a name="l00446"></a>00446                                                 <span class="comment">// (a1) 31 BB BB AA AA AA II II II II II II II II II II II II II II II II II II II II II II II II II II II II II II II II</span>
<a name="l00447"></a>00447                                                 <span class="comment">// corresponds to output report mode 0x3e</span>
<a name="l00448"></a>00448 
<a name="l00449"></a>00449                                                 <span class="comment">/**** for reading in full mode: DOES NOT WORK YET ****/</span>
<a name="l00450"></a>00450                                                 <span class="comment">/* When it works it will also have intensity and bounding box data */</span>
<a name="l00451"></a>00451                                                 <span class="comment">/*</span>
<a name="l00452"></a>00452 <span class="comment">                                                IR_object_x1 = (l2capinbuf[13] | ((uint16_t)(l2capinbuf[15] &amp; 0x30) &lt;&lt; 4));</span>
<a name="l00453"></a>00453 <span class="comment">                                                IR_object_y1 = (l2capinbuf[14] | ((uint16_t)(l2capinbuf[15] &amp; 0xC0) &lt;&lt; 2));</span>
<a name="l00454"></a>00454 <span class="comment">                                                IR_object_s1 = (l2capinbuf[15] &amp; 0x0F);</span>
<a name="l00455"></a>00455 <span class="comment">                                                 */</span>
<a name="l00456"></a>00456                                                 <span class="keywordflow">break</span>;
<a name="l00457"></a>00457                                         <span class="keywordflow">case</span> 0x3F:
<a name="l00458"></a>00458                                                 <span class="comment">/*</span>
<a name="l00459"></a>00459 <span class="comment">                                                IR_object_x1 = (l2capinbuf[13] | ((uint16_t)(l2capinbuf[15] &amp; 0x30) &lt;&lt; 4));</span>
<a name="l00460"></a>00460 <span class="comment">                                                IR_object_y1 = (l2capinbuf[14] | ((uint16_t)(l2capinbuf[15] &amp; 0xC0) &lt;&lt; 2));</span>
<a name="l00461"></a>00461 <span class="comment">                                                IR_object_s1 = (l2capinbuf[15] &amp; 0x0F);</span>
<a name="l00462"></a>00462 <span class="comment">                                                 */</span>
<a name="l00463"></a>00463                                                 <span class="keywordflow">break</span>;
<a name="l00464"></a>00464                                         <span class="keywordflow">case</span> 0x35: <span class="comment">// Core Buttons and Accelerometer with 16 Extension Bytes</span>
<a name="l00465"></a>00465                                                 <span class="comment">// (a1) 35 BB BB AA AA AA EE EE EE EE EE EE EE EE EE EE EE EE EE EE EE EE</span>
<a name="l00466"></a>00466                                                 <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a>) {
<a name="l00467"></a>00467                                                         <span class="keywordflow">if</span>(l2capinbuf[20] &amp; 0x02) { <span class="comment">// Check if it&#39;s a report from the Motion controller or the extension</span>
<a name="l00468"></a>00468                                                                 <span class="keywordflow">if</span>(motionValuesReset) { <span class="comment">// We will only use the values when the gyro value has been set</span>
<a name="l00469"></a>00469                                                                         <a class="code" href="class_w_i_i.html#ab813b65548e827f41a5192fcc34056ea">gyroYawRaw</a> = ((l2capinbuf[15] | ((l2capinbuf[18] &amp; 0xFC) &lt;&lt; 6)) - <a class="code" href="class_w_i_i.html#ad4f0d2456c56414f9b8013b85a1ee7d2">gyroYawZero</a>);
<a name="l00470"></a>00470                                                                         <a class="code" href="class_w_i_i.html#a0784c779ebeae2d459996c35a54ee3b8">gyroRollRaw</a> = ((l2capinbuf[16] | ((l2capinbuf[19] &amp; 0xFC) &lt;&lt; 6)) - <a class="code" href="class_w_i_i.html#a10d91cd5d73bc655be776b44d27004c9">gyroRollZero</a>);
<a name="l00471"></a>00471                                                                         <a class="code" href="class_w_i_i.html#a749ea9dd39ba9a5320c5b24ce93bc544">gyroPitchRaw</a> = ((l2capinbuf[17] | ((l2capinbuf[20] &amp; 0xFC) &lt;&lt; 6)) - <a class="code" href="class_w_i_i.html#abbc31ecd4495d70258cfa095e34cb3c3">gyroPitchZero</a>);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                                                                         <a class="code" href="class_w_i_i.html#ad5df436cc5d073f26bf3ea5c60d788d6">yawGyroSpeed</a> = (double)<a class="code" href="class_w_i_i.html#ab813b65548e827f41a5192fcc34056ea">gyroYawRaw</a> / ((<span class="keywordtype">double</span>)<a class="code" href="class_w_i_i.html#ad4f0d2456c56414f9b8013b85a1ee7d2">gyroYawZero</a> / <a class="code" href="class_w_i_i.html#a0694969a30092b9b1dcb26120c7cff73">yawGyroScale</a>);
<a name="l00474"></a>00474                                                                         <a class="code" href="class_w_i_i.html#a3fb552c6ad486e23434dcb347a2a4b84">rollGyroSpeed</a> = -(double)<a class="code" href="class_w_i_i.html#a0784c779ebeae2d459996c35a54ee3b8">gyroRollRaw</a> / ((<span class="keywordtype">double</span>)<a class="code" href="class_w_i_i.html#a10d91cd5d73bc655be776b44d27004c9">gyroRollZero</a> / <a class="code" href="class_w_i_i.html#a6c0971ae4c9ab752888a5871020c8331">rollGyroScale</a>); <span class="comment">// We invert these values so they will fit the acc values</span>
<a name="l00475"></a>00475                                                                         <a class="code" href="class_w_i_i.html#acfb290a86aa9a65dd4ae84d02e3c6ded">pitchGyroSpeed</a> = (double)<a class="code" href="class_w_i_i.html#a749ea9dd39ba9a5320c5b24ce93bc544">gyroPitchRaw</a> / ((<span class="keywordtype">double</span>)<a class="code" href="class_w_i_i.html#abbc31ecd4495d70258cfa095e34cb3c3">gyroPitchZero</a> / <a class="code" href="class_w_i_i.html#aea6ce6f3222df3e547e9957673c7a07a">pitchGyroScale</a>);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477                                                                         <span class="comment">/* The onboard gyro has two ranges for slow and fast mode */</span>
<a name="l00478"></a>00478                                                                         <span class="keywordflow">if</span>(!(l2capinbuf[18] &amp; 0x02)) <span class="comment">// Check if fast mode is used</span>
<a name="l00479"></a>00479                                                                                 <a class="code" href="class_w_i_i.html#ad5df436cc5d073f26bf3ea5c60d788d6">yawGyroSpeed</a> *= 4.545;
<a name="l00480"></a>00480                                                                         <span class="keywordflow">if</span>(!(l2capinbuf[18] &amp; 0x01)) <span class="comment">// Check if fast mode is used</span>
<a name="l00481"></a>00481                                                                                 <a class="code" href="class_w_i_i.html#acfb290a86aa9a65dd4ae84d02e3c6ded">pitchGyroSpeed</a> *= 4.545;
<a name="l00482"></a>00482                                                                         <span class="keywordflow">if</span>(!(l2capinbuf[19] &amp; 0x02)) <span class="comment">// Check if fast mode is used</span>
<a name="l00483"></a>00483                                                                                 <a class="code" href="class_w_i_i.html#a3fb552c6ad486e23434dcb347a2a4b84">rollGyroSpeed</a> *= 4.545;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485                                                                         compPitch = (0.93 * (compPitch + (<a class="code" href="class_w_i_i.html#acfb290a86aa9a65dd4ae84d02e3c6ded">pitchGyroSpeed</a> * (double)(micros() - timer) / 1000000)))+(0.07 * <a class="code" href="class_w_i_i.html#a2fb34f50b5374c9442af263f61595af4">getWiimotePitch</a>()); <span class="comment">// Use a complimentary filter to calculate the angle</span>
<a name="l00486"></a>00486                                                                         compRoll = (0.93 * (compRoll + (<a class="code" href="class_w_i_i.html#a3fb552c6ad486e23434dcb347a2a4b84">rollGyroSpeed</a> * (double)(micros() - timer) / 1000000)))+(0.07 * <a class="code" href="class_w_i_i.html#a9a58b857c84fa82152be7983efe70f60">getWiimoteRoll</a>());
<a name="l00487"></a>00487 
<a name="l00488"></a>00488                                                                         <a class="code" href="class_w_i_i.html#a988db5b35cfc3c543f93f49587a50e62">gyroYaw</a> += (<a class="code" href="class_w_i_i.html#ad5df436cc5d073f26bf3ea5c60d788d6">yawGyroSpeed</a> * ((double)(micros() - timer) / 1000000));
<a name="l00489"></a>00489                                                                         <a class="code" href="class_w_i_i.html#a2a0e4745bff7cfec644bcebe984c2bc8">gyroRoll</a> += (<a class="code" href="class_w_i_i.html#a3fb552c6ad486e23434dcb347a2a4b84">rollGyroSpeed</a> * ((double)(micros() - timer) / 1000000));
<a name="l00490"></a>00490                                                                         <a class="code" href="class_w_i_i.html#af61f57d34b81f2a878f0126a074e3af4">gyroPitch</a> += (<a class="code" href="class_w_i_i.html#acfb290a86aa9a65dd4ae84d02e3c6ded">pitchGyroSpeed</a> * ((double)(micros() - timer) / 1000000));
<a name="l00491"></a>00491                                                                         timer = micros();
<a name="l00492"></a>00492                                                                         <span class="comment">/*</span>
<a name="l00493"></a>00493 <span class="comment">                                                                        // Uncomment these lines to tune the gyro scale variabels</span>
<a name="l00494"></a>00494 <span class="comment">                                                                        Notify(PSTR(&quot;\r\ngyroYaw: &quot;), 0x80);</span>
<a name="l00495"></a>00495 <span class="comment">                                                                        Notify(gyroYaw, 0x80);</span>
<a name="l00496"></a>00496 <span class="comment">                                                                        Notify(PSTR(&quot;\tgyroRoll: &quot;), 0x80);</span>
<a name="l00497"></a>00497 <span class="comment">                                                                        Notify(gyroRoll, 0x80);</span>
<a name="l00498"></a>00498 <span class="comment">                                                                        Notify(PSTR(&quot;\tgyroPitch: &quot;), 0x80);</span>
<a name="l00499"></a>00499 <span class="comment">                                                                        Notify(gyroPitch, 0x80);</span>
<a name="l00500"></a>00500 <span class="comment">                                                                         */</span>
<a name="l00501"></a>00501                                                                         <span class="comment">/*</span>
<a name="l00502"></a>00502 <span class="comment">                                                                        Notify(PSTR(&quot;\twiimoteRoll: &quot;), 0x80);</span>
<a name="l00503"></a>00503 <span class="comment">                                                                        Notify(wiimoteRoll, 0x80);</span>
<a name="l00504"></a>00504 <span class="comment">                                                                        Notify(PSTR(&quot;\twiimotePitch: &quot;), 0x80);</span>
<a name="l00505"></a>00505 <span class="comment">                                                                        Notify(wiimotePitch, 0x80);</span>
<a name="l00506"></a>00506 <span class="comment">                                                                         */</span>
<a name="l00507"></a>00507                                                                 } <span class="keywordflow">else</span> {
<a name="l00508"></a>00508                                                                         <span class="keywordflow">if</span>((micros() - timer) &gt; 1000000) { <span class="comment">// Loop for 1 sec before resetting the values</span>
<a name="l00509"></a>00509 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00510"></a>00510 <span class="preprocessor"></span>                                                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nThe gyro values has been reset&quot;</span>), 0x80);
<a name="l00511"></a>00511 <span class="preprocessor">#endif</span>
<a name="l00512"></a>00512 <span class="preprocessor"></span>                                                                                <a class="code" href="class_w_i_i.html#ad4f0d2456c56414f9b8013b85a1ee7d2">gyroYawZero</a> = (l2capinbuf[15] | ((l2capinbuf[18] &amp; 0xFC) &lt;&lt; 6));
<a name="l00513"></a>00513                                                                                 <a class="code" href="class_w_i_i.html#a10d91cd5d73bc655be776b44d27004c9">gyroRollZero</a> = (l2capinbuf[16] | ((l2capinbuf[19] &amp; 0xFC) &lt;&lt; 6));
<a name="l00514"></a>00514                                                                                 <a class="code" href="class_w_i_i.html#abbc31ecd4495d70258cfa095e34cb3c3">gyroPitchZero</a> = (l2capinbuf[17] | ((l2capinbuf[20] &amp; 0xFC) &lt;&lt; 6));
<a name="l00515"></a>00515 
<a name="l00516"></a>00516                                                                                 <a class="code" href="class_w_i_i.html#a6c0971ae4c9ab752888a5871020c8331">rollGyroScale</a> = 500; <span class="comment">// You might need to adjust these</span>
<a name="l00517"></a>00517                                                                                 <a class="code" href="class_w_i_i.html#aea6ce6f3222df3e547e9957673c7a07a">pitchGyroScale</a> = 400;
<a name="l00518"></a>00518                                                                                 <a class="code" href="class_w_i_i.html#a0694969a30092b9b1dcb26120c7cff73">yawGyroScale</a> = 415;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520                                                                                 <a class="code" href="class_w_i_i.html#a988db5b35cfc3c543f93f49587a50e62">gyroYaw</a> = 0;
<a name="l00521"></a>00521                                                                                 <a class="code" href="class_w_i_i.html#a2a0e4745bff7cfec644bcebe984c2bc8">gyroRoll</a> = 0;
<a name="l00522"></a>00522                                                                                 <a class="code" href="class_w_i_i.html#af61f57d34b81f2a878f0126a074e3af4">gyroPitch</a> = 0;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524                                                                                 motionValuesReset = <span class="keyword">true</span>;
<a name="l00525"></a>00525                                                                                 timer = micros();
<a name="l00526"></a>00526                                                                         }
<a name="l00527"></a>00527                                                                 }
<a name="l00528"></a>00528                                                         } <span class="keywordflow">else</span> {
<a name="l00529"></a>00529                                                                 <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a>) {
<a name="l00530"></a>00530                                                                         hatValues[<a class="code" href="_wii_8h.html#ad79e49e27b025d6ac9d695c4816f84d4aed1a7a35bf1b9c1003fbe3dd4a61a06d">HatX</a>] = l2capinbuf[15];
<a name="l00531"></a>00531                                                                         hatValues[<a class="code" href="_wii_8h.html#ad79e49e27b025d6ac9d695c4816f84d4ae2ac743b5ba1752933e09f1dac48d97b">HatY</a>] = l2capinbuf[16];
<a name="l00532"></a>00532                                                                         <a class="code" href="class_w_i_i.html#a3a13b5931284d5bcd6647f681cda95b4">accXnunchuck</a> = ((l2capinbuf[17] &lt;&lt; 2) | (l2capinbuf[20] &amp; 0x10 &gt;&gt; 3)) - 416;
<a name="l00533"></a>00533                                                                         <a class="code" href="class_w_i_i.html#ae657585a560e9d214e6c0219f8b47aeb">accYnunchuck</a> = ((l2capinbuf[18] &lt;&lt; 2) | (l2capinbuf[20] &amp; 0x20 &gt;&gt; 4)) - 416;
<a name="l00534"></a>00534                                                                         <a class="code" href="class_w_i_i.html#a42af5743d2e3c2dbc01ea0b5531cc7c6">accZnunchuck</a> = (((l2capinbuf[19] &amp; 0xFE) &lt;&lt; 2) | (l2capinbuf[20] &amp; 0xC0 &gt;&gt; 5)) - 416;
<a name="l00535"></a>00535                                                                 }
<a name="l00536"></a>00536                                                                 <span class="comment">//else if(classicControllerConnected) { }</span>
<a name="l00537"></a>00537                                                         }
<a name="l00538"></a>00538                                                         <span class="keywordflow">if</span>(l2capinbuf[19] &amp; 0x01) {
<a name="l00539"></a>00539                                                                 <span class="keywordflow">if</span>(!extensionConnected) {
<a name="l00540"></a>00540                                                                         extensionConnected = <span class="keyword">true</span>;
<a name="l00541"></a>00541                                                                         unknownExtensionConnected = <span class="keyword">true</span>;
<a name="l00542"></a>00542 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span>                                                                        Notify(PSTR(<span class="stringliteral">&quot;\r\nExtension connected to Motion Plus&quot;</span>), 0x80);
<a name="l00544"></a>00544 <span class="preprocessor">#endif</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span>                                                                }
<a name="l00546"></a>00546                                                         } <span class="keywordflow">else</span> {
<a name="l00547"></a>00547                                                                 <span class="keywordflow">if</span>(extensionConnected &amp;&amp; !unknownExtensionConnected) {
<a name="l00548"></a>00548                                                                         extensionConnected = <span class="keyword">false</span>;
<a name="l00549"></a>00549                                                                         unknownExtensionConnected = <span class="keyword">true</span>;
<a name="l00550"></a>00550 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span>                                                                        Notify(PSTR(<span class="stringliteral">&quot;\r\nExtension disconnected from Motion Plus&quot;</span>), 0x80);
<a name="l00552"></a>00552 <span class="preprocessor">#endif</span>
<a name="l00553"></a>00553 <span class="preprocessor"></span>                                                                        <a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a> = <span class="keyword">false</span>; <span class="comment">// There is no extension connected to the Motion Plus if this report is sent</span>
<a name="l00554"></a>00554                                                                 }
<a name="l00555"></a>00555                                                         }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a>) {
<a name="l00558"></a>00558                                                         hatValues[<a class="code" href="_wii_8h.html#ad79e49e27b025d6ac9d695c4816f84d4aed1a7a35bf1b9c1003fbe3dd4a61a06d">HatX</a>] = l2capinbuf[15];
<a name="l00559"></a>00559                                                         hatValues[<a class="code" href="_wii_8h.html#ad79e49e27b025d6ac9d695c4816f84d4ae2ac743b5ba1752933e09f1dac48d97b">HatY</a>] = l2capinbuf[16];
<a name="l00560"></a>00560                                                         <a class="code" href="class_w_i_i.html#a3a13b5931284d5bcd6647f681cda95b4">accXnunchuck</a> = ((l2capinbuf[17] &lt;&lt; 2) | (l2capinbuf[20] &amp; 0x0C &gt;&gt; 2)) - 416;
<a name="l00561"></a>00561                                                         <a class="code" href="class_w_i_i.html#ae657585a560e9d214e6c0219f8b47aeb">accYnunchuck</a> = ((l2capinbuf[18] &lt;&lt; 2) | (l2capinbuf[20] &amp; 0x30 &gt;&gt; 4)) - 416;
<a name="l00562"></a>00562                                                         <a class="code" href="class_w_i_i.html#a42af5743d2e3c2dbc01ea0b5531cc7c6">accZnunchuck</a> = ((l2capinbuf[19] &lt;&lt; 2) | (l2capinbuf[20] &amp; 0xC0 &gt;&gt; 6)) - 416;
<a name="l00563"></a>00563                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a461f5b7a5f2bc874e107fc776c284b16">wiiUProControllerConnected</a>) {
<a name="l00564"></a>00564                                                         hatValues[<a class="code" href="controller_enums_8h.html#a34dad8f0a0927471137c403216597093a383cb8895dd296b7f69ce845ed16b0ca">LeftHatX</a>] = (l2capinbuf[15] | l2capinbuf[16] &lt;&lt; 8);
<a name="l00565"></a>00565                                                         hatValues[<a class="code" href="controller_enums_8h.html#a34dad8f0a0927471137c403216597093aaeb027a0ae5bbc6ba25e1c78a6486c7b">RightHatX</a>] = (l2capinbuf[17] | l2capinbuf[18] &lt;&lt; 8);
<a name="l00566"></a>00566                                                         hatValues[<a class="code" href="controller_enums_8h.html#a34dad8f0a0927471137c403216597093af3f3925efa9762c4e9e71ac7da7a94a3">LeftHatY</a>] = (l2capinbuf[19] | l2capinbuf[20] &lt;&lt; 8);
<a name="l00567"></a>00567                                                         hatValues[<a class="code" href="controller_enums_8h.html#a34dad8f0a0927471137c403216597093a7f1fb2db5381286691f4dec179ed5d5a">RightHatY</a>] = (l2capinbuf[21] | l2capinbuf[22] &lt;&lt; 8);
<a name="l00568"></a>00568                                                 }
<a name="l00569"></a>00569                                                 <span class="keywordflow">break</span>;
<a name="l00570"></a>00570 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00571"></a>00571 <span class="preprocessor"></span>                                        <span class="keywordflow">default</span>:
<a name="l00572"></a>00572                                                 Notify(PSTR(<span class="stringliteral">&quot;\r\nUnknown Report type: &quot;</span>), 0x80);
<a name="l00573"></a>00573                                                 D_PrintHex&lt;uint8_t &gt; (l2capinbuf[9], 0x80);
<a name="l00574"></a>00574                                                 <span class="keywordflow">break</span>;
<a name="l00575"></a>00575 <span class="preprocessor">#endif</span>
<a name="l00576"></a>00576 <span class="preprocessor"></span>                                }
<a name="l00577"></a>00577                         }
<a name="l00578"></a>00578                 }
<a name="l00579"></a>00579                 L2CAP_task();
<a name="l00580"></a>00580         }
<a name="l00581"></a>00581 }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 <span class="keywordtype">void</span> WII::L2CAP_task() {
<a name="l00584"></a>00584         <span class="keywordflow">switch</span>(l2cap_state) {
<a name="l00585"></a>00585                         <span class="comment">/* These states are used if the Wiimote is the host */</span>
<a name="l00586"></a>00586                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#abac08b5b24a1cd2b12517cd9aa6c616b">L2CAP_CONTROL_SUCCESS</a>:
<a name="l00587"></a>00587                         <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a5d120280be8d502fa0b74d46aa32d3a8">l2cap_check_flag</a>(<a class="code" href="_b_t_d_8h.html#a0c444d5d06ec604820d426556c2f38d7">L2CAP_FLAG_CONFIG_CONTROL_SUCCESS</a>)) {
<a name="l00588"></a>00588 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00589"></a>00589 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nHID Control Successfully Configured&quot;</span>), 0x80);
<a name="l00590"></a>00590 <span class="preprocessor">#endif</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span>                                l2cap_state = <a class="code" href="_b_t_d_8h.html#ac7aa7fd7a8a34a6c9e420e3cb114737b">L2CAP_INTERRUPT_SETUP</a>;
<a name="l00592"></a>00592                         }
<a name="l00593"></a>00593                         <span class="keywordflow">break</span>;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#ac7aa7fd7a8a34a6c9e420e3cb114737b">L2CAP_INTERRUPT_SETUP</a>:
<a name="l00596"></a>00596                         <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a5d120280be8d502fa0b74d46aa32d3a8">l2cap_check_flag</a>(<a class="code" href="_b_t_d_8h.html#a015f3b25bd7a2908c84b973dec453f45">L2CAP_FLAG_CONNECTION_INTERRUPT_REQUEST</a>)) {
<a name="l00597"></a>00597 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nHID Interrupt Incoming Connection Request&quot;</span>), 0x80);
<a name="l00599"></a>00599 <span class="preprocessor">#endif</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span>                                pBtd-&gt;<a class="code" href="class_b_t_d.html#a7d34c62b1d561679dea5cd27356b38a7">l2cap_connection_response</a>(hci_handle, identifier, interrupt_dcid, interrupt_scid, <a class="code" href="_b_t_d_8h.html#a9960d0d5ae92fc92c70bbb84c2a5c0cc">PENDING</a>);
<a name="l00601"></a>00601                                 delay(1);
<a name="l00602"></a>00602                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#a7d34c62b1d561679dea5cd27356b38a7">l2cap_connection_response</a>(hci_handle, identifier, interrupt_dcid, interrupt_scid, <a class="code" href="_b_t_d_8h.html#a1be7a56cdddcdb7dedf16d4dee381e93">SUCCESSFUL</a>);
<a name="l00603"></a>00603                                 identifier++;
<a name="l00604"></a>00604                                 delay(1);
<a name="l00605"></a>00605                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#ab646a59311344966f139bb3b78f30233">l2cap_config_request</a>(hci_handle, identifier, interrupt_scid);
<a name="l00606"></a>00606 
<a name="l00607"></a>00607                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a73e3a81d9a8850075fd10933acc5a035">L2CAP_INTERRUPT_CONFIG_REQUEST</a>;
<a name="l00608"></a>00608                         }
<a name="l00609"></a>00609                         <span class="keywordflow">break</span>;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611                         <span class="comment">/* These states are used if the Arduino is the host */</span>
<a name="l00612"></a>00612                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#a68bcdd68c269cd7970d5271a00bbe5fe">L2CAP_CONTROL_CONNECT_REQUEST</a>:
<a name="l00613"></a>00613                         <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a5d120280be8d502fa0b74d46aa32d3a8">l2cap_check_flag</a>(<a class="code" href="_b_t_d_8h.html#a2e5a9c283f0912833f3e0418d3feadd7">L2CAP_FLAG_CONTROL_CONNECTED</a>)) {
<a name="l00614"></a>00614 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00615"></a>00615 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nSend HID Control Config Request&quot;</span>), 0x80);
<a name="l00616"></a>00616 <span class="preprocessor">#endif</span>
<a name="l00617"></a>00617 <span class="preprocessor"></span>                                identifier++;
<a name="l00618"></a>00618                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#ab646a59311344966f139bb3b78f30233">l2cap_config_request</a>(hci_handle, identifier, control_scid);
<a name="l00619"></a>00619                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#aaaf733ee2c84bd8df4d24f2ae1f3b378">L2CAP_CONTROL_CONFIG_REQUEST</a>;
<a name="l00620"></a>00620                         }
<a name="l00621"></a>00621                         <span class="keywordflow">break</span>;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#aaaf733ee2c84bd8df4d24f2ae1f3b378">L2CAP_CONTROL_CONFIG_REQUEST</a>:
<a name="l00624"></a>00624                         <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a5d120280be8d502fa0b74d46aa32d3a8">l2cap_check_flag</a>(<a class="code" href="_b_t_d_8h.html#a0c444d5d06ec604820d426556c2f38d7">L2CAP_FLAG_CONFIG_CONTROL_SUCCESS</a>)) {
<a name="l00625"></a>00625 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00626"></a>00626 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nSend HID Interrupt Connection Request&quot;</span>), 0x80);
<a name="l00627"></a>00627 <span class="preprocessor">#endif</span>
<a name="l00628"></a>00628 <span class="preprocessor"></span>                                identifier++;
<a name="l00629"></a>00629                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#a55cf412a2053972a353b1ab964ca9d3e">l2cap_connection_request</a>(hci_handle, identifier, interrupt_dcid, <a class="code" href="_b_t_d_8h.html#a4c5ac96db74d61d4a5a5d945a400e7da">HID_INTR_PSM</a>);
<a name="l00630"></a>00630                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#af0b913a7e9e54b1f6ab95d82bd36f954">L2CAP_INTERRUPT_CONNECT_REQUEST</a>;
<a name="l00631"></a>00631                         }
<a name="l00632"></a>00632                         <span class="keywordflow">break</span>;
<a name="l00633"></a>00633 
<a name="l00634"></a>00634                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#af0b913a7e9e54b1f6ab95d82bd36f954">L2CAP_INTERRUPT_CONNECT_REQUEST</a>:
<a name="l00635"></a>00635                         <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a5d120280be8d502fa0b74d46aa32d3a8">l2cap_check_flag</a>(<a class="code" href="_b_t_d_8h.html#aad823543553cc7500ac49d7479eb858f">L2CAP_FLAG_INTERRUPT_CONNECTED</a>)) {
<a name="l00636"></a>00636 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00637"></a>00637 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nSend HID Interrupt Config Request&quot;</span>), 0x80);
<a name="l00638"></a>00638 <span class="preprocessor">#endif</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span>                                identifier++;
<a name="l00640"></a>00640                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#ab646a59311344966f139bb3b78f30233">l2cap_config_request</a>(hci_handle, identifier, interrupt_scid);
<a name="l00641"></a>00641                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a73e3a81d9a8850075fd10933acc5a035">L2CAP_INTERRUPT_CONFIG_REQUEST</a>;
<a name="l00642"></a>00642                         }
<a name="l00643"></a>00643                         <span class="keywordflow">break</span>;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#a73e3a81d9a8850075fd10933acc5a035">L2CAP_INTERRUPT_CONFIG_REQUEST</a>:
<a name="l00646"></a>00646                         <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a5d120280be8d502fa0b74d46aa32d3a8">l2cap_check_flag</a>(<a class="code" href="_b_t_d_8h.html#a2b3cdcd3124251a40ce825da0d8dcb6f">L2CAP_FLAG_CONFIG_INTERRUPT_SUCCESS</a>)) { <span class="comment">// Now the HID channels is established</span>
<a name="l00647"></a>00647 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nHID Channels Established&quot;</span>), 0x80);
<a name="l00649"></a>00649 <span class="preprocessor">#endif</span>
<a name="l00650"></a>00650 <span class="preprocessor"></span>                                pBtd-&gt;<a class="code" href="class_b_t_d.html#ac7caac80fb6f5f0e794af3644887d88e">connectToWii</a> = <span class="keyword">false</span>;
<a name="l00651"></a>00651                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#a0c8cc2a2dd2cda3e760b8b4c1a2d169c">pairWithWii</a> = <span class="keyword">false</span>;
<a name="l00652"></a>00652                                 stateCounter = 0;
<a name="l00653"></a>00653                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a11b0db0910ac44ec8b090647d6a71088">WII_CHECK_MOTION_PLUS_STATE</a>;
<a name="l00654"></a>00654                         }
<a name="l00655"></a>00655                         <span class="keywordflow">break</span>;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657                         <span class="comment">/* The next states are in run() */</span>
<a name="l00658"></a>00658 
<a name="l00659"></a>00659                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#ab569b2085ad29f41d1da9c0ed352bd65">L2CAP_INTERRUPT_DISCONNECT</a>:
<a name="l00660"></a>00660                         <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a5d120280be8d502fa0b74d46aa32d3a8">l2cap_check_flag</a>(<a class="code" href="_b_t_d_8h.html#acc096a05301f3cbdece4ad372cc149c3">L2CAP_FLAG_DISCONNECT_INTERRUPT_RESPONSE</a>) &amp;&amp; millis() &gt; timer) {
<a name="l00661"></a>00661 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00662"></a>00662 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nDisconnected Interrupt Channel&quot;</span>), 0x80);
<a name="l00663"></a>00663 <span class="preprocessor">#endif</span>
<a name="l00664"></a>00664 <span class="preprocessor"></span>                                identifier++;
<a name="l00665"></a>00665                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#ac7053ef7ac690be3afbbdd985b163f10">l2cap_disconnection_request</a>(hci_handle, identifier, control_scid, control_dcid);
<a name="l00666"></a>00666                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a9b5140e7ca5941e5535c575255ffc1cc">L2CAP_CONTROL_DISCONNECT</a>;
<a name="l00667"></a>00667                         }
<a name="l00668"></a>00668                         <span class="keywordflow">break</span>;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#a9b5140e7ca5941e5535c575255ffc1cc">L2CAP_CONTROL_DISCONNECT</a>:
<a name="l00671"></a>00671                         <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a5d120280be8d502fa0b74d46aa32d3a8">l2cap_check_flag</a>(<a class="code" href="_b_t_d_8h.html#a27057737ae0b2246442511c01eeed192">L2CAP_FLAG_DISCONNECT_CONTROL_RESPONSE</a>)) {
<a name="l00672"></a>00672 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nDisconnected Control Channel&quot;</span>), 0x80);
<a name="l00674"></a>00674 <span class="preprocessor">#endif</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span>                                pBtd-&gt;<a class="code" href="class_b_t_d.html#a1bea5dd793a2f47006b4a7642efc9e56">hci_disconnect</a>(hci_handle);
<a name="l00676"></a>00676                                 hci_handle = -1; <span class="comment">// Reset handle</span>
<a name="l00677"></a>00677                                 l2cap_event_flag = 0; <span class="comment">// Reset flags</span>
<a name="l00678"></a>00678                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a15cc1db556ad9a4ec6144ca8a42f8919">L2CAP_WAIT</a>;
<a name="l00679"></a>00679                         }
<a name="l00680"></a>00680                         <span class="keywordflow">break</span>;
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682 }
<a name="l00683"></a>00683 
<a name="l00684"></a><a class="code" href="class_w_i_i.html#ac5cd06f3e9aa2a0d9b9691f00c047e72">00684</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#ac5cd06f3e9aa2a0d9b9691f00c047e72">WII::Run</a>() {
<a name="l00685"></a>00685         <span class="keywordflow">if</span>(l2cap_state == <a class="code" href="_b_t_d_8h.html#ab569b2085ad29f41d1da9c0ed352bd65">L2CAP_INTERRUPT_DISCONNECT</a> &amp;&amp; millis() &gt; timer)
<a name="l00686"></a>00686                 L2CAP_task(); <span class="comment">// Call the rest of the disconnection routine after we have waited long enough</span>
<a name="l00687"></a>00687 
<a name="l00688"></a>00688         <span class="keywordflow">switch</span>(l2cap_state) {
<a name="l00689"></a>00689                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#a15cc1db556ad9a4ec6144ca8a42f8919">L2CAP_WAIT</a>:
<a name="l00690"></a>00690                         <span class="keywordflow">if</span>(pBtd-&gt;<a class="code" href="class_b_t_d.html#ac7caac80fb6f5f0e794af3644887d88e">connectToWii</a> &amp;&amp; !pBtd-&gt;<a class="code" href="class_b_t_d.html#a0f1c28a03bcbe62cc7c083f97ea27594">l2capConnectionClaimed</a> &amp;&amp; !<a class="code" href="class_w_i_i.html#ae25a8ea1b0713801e0209e795b4596fa">wiimoteConnected</a> &amp;&amp; !activeConnection) {
<a name="l00691"></a>00691                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#a0f1c28a03bcbe62cc7c083f97ea27594">l2capConnectionClaimed</a> = <span class="keyword">true</span>;
<a name="l00692"></a>00692                                 activeConnection = <span class="keyword">true</span>;
<a name="l00693"></a>00693                                 motionPlusInside = pBtd-&gt;<a class="code" href="class_b_t_d.html#a3aea445b2349e99ef057db1a4ffdd9dc">motionPlusInside</a>;
<a name="l00694"></a>00694 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nSend HID Control Connection Request&quot;</span>), 0x80);
<a name="l00696"></a>00696 <span class="preprocessor">#endif</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>                                hci_handle = pBtd-&gt;<a class="code" href="class_b_t_d.html#aa3bb6c692701cb33dfad1ea4d68b6f98">hci_handle</a>; <span class="comment">// Store the HCI Handle for the connection</span>
<a name="l00698"></a>00698                                 l2cap_event_flag = 0; <span class="comment">// Reset flags</span>
<a name="l00699"></a>00699                                 identifier = 0;
<a name="l00700"></a>00700                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#a55cf412a2053972a353b1ab964ca9d3e">l2cap_connection_request</a>(hci_handle, identifier, control_dcid, <a class="code" href="_b_t_d_8h.html#a1465673868452307bcdab8e201430c27">HID_CTRL_PSM</a>);
<a name="l00701"></a>00701                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a68bcdd68c269cd7970d5271a00bbe5fe">L2CAP_CONTROL_CONNECT_REQUEST</a>;
<a name="l00702"></a>00702                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="_b_t_d_8h.html#a5d120280be8d502fa0b74d46aa32d3a8">l2cap_check_flag</a>(<a class="code" href="_b_t_d_8h.html#a969a1ee84797f3ee5006c41f67373f96">L2CAP_FLAG_CONNECTION_CONTROL_REQUEST</a>)) {
<a name="l00703"></a>00703 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00704"></a>00704 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nHID Control Incoming Connection Request&quot;</span>), 0x80);
<a name="l00705"></a>00705 <span class="preprocessor">#endif</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span>                                pBtd-&gt;<a class="code" href="class_b_t_d.html#a7d34c62b1d561679dea5cd27356b38a7">l2cap_connection_response</a>(hci_handle, identifier, control_dcid, control_scid, <a class="code" href="_b_t_d_8h.html#a9960d0d5ae92fc92c70bbb84c2a5c0cc">PENDING</a>);
<a name="l00707"></a>00707                                 delay(1);
<a name="l00708"></a>00708                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#a7d34c62b1d561679dea5cd27356b38a7">l2cap_connection_response</a>(hci_handle, identifier, control_dcid, control_scid, <a class="code" href="_b_t_d_8h.html#a1be7a56cdddcdb7dedf16d4dee381e93">SUCCESSFUL</a>);
<a name="l00709"></a>00709                                 identifier++;
<a name="l00710"></a>00710                                 delay(1);
<a name="l00711"></a>00711                                 pBtd-&gt;<a class="code" href="class_b_t_d.html#ab646a59311344966f139bb3b78f30233">l2cap_config_request</a>(hci_handle, identifier, control_scid);
<a name="l00712"></a>00712                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#abac08b5b24a1cd2b12517cd9aa6c616b">L2CAP_CONTROL_SUCCESS</a>;
<a name="l00713"></a>00713                         }
<a name="l00714"></a>00714                         <span class="keywordflow">break</span>;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#a11b0db0910ac44ec8b090647d6a71088">WII_CHECK_MOTION_PLUS_STATE</a>:
<a name="l00717"></a>00717 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00718"></a>00718 <span class="preprocessor"></span>                        <span class="keywordflow">if</span>(stateCounter == 0) <span class="comment">// Only print onnce</span>
<a name="l00719"></a>00719                                 Notify(PSTR(<span class="stringliteral">&quot;\r\nChecking if a Motion Plus is connected&quot;</span>), 0x80);
<a name="l00720"></a>00720 <span class="preprocessor">#endif</span>
<a name="l00721"></a>00721 <span class="preprocessor"></span>                        stateCounter++;
<a name="l00722"></a>00722                         <span class="keywordflow">if</span>(stateCounter % 200 == 0)
<a name="l00723"></a>00723                                 checkMotionPresent(); <span class="comment">// Check if there is a motion plus connected</span>
<a name="l00724"></a>00724                         <span class="keywordflow">if</span>(<a class="code" href="_wii_8h.html#ac551aee34d131e9407d9e0ede81e9cbe">wii_check_flag</a>(<a class="code" href="_wii_8h.html#a34631633d4557244dc8eda52e8505acd">WII_FLAG_MOTION_PLUS_CONNECTED</a>)) {
<a name="l00725"></a>00725                                 stateCounter = 0;
<a name="l00726"></a>00726                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#acdcb0586ca7e9d357279bf4fba8b5257">WII_INIT_MOTION_PLUS_STATE</a>;
<a name="l00727"></a>00727                                 timer = micros();
<a name="l00728"></a>00728 
<a name="l00729"></a>00729                                 <span class="keywordflow">if</span>(unknownExtensionConnected) {
<a name="l00730"></a>00730 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00731"></a>00731 <span class="preprocessor"></span>                                        Notify(PSTR(<span class="stringliteral">&quot;\r\nA extension is also connected&quot;</span>), 0x80);
<a name="l00732"></a>00732 <span class="preprocessor">#endif</span>
<a name="l00733"></a>00733 <span class="preprocessor"></span>                                        activateNunchuck = <span class="keyword">true</span>; <span class="comment">// For we will just set this to true as this the only extension supported so far</span>
<a name="l00734"></a>00734                                 }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 601) { <span class="comment">// We will try three times to check for the motion plus</span>
<a name="l00737"></a>00737 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00738"></a>00738 <span class="preprocessor"></span>                                Notify(PSTR(<span class="stringliteral">&quot;\r\nNo Motion Plus was detected&quot;</span>), 0x80);
<a name="l00739"></a>00739 <span class="preprocessor">#endif</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span>                                stateCounter = 0;
<a name="l00741"></a>00741                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a990925c3f1ef4962db33ab74d79976e8">WII_CHECK_EXTENSION_STATE</a>;
<a name="l00742"></a>00742                         }
<a name="l00743"></a>00743                         <span class="keywordflow">break</span>;
<a name="l00744"></a>00744 
<a name="l00745"></a>00745                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#a990925c3f1ef4962db33ab74d79976e8">WII_CHECK_EXTENSION_STATE</a>: <span class="comment">// This is used to check if there is anything plugged in to the extension port</span>
<a name="l00746"></a>00746 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00747"></a>00747 <span class="preprocessor"></span>                        <span class="keywordflow">if</span>(stateCounter == 0) <span class="comment">// Only print onnce</span>
<a name="l00748"></a>00748                                 Notify(PSTR(<span class="stringliteral">&quot;\r\nChecking if there is any extension connected&quot;</span>), 0x80);
<a name="l00749"></a>00749 <span class="preprocessor">#endif</span>
<a name="l00750"></a>00750 <span class="preprocessor"></span>                        stateCounter++; <span class="comment">// We use this counter as there has to be a short delay between the commands</span>
<a name="l00751"></a>00751                         <span class="keywordflow">if</span>(stateCounter == 1)
<a name="l00752"></a>00752                                 statusRequest(); <span class="comment">// See if a new device has connected</span>
<a name="l00753"></a>00753                         <span class="keywordflow">if</span>(stateCounter == 100) {
<a name="l00754"></a>00754                                 <span class="keywordflow">if</span>(unknownExtensionConnected) <span class="comment">// Check if there is a extension is connected to the port</span>
<a name="l00755"></a>00755                                         initExtension1();
<a name="l00756"></a>00756                                 <span class="keywordflow">else</span>
<a name="l00757"></a>00757                                         stateCounter = 399;
<a name="l00758"></a>00758                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 200)
<a name="l00759"></a>00759                                 initExtension2();
<a name="l00760"></a>00760                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 300) {
<a name="l00761"></a>00761                                 readExtensionType();
<a name="l00762"></a>00762                                 unknownExtensionConnected = <span class="keyword">false</span>;
<a name="l00763"></a>00763                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 400) {
<a name="l00764"></a>00764                                 stateCounter = 0;
<a name="l00765"></a>00765                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a6b3038e881952934873fd533de842670">TURN_ON_LED</a>;
<a name="l00766"></a>00766                         }
<a name="l00767"></a>00767                         <span class="keywordflow">break</span>;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#acdcb0586ca7e9d357279bf4fba8b5257">WII_INIT_MOTION_PLUS_STATE</a>:
<a name="l00770"></a>00770                         stateCounter++;
<a name="l00771"></a>00771                         <span class="keywordflow">if</span>(stateCounter == 1)
<a name="l00772"></a>00772                                 initMotionPlus();
<a name="l00773"></a>00773                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 100)
<a name="l00774"></a>00774                                 activateMotionPlus();
<a name="l00775"></a>00775                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 200)
<a name="l00776"></a>00776                                 readExtensionType(); <span class="comment">// Check if it has been activated</span>
<a name="l00777"></a>00777                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 300) {
<a name="l00778"></a>00778                                 stateCounter = 0;
<a name="l00779"></a>00779                                 unknownExtensionConnected = <span class="keyword">false</span>; <span class="comment">// The motion plus will send a status report when it&#39;s activated, we will set this to false so it doesn&#39;t reinitialize the Motion Plus</span>
<a name="l00780"></a>00780                                 l2cap_state = <a class="code" href="_b_t_d_8h.html#a6b3038e881952934873fd533de842670">TURN_ON_LED</a>;
<a name="l00781"></a>00781                         }
<a name="l00782"></a>00782                         <span class="keywordflow">break</span>;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#a6b3038e881952934873fd533de842670">TURN_ON_LED</a>:
<a name="l00785"></a>00785                         <span class="keywordflow">if</span>(<a class="code" href="_wii_8h.html#ac551aee34d131e9407d9e0ede81e9cbe">wii_check_flag</a>(<a class="code" href="_wii_8h.html#ae0ff99c8862a05df8877329982e1ef61">WII_FLAG_NUNCHUCK_CONNECTED</a>))
<a name="l00786"></a>00786                                 <a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a> = <span class="keyword">true</span>;
<a name="l00787"></a>00787                         <a class="code" href="class_w_i_i.html#ae25a8ea1b0713801e0209e795b4596fa">wiimoteConnected</a> = <span class="keyword">true</span>;
<a name="l00788"></a>00788                         onInit();
<a name="l00789"></a>00789                         l2cap_state = <a class="code" href="_b_t_d_8h.html#ae4da52ca67e1f8b977199b24e8f3a400">L2CAP_DONE</a>;
<a name="l00790"></a>00790                         <span class="keywordflow">break</span>;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792                 <span class="keywordflow">case</span> <a class="code" href="_b_t_d_8h.html#ae4da52ca67e1f8b977199b24e8f3a400">L2CAP_DONE</a>:
<a name="l00793"></a>00793                         <span class="keywordflow">if</span>(unknownExtensionConnected) {
<a name="l00794"></a>00794 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00795"></a>00795 <span class="preprocessor"></span>                                <span class="keywordflow">if</span>(stateCounter == 0) <span class="comment">// Only print once</span>
<a name="l00796"></a>00796                                         Notify(PSTR(<span class="stringliteral">&quot;\r\nChecking extension port&quot;</span>), 0x80);
<a name="l00797"></a>00797 <span class="preprocessor">#endif</span>
<a name="l00798"></a>00798 <span class="preprocessor"></span>                                stateCounter++; <span class="comment">// We will use this counter as there has to be a short delay between the commands</span>
<a name="l00799"></a>00799                                 <span class="keywordflow">if</span>(stateCounter == 50)
<a name="l00800"></a>00800                                         statusRequest();
<a name="l00801"></a>00801                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 100)
<a name="l00802"></a>00802                                         initExtension1();
<a name="l00803"></a>00803                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 150)
<a name="l00804"></a>00804                                         <span class="keywordflow">if</span>((extensionConnected &amp;&amp; <a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a>) || (unknownExtensionConnected &amp;&amp; !<a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a>))
<a name="l00805"></a>00805                                                 initExtension2();
<a name="l00806"></a>00806                                         <span class="keywordflow">else</span>
<a name="l00807"></a>00807                                                 stateCounter = 299; <span class="comment">// There is no extension connected</span>
<a name="l00808"></a>00808                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 200)
<a name="l00809"></a>00809                                         readExtensionType();
<a name="l00810"></a>00810                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 250) {
<a name="l00811"></a>00811                                         <span class="keywordflow">if</span>(<a class="code" href="_wii_8h.html#ac551aee34d131e9407d9e0ede81e9cbe">wii_check_flag</a>(<a class="code" href="_wii_8h.html#ae0ff99c8862a05df8877329982e1ef61">WII_FLAG_NUNCHUCK_CONNECTED</a>)) {
<a name="l00812"></a>00812 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00813"></a>00813 <span class="preprocessor"></span>                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nNunchuck was reconnected&quot;</span>), 0x80);
<a name="l00814"></a>00814 <span class="preprocessor">#endif</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span>                                                activateNunchuck = <span class="keyword">true</span>;
<a name="l00816"></a>00816                                                 <a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a> = <span class="keyword">true</span>;
<a name="l00817"></a>00817                                         }
<a name="l00818"></a>00818                                         <span class="keywordflow">if</span>(!<a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a>)
<a name="l00819"></a>00819                                                 stateCounter = 449;
<a name="l00820"></a>00820                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 300) {
<a name="l00821"></a>00821                                         <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a>) {
<a name="l00822"></a>00822 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00823"></a>00823 <span class="preprocessor"></span>                                                Notify(PSTR(<span class="stringliteral">&quot;\r\nReactivating the Motion Plus&quot;</span>), 0x80);
<a name="l00824"></a>00824 <span class="preprocessor">#endif</span>
<a name="l00825"></a>00825 <span class="preprocessor"></span>                                                initMotionPlus();
<a name="l00826"></a>00826                                         } <span class="keywordflow">else</span>
<a name="l00827"></a>00827                                                 stateCounter = 449;
<a name="l00828"></a>00828                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 350)
<a name="l00829"></a>00829                                         activateMotionPlus();
<a name="l00830"></a>00830                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 400)
<a name="l00831"></a>00831                                         readExtensionType(); <span class="comment">// Check if it has been activated</span>
<a name="l00832"></a>00832                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stateCounter == 450) {
<a name="l00833"></a>00833                                         onInit();
<a name="l00834"></a>00834                                         stateCounter = 0;
<a name="l00835"></a>00835                                         unknownExtensionConnected = <span class="keyword">false</span>;
<a name="l00836"></a>00836                                 }
<a name="l00837"></a>00837                         } <span class="keywordflow">else</span>
<a name="l00838"></a>00838                                 stateCounter = 0;
<a name="l00839"></a>00839                         <span class="keywordflow">break</span>;
<a name="l00840"></a>00840         }
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 <span class="comment">/************************************************************/</span>
<a name="l00844"></a>00844 <span class="comment">/*                    HID Commands                          */</span>
<a name="l00845"></a>00845 
<a name="l00846"></a>00846 <span class="comment">/************************************************************/</span>
<a name="l00847"></a>00847 <span class="keywordtype">void</span> WII::HID_Command(uint8_t* <a class="code" href="masstorage_8h.html#afb87d045bbf32b236fc425efe02bdc7b">data</a>, uint8_t nbytes) {
<a name="l00848"></a>00848         <span class="keywordflow">if</span>(motionPlusInside)
<a name="l00849"></a>00849                 pBtd-&gt;<a class="code" href="class_b_t_d.html#aad7d8ef46e60b48ff4aaabefb0b290e7">L2CAP_Command</a>(hci_handle, data, nbytes, interrupt_scid[0], interrupt_scid[1]); <span class="comment">// It&#39;s the new Wiimote with the Motion Plus Inside or Wii U Pro controller</span>
<a name="l00850"></a>00850         <span class="keywordflow">else</span>
<a name="l00851"></a>00851                 pBtd-&gt;<a class="code" href="class_b_t_d.html#aad7d8ef46e60b48ff4aaabefb0b290e7">L2CAP_Command</a>(hci_handle, data, nbytes, control_scid[0], control_scid[1]);
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
<a name="l00854"></a><a class="code" href="class_w_i_i.html#a6e97bfcfb134b63d7190ba1bc326e1d3">00854</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#a6e97bfcfb134b63d7190ba1bc326e1d3">WII::setAllOff</a>() {
<a name="l00855"></a>00855         HIDBuffer[1] = 0x11;
<a name="l00856"></a>00856         HIDBuffer[2] = 0x00;
<a name="l00857"></a>00857         HID_Command(HIDBuffer, 3);
<a name="l00858"></a>00858 }
<a name="l00859"></a>00859 
<a name="l00860"></a><a class="code" href="class_w_i_i.html#a2c5c32841b020b248f757cb793acb936">00860</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#a2c5c32841b020b248f757cb793acb936">WII::setRumbleOff</a>() {
<a name="l00861"></a>00861         HIDBuffer[1] = 0x11;
<a name="l00862"></a>00862         HIDBuffer[2] &amp;= ~0x01; <span class="comment">// Bit 0 control the rumble</span>
<a name="l00863"></a>00863         HID_Command(HIDBuffer, 3);
<a name="l00864"></a>00864 }
<a name="l00865"></a>00865 
<a name="l00866"></a><a class="code" href="class_w_i_i.html#a0d9c869bd3677c4488a586c38558a137">00866</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#a0d9c869bd3677c4488a586c38558a137">WII::setRumbleOn</a>() {
<a name="l00867"></a>00867         HIDBuffer[1] = 0x11;
<a name="l00868"></a>00868         HIDBuffer[2] |= 0x01; <span class="comment">// Bit 0 control the rumble</span>
<a name="l00869"></a>00869         HID_Command(HIDBuffer, 3);
<a name="l00870"></a>00870 }
<a name="l00871"></a>00871 
<a name="l00872"></a><a class="code" href="class_w_i_i.html#a841396b533cccccb05db37d35f6fef9c">00872</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#a841396b533cccccb05db37d35f6fef9c">WII::setRumbleToggle</a>() {
<a name="l00873"></a>00873         HIDBuffer[1] = 0x11;
<a name="l00874"></a>00874         HIDBuffer[2] ^= 0x01; <span class="comment">// Bit 0 control the rumble</span>
<a name="l00875"></a>00875         HID_Command(HIDBuffer, 3);
<a name="l00876"></a>00876 }
<a name="l00877"></a>00877 
<a name="l00878"></a><a class="code" href="class_w_i_i.html#ae7e07f929fba8f0ff061a1405baa2b58">00878</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#ae7e07f929fba8f0ff061a1405baa2b58">WII::setLedRaw</a>(uint8_t value) {
<a name="l00879"></a>00879         HIDBuffer[1] = 0x11;
<a name="l00880"></a>00880         HIDBuffer[2] = value | (HIDBuffer[2] &amp; 0x01); <span class="comment">// Keep the rumble bit</span>
<a name="l00881"></a>00881         HID_Command(HIDBuffer, 3);
<a name="l00882"></a>00882 }
<a name="l00883"></a>00883 
<a name="l00884"></a><a class="code" href="class_w_i_i.html#a60e552c026ac99f2c74b9c3eb9c3a7c9">00884</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#ae3eb7942181a9c9e681e18bd5c8eaef4">WII::setLedOff</a>(<a class="code" href="controller_enums_8h.html#a70df64e026046bc352983127b7ae2cf0">LEDEnum</a> a) {
<a name="l00885"></a>00885         HIDBuffer[1] = 0x11;
<a name="l00886"></a>00886         HIDBuffer[2] &amp;= ~(pgm_read_byte(&amp;WII_LEDS[(uint8_t)a]));
<a name="l00887"></a>00887         HID_Command(HIDBuffer, 3);
<a name="l00888"></a>00888 }
<a name="l00889"></a>00889 
<a name="l00890"></a><a class="code" href="class_w_i_i.html#a38507c76e5d7375a7971bc3a17b87338">00890</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#a38507c76e5d7375a7971bc3a17b87338">WII::setLedOn</a>(<a class="code" href="controller_enums_8h.html#a70df64e026046bc352983127b7ae2cf0">LEDEnum</a> a) {
<a name="l00891"></a>00891         <span class="keywordflow">if</span>(a == <a class="code" href="controller_enums_8h.html#a70df64e026046bc352983127b7ae2cf0aac132f2982b98bcaa3445e535a03ff75">OFF</a>)
<a name="l00892"></a>00892                 <a class="code" href="class_w_i_i.html#ae7e07f929fba8f0ff061a1405baa2b58">setLedRaw</a>(0);
<a name="l00893"></a>00893         <span class="keywordflow">else</span> {
<a name="l00894"></a>00894                 HIDBuffer[1] = 0x11;
<a name="l00895"></a>00895                 HIDBuffer[2] |= pgm_read_byte(&amp;WII_LEDS[(uint8_t)a]);
<a name="l00896"></a>00896                 HID_Command(HIDBuffer, 3);
<a name="l00897"></a>00897         }
<a name="l00898"></a>00898 }
<a name="l00899"></a>00899 
<a name="l00900"></a><a class="code" href="class_w_i_i.html#a8e81eb7d2d78680df0dee1869695ff05">00900</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#a8e81eb7d2d78680df0dee1869695ff05">WII::setLedToggle</a>(<a class="code" href="controller_enums_8h.html#a70df64e026046bc352983127b7ae2cf0">LEDEnum</a> a) {
<a name="l00901"></a>00901         HIDBuffer[1] = 0x11;
<a name="l00902"></a>00902         HIDBuffer[2] ^= pgm_read_byte(&amp;WII_LEDS[(uint8_t)a]);
<a name="l00903"></a>00903         HID_Command(HIDBuffer, 3);
<a name="l00904"></a>00904 }
<a name="l00905"></a>00905 
<a name="l00906"></a><a class="code" href="class_w_i_i.html#a5d3b4a33ebc2ca9ebb154e10a05dbdd4">00906</a> <span class="keywordtype">void</span> <a class="code" href="class_w_i_i.html#a5d3b4a33ebc2ca9ebb154e10a05dbdd4">WII::setLedStatus</a>() {
<a name="l00907"></a>00907         HIDBuffer[1] = 0x11;
<a name="l00908"></a>00908         HIDBuffer[2] = (HIDBuffer[2] &amp; 0x01); <span class="comment">// Keep the rumble bit</span>
<a name="l00909"></a>00909         <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#ae25a8ea1b0713801e0209e795b4596fa">wiimoteConnected</a>)
<a name="l00910"></a>00910                 HIDBuffer[2] |= 0x10; <span class="comment">// If it&#39;s connected LED1 will light up</span>
<a name="l00911"></a>00911         <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a72bd4fad2e524276712a154b8cc2a16c">motionPlusConnected</a>)
<a name="l00912"></a>00912                 HIDBuffer[2] |= 0x20; <span class="comment">// If it&#39;s connected LED2 will light up</span>
<a name="l00913"></a>00913         <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a>)
<a name="l00914"></a>00914                 HIDBuffer[2] |= 0x40; <span class="comment">// If it&#39;s connected LED3 will light up</span>
<a name="l00915"></a>00915 
<a name="l00916"></a>00916         HID_Command(HIDBuffer, 3);
<a name="l00917"></a>00917 }
<a name="l00918"></a>00918 
<a name="l00919"></a><a class="code" href="class_w_i_i.html#ae946f7d6e9ce89fb083f5f138c0736c2">00919</a> uint8_t <a class="code" href="class_w_i_i.html#ae946f7d6e9ce89fb083f5f138c0736c2">WII::getBatteryLevel</a>() {
<a name="l00920"></a>00920         checkExtension = <span class="keyword">false</span>; <span class="comment">// This is needed so the library knows that the status response is a response to this function</span>
<a name="l00921"></a>00921         statusRequest(); <span class="comment">// This will update the battery level</span>
<a name="l00922"></a>00922         <span class="keywordflow">return</span> batteryLevel;
<a name="l00923"></a>00923 };
<a name="l00924"></a>00924 
<a name="l00925"></a>00925 <span class="keywordtype">void</span> WII::setReportMode(<span class="keywordtype">bool</span> continuous, uint8_t mode) {
<a name="l00926"></a>00926         uint8_t cmd_buf[4];
<a name="l00927"></a>00927         cmd_buf[0] = 0xA2; <span class="comment">// HID BT DATA_request (0xA0) | Report Type (Output 0x02)</span>
<a name="l00928"></a>00928         cmd_buf[1] = 0x12;
<a name="l00929"></a>00929         <span class="keywordflow">if</span>(continuous)
<a name="l00930"></a>00930                 cmd_buf[2] = 0x04 | (HIDBuffer[2] &amp; 0x01); <span class="comment">// Keep the rumble bit</span>
<a name="l00931"></a>00931         <span class="keywordflow">else</span>
<a name="l00932"></a>00932                 cmd_buf[2] = 0x00 | (HIDBuffer[2] &amp; 0x01); <span class="comment">// Keep the rumble bit</span>
<a name="l00933"></a>00933         cmd_buf[3] = mode;
<a name="l00934"></a>00934         HID_Command(cmd_buf, 4);
<a name="l00935"></a>00935 }
<a name="l00936"></a>00936 
<a name="l00937"></a>00937 <span class="keywordtype">void</span> WII::statusRequest() {
<a name="l00938"></a>00938         uint8_t cmd_buf[3];
<a name="l00939"></a>00939         cmd_buf[0] = 0xA2; <span class="comment">// HID BT DATA_request (0xA0) | Report Type (Output 0x02)</span>
<a name="l00940"></a>00940         cmd_buf[1] = 0x15;
<a name="l00941"></a>00941         cmd_buf[2] = (HIDBuffer[2] &amp; 0x01); <span class="comment">// Keep the rumble bit</span>
<a name="l00942"></a>00942         HID_Command(cmd_buf, 3);
<a name="l00943"></a>00943 }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945 <span class="comment">/************************************************************/</span>
<a name="l00946"></a>00946 <span class="comment">/*                    Memmory Commands                      */</span>
<a name="l00947"></a>00947 
<a name="l00948"></a>00948 <span class="comment">/************************************************************/</span>
<a name="l00949"></a>00949 <span class="keywordtype">void</span> WII::writeData(uint32_t offset, uint8_t size, uint8_t* data) {
<a name="l00950"></a>00950         uint8_t cmd_buf[23];
<a name="l00951"></a>00951         cmd_buf[0] = 0xA2; <span class="comment">// HID BT DATA_request (0xA0) | Report Type (Output 0x02)</span>
<a name="l00952"></a>00952         cmd_buf[1] = 0x16; <span class="comment">// Write data</span>
<a name="l00953"></a>00953         cmd_buf[2] = 0x04 | (HIDBuffer[2] &amp; 0x01); <span class="comment">// Write to memory, clear bit 2 to write to EEPROM</span>
<a name="l00954"></a>00954         cmd_buf[3] = (uint8_t)((offset &amp; 0xFF0000) &gt;&gt; 16);
<a name="l00955"></a>00955         cmd_buf[4] = (uint8_t)((offset &amp; 0xFF00) &gt;&gt; 8);
<a name="l00956"></a>00956         cmd_buf[5] = (uint8_t)(offset &amp; 0xFF);
<a name="l00957"></a>00957         cmd_buf[6] = size;
<a name="l00958"></a>00958         uint8_t i = 0;
<a name="l00959"></a>00959         <span class="keywordflow">for</span>(; i &lt; size; i++)
<a name="l00960"></a>00960                 cmd_buf[7 + i] = data[i];
<a name="l00961"></a>00961         <span class="keywordflow">for</span>(; i &lt; 16; i++) <span class="comment">// Set the rest to zero</span>
<a name="l00962"></a>00962                 cmd_buf[7 + i] = 0x00;
<a name="l00963"></a>00963         HID_Command(cmd_buf, 23);
<a name="l00964"></a>00964 }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 <span class="keywordtype">void</span> WII::initExtension1() {
<a name="l00967"></a>00967         uint8_t buf[1];
<a name="l00968"></a>00968         buf[0] = 0x55;
<a name="l00969"></a>00969         writeData(0xA400F0, 1, buf);
<a name="l00970"></a>00970 }
<a name="l00971"></a>00971 
<a name="l00972"></a>00972 <span class="keywordtype">void</span> WII::initExtension2() {
<a name="l00973"></a>00973         uint8_t buf[1];
<a name="l00974"></a>00974         buf[0] = 0x00;
<a name="l00975"></a>00975         writeData(0xA400FB, 1, buf);
<a name="l00976"></a>00976 }
<a name="l00977"></a>00977 
<a name="l00978"></a>00978 <span class="keywordtype">void</span> WII::initMotionPlus() {
<a name="l00979"></a>00979         uint8_t buf[1];
<a name="l00980"></a>00980         buf[0] = 0x55;
<a name="l00981"></a>00981         writeData(0xA600F0, 1, buf);
<a name="l00982"></a>00982 }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984 <span class="keywordtype">void</span> WII::activateMotionPlus() {
<a name="l00985"></a>00985         uint8_t buf[1];
<a name="l00986"></a>00986         <span class="keywordflow">if</span>(pBtd-&gt;<a class="code" href="class_b_t_d.html#a962a5714c225dcb633434f02e3657583">wiiUProController</a>) {
<a name="l00987"></a>00987 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00988"></a>00988 <span class="preprocessor"></span>                Notify(PSTR(<span class="stringliteral">&quot;\r\nActivating Wii U Pro Controller&quot;</span>), 0x80);
<a name="l00989"></a>00989 <span class="preprocessor">#endif</span>
<a name="l00990"></a>00990 <span class="preprocessor"></span>                buf[0] = 0x00; <span class="comment">// It seems like you can send anything but 0x04, 0x05, and 0x07</span>
<a name="l00991"></a>00991         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(activateNunchuck) {
<a name="l00992"></a>00992 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l00993"></a>00993 <span class="preprocessor"></span>                Notify(PSTR(<span class="stringliteral">&quot;\r\nActivating Motion Plus in pass-through mode&quot;</span>), 0x80);
<a name="l00994"></a>00994 <span class="preprocessor">#endif</span>
<a name="l00995"></a>00995 <span class="preprocessor"></span>                buf[0] = 0x05; <span class="comment">// Activate nunchuck pass-through mode</span>
<a name="l00996"></a>00996         }<span class="comment">//else if(classicControllerConnected &amp;&amp; extensionConnected)</span>
<a name="l00997"></a>00997                 <span class="comment">//buf[0] = 0x07;</span>
<a name="l00998"></a>00998         <span class="keywordflow">else</span> {
<a name="l00999"></a>00999 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01000"></a>01000 <span class="preprocessor"></span>                Notify(PSTR(<span class="stringliteral">&quot;\r\nActivating Motion Plus in normal mode&quot;</span>), 0x80);
<a name="l01001"></a>01001 <span class="preprocessor">#endif</span>
<a name="l01002"></a>01002 <span class="preprocessor"></span>                buf[0] = 0x04; <span class="comment">// Don&#39;t use any extension</span>
<a name="l01003"></a>01003         }
<a name="l01004"></a>01004         writeData(0xA600FE, 1, buf);
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007 <span class="keywordtype">void</span> WII::readData(uint32_t offset, uint16_t size, <span class="keywordtype">bool</span> <a class="code" href="_e_e_p_r_o_m_8cpp.html#a8c17b9f346b7ef4b4c79d467de251bec">EEPROM</a>) {
<a name="l01008"></a>01008         uint8_t cmd_buf[8];
<a name="l01009"></a>01009         cmd_buf[0] = 0xA2; <span class="comment">// HID BT DATA_request (0xA0) | Report Type (Output 0x02)</span>
<a name="l01010"></a>01010         cmd_buf[1] = 0x17; <span class="comment">// Read data</span>
<a name="l01011"></a>01011         <span class="keywordflow">if</span>(EEPROM)
<a name="l01012"></a>01012                 cmd_buf[2] = 0x00 | (HIDBuffer[2] &amp; 0x01); <span class="comment">// Read from EEPROM</span>
<a name="l01013"></a>01013         <span class="keywordflow">else</span>
<a name="l01014"></a>01014                 cmd_buf[2] = 0x04 | (HIDBuffer[2] &amp; 0x01); <span class="comment">// Read from memory</span>
<a name="l01015"></a>01015         cmd_buf[3] = (uint8_t)((offset &amp; 0xFF0000) &gt;&gt; 16);
<a name="l01016"></a>01016         cmd_buf[4] = (uint8_t)((offset &amp; 0xFF00) &gt;&gt; 8);
<a name="l01017"></a>01017         cmd_buf[5] = (uint8_t)(offset &amp; 0xFF);
<a name="l01018"></a>01018         cmd_buf[6] = (uint8_t)((size &amp; 0xFF00) &gt;&gt; 8);
<a name="l01019"></a>01019         cmd_buf[7] = (uint8_t)(size &amp; 0xFF);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021         HID_Command(cmd_buf, 8);
<a name="l01022"></a>01022 }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024 <span class="keywordtype">void</span> WII::readExtensionType() {
<a name="l01025"></a>01025         readData(0xA400FA, 6, <span class="keyword">false</span>);
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028 <span class="keywordtype">void</span> WII::readCalData() {
<a name="l01029"></a>01029         readData(0x0016, 8, <span class="keyword">true</span>);
<a name="l01030"></a>01030 }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032 <span class="keywordtype">void</span> WII::checkMotionPresent() {
<a name="l01033"></a>01033         readData(0xA600FA, 6, <span class="keyword">false</span>);
<a name="l01034"></a>01034 }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036 <span class="comment">/************************************************************/</span>
<a name="l01037"></a>01037 <span class="comment">/*                    WII Commands                          */</span>
<a name="l01038"></a>01038 
<a name="l01039"></a>01039 <span class="comment">/************************************************************/</span>
<a name="l01040"></a>01040 
<a name="l01041"></a><a class="code" href="class_w_i_i.html#a7b183fe1809c1c595438e930b8f3f4de">01041</a> <span class="keywordtype">bool</span> <a class="code" href="class_w_i_i.html#a7b183fe1809c1c595438e930b8f3f4de">WII::getButtonPress</a>(<a class="code" href="controller_enums_8h.html#a94f7389d205c78830a5441370d7870fd">ButtonEnum</a> <a class="code" href="_p_s4_parser_8h.html#a4313c9563516f94387762ab05763456b">b</a>) { <span class="comment">// Return true when a button is pressed</span>
<a name="l01042"></a>01042         <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a461f5b7a5f2bc874e107fc776c284b16">wiiUProControllerConnected</a>)
<a name="l01043"></a>01043                 <span class="keywordflow">return</span> (ButtonState &amp; pgm_read_dword(&amp;WII_PROCONTROLLER_BUTTONS[(uint8_t)b]));
<a name="l01044"></a>01044         <span class="keywordflow">else</span>
<a name="l01045"></a>01045                 <span class="keywordflow">return</span> (ButtonState &amp; pgm_read_dword(&amp;WII_BUTTONS[(uint8_t)b]));
<a name="l01046"></a>01046 }
<a name="l01047"></a>01047 
<a name="l01048"></a><a class="code" href="class_w_i_i.html#ac94e8b9ce6d3f914f0e3ee4fba82efa3">01048</a> <span class="keywordtype">bool</span> <a class="code" href="class_w_i_i.html#ac94e8b9ce6d3f914f0e3ee4fba82efa3">WII::getButtonClick</a>(<a class="code" href="controller_enums_8h.html#a94f7389d205c78830a5441370d7870fd">ButtonEnum</a> <a class="code" href="_p_s4_parser_8h.html#a4313c9563516f94387762ab05763456b">b</a>) { <span class="comment">// Only return true when a button is clicked</span>
<a name="l01049"></a>01049         uint32_t button;
<a name="l01050"></a>01050         <span class="keywordflow">if</span>(<a class="code" href="class_w_i_i.html#a461f5b7a5f2bc874e107fc776c284b16">wiiUProControllerConnected</a>)
<a name="l01051"></a>01051                 button = pgm_read_dword(&amp;WII_PROCONTROLLER_BUTTONS[(uint8_t)b]);
<a name="l01052"></a>01052         <span class="keywordflow">else</span>
<a name="l01053"></a>01053                 button = pgm_read_dword(&amp;WII_BUTTONS[(uint8_t)b]);
<a name="l01054"></a>01054         <span class="keywordtype">bool</span> click = (ButtonClickState &amp; button);
<a name="l01055"></a>01055         ButtonClickState &amp;= ~button; <span class="comment">// clear &quot;click&quot; event</span>
<a name="l01056"></a>01056         <span class="keywordflow">return</span> click;
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01059"></a><a class="code" href="class_w_i_i.html#a8e34abf62a9631ca3efba0150ca91b93">01059</a> uint8_t <a class="code" href="class_w_i_i.html#a8e34abf62a9631ca3efba0150ca91b93">WII::getAnalogHat</a>(<a class="code" href="_wii_8h.html#ad79e49e27b025d6ac9d695c4816f84d4">HatEnum</a> a) {
<a name="l01060"></a>01060         <span class="keywordflow">if</span>(!<a class="code" href="class_w_i_i.html#a7cb4cec343c65fd350e6b05043d7f1a8">nunchuckConnected</a>)
<a name="l01061"></a>01061                 <span class="keywordflow">return</span> 127; <span class="comment">// Return center position</span>
<a name="l01062"></a>01062         <span class="keywordflow">else</span> {
<a name="l01063"></a>01063                 uint8_t output = hatValues[(uint8_t)a];
<a name="l01064"></a>01064                 <span class="keywordflow">if</span>(output == 0xFF || output == 0x00) <span class="comment">// The joystick will only read 255 or 0 when the cable is unplugged or initializing, so we will just return the center position</span>
<a name="l01065"></a>01065                         <span class="keywordflow">return</span> 127;
<a name="l01066"></a>01066                 <span class="keywordflow">else</span>
<a name="l01067"></a>01067                         <span class="keywordflow">return</span> output;
<a name="l01068"></a>01068         }
<a name="l01069"></a>01069 }
<a name="l01070"></a>01070 
<a name="l01071"></a><a class="code" href="class_w_i_i.html#a9f88f608bd002270797dd3bc25900f1e">01071</a> uint16_t <a class="code" href="class_w_i_i.html#a8e34abf62a9631ca3efba0150ca91b93">WII::getAnalogHat</a>(<a class="code" href="controller_enums_8h.html#a34dad8f0a0927471137c403216597093">AnalogHatEnum</a> a) {
<a name="l01072"></a>01072         <span class="keywordflow">if</span>(!<a class="code" href="class_w_i_i.html#a461f5b7a5f2bc874e107fc776c284b16">wiiUProControllerConnected</a>)
<a name="l01073"></a>01073                 <span class="keywordflow">return</span> 2000;
<a name="l01074"></a>01074         <span class="keywordflow">else</span> {
<a name="l01075"></a>01075                 uint16_t output = hatValues[(uint8_t)a];
<a name="l01076"></a>01076                 <span class="keywordflow">if</span>(output == 0x00) <span class="comment">// The joystick will only read 0 when it is first initializing, so we will just return the center position</span>
<a name="l01077"></a>01077                         <span class="keywordflow">return</span> 2000;
<a name="l01078"></a>01078                 <span class="keywordflow">else</span>
<a name="l01079"></a>01079                         <span class="keywordflow">return</span> output;
<a name="l01080"></a>01080         }
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083 <span class="keywordtype">void</span> WII::onInit() {
<a name="l01084"></a>01084         <span class="keywordflow">if</span>(pFuncOnInit)
<a name="l01085"></a>01085                 pFuncOnInit(); <span class="comment">// Call the user function</span>
<a name="l01086"></a>01086         <span class="keywordflow">else</span>
<a name="l01087"></a>01087                 <a class="code" href="class_w_i_i.html#a5d3b4a33ebc2ca9ebb154e10a05dbdd4">setLedStatus</a>();
<a name="l01088"></a>01088 }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090 <span class="comment">/************************************************************/</span>
<a name="l01091"></a>01091 <span class="comment">/*       The following functions are for the IR camera      */</span>
<a name="l01092"></a>01092 <span class="comment">/************************************************************/</span>
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 <span class="preprocessor">#ifdef WIICAMERA</span>
<a name="l01095"></a>01095 <span class="preprocessor"></span>
<a name="l01096"></a>01096 <span class="keywordtype">void</span> WII::IRinitialize() { <span class="comment">// Turns on and initialises the IR camera</span>
<a name="l01097"></a>01097 
<a name="l01098"></a>01098         enableIRCamera1();
<a name="l01099"></a>01099 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01100"></a>01100 <span class="preprocessor"></span>        Notify(PSTR(<span class="stringliteral">&quot;\r\nEnable IR Camera1 Complete&quot;</span>), 0x80);
<a name="l01101"></a>01101 <span class="preprocessor">#endif</span>
<a name="l01102"></a>01102 <span class="preprocessor"></span>        delay(80);
<a name="l01103"></a>01103 
<a name="l01104"></a>01104         enableIRCamera2();
<a name="l01105"></a>01105 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01106"></a>01106 <span class="preprocessor"></span>        Notify(PSTR(<span class="stringliteral">&quot;\r\nEnable IR Camera2 Complete&quot;</span>), 0x80);
<a name="l01107"></a>01107 <span class="preprocessor">#endif</span>
<a name="l01108"></a>01108 <span class="preprocessor"></span>        delay(80);
<a name="l01109"></a>01109 
<a name="l01110"></a>01110         write0x08Value();
<a name="l01111"></a>01111 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01112"></a>01112 <span class="preprocessor"></span>        Notify(PSTR(<span class="stringliteral">&quot;\r\nWrote hex number 0x08&quot;</span>), 0x80);
<a name="l01113"></a>01113 <span class="preprocessor">#endif</span>
<a name="l01114"></a>01114 <span class="preprocessor"></span>        delay(80);
<a name="l01115"></a>01115 
<a name="l01116"></a>01116         writeSensitivityBlock1();
<a name="l01117"></a>01117 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01118"></a>01118 <span class="preprocessor"></span>        Notify(PSTR(<span class="stringliteral">&quot;\r\nWrote Sensitivity Block 1&quot;</span>), 0x80);
<a name="l01119"></a>01119 <span class="preprocessor">#endif</span>
<a name="l01120"></a>01120 <span class="preprocessor"></span>        delay(80);
<a name="l01121"></a>01121 
<a name="l01122"></a>01122         writeSensitivityBlock2();
<a name="l01123"></a>01123 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01124"></a>01124 <span class="preprocessor"></span>        Notify(PSTR(<span class="stringliteral">&quot;\r\nWrote Sensitivity Block 2&quot;</span>), 0x80);
<a name="l01125"></a>01125 <span class="preprocessor">#endif</span>
<a name="l01126"></a>01126 <span class="preprocessor"></span>        delay(80);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128         uint8_t mode_num = 0x03;
<a name="l01129"></a>01129         setWiiModeNumber(mode_num); <span class="comment">// Change input for whatever mode you want i.e. 0x01, 0x03, or 0x05</span>
<a name="l01130"></a>01130 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01131"></a>01131 <span class="preprocessor"></span>        Notify(PSTR(<span class="stringliteral">&quot;\r\nSet Wii Mode Number To 0x&quot;</span>), 0x80);
<a name="l01132"></a>01132         D_PrintHex&lt;uint8_t &gt; (mode_num, 0x80);
<a name="l01133"></a>01133 <span class="preprocessor">#endif</span>
<a name="l01134"></a>01134 <span class="preprocessor"></span>        delay(80);
<a name="l01135"></a>01135 
<a name="l01136"></a>01136         write0x08Value();
<a name="l01137"></a>01137 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01138"></a>01138 <span class="preprocessor"></span>        Notify(PSTR(<span class="stringliteral">&quot;\r\nWrote Hex Number 0x08&quot;</span>), 0x80);
<a name="l01139"></a>01139 <span class="preprocessor">#endif</span>
<a name="l01140"></a>01140 <span class="preprocessor"></span>        delay(80);
<a name="l01141"></a>01141 
<a name="l01142"></a>01142         setReportMode(<span class="keyword">false</span>, 0x33);
<a name="l01143"></a>01143         <span class="comment">//setReportMode(false, 0x3f); // For full reporting mode, doesn&#39;t work yet</span>
<a name="l01144"></a>01144 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01145"></a>01145 <span class="preprocessor"></span>        Notify(PSTR(<span class="stringliteral">&quot;\r\nSet Report Mode to 0x33&quot;</span>), 0x80);
<a name="l01146"></a>01146 <span class="preprocessor">#endif</span>
<a name="l01147"></a>01147 <span class="preprocessor"></span>        delay(80);
<a name="l01148"></a>01148 
<a name="l01149"></a>01149         statusRequest(); <span class="comment">// Used to update wiiState - call isIRCameraEnabled() afterwards to check if it actually worked</span>
<a name="l01150"></a>01150 <span class="preprocessor">#ifdef DEBUG_USB_HOST</span>
<a name="l01151"></a>01151 <span class="preprocessor"></span>        Notify(PSTR(<span class="stringliteral">&quot;\r\nIR Initialized&quot;</span>), 0x80);
<a name="l01152"></a>01152 <span class="preprocessor">#endif</span>
<a name="l01153"></a>01153 <span class="preprocessor"></span>}
<a name="l01154"></a>01154 
<a name="l01155"></a>01155 <span class="keywordtype">void</span> WII::enableIRCamera1() {
<a name="l01156"></a>01156         uint8_t cmd_buf[3];
<a name="l01157"></a>01157         cmd_buf[0] = 0xA2; <span class="comment">// HID BT DATA_request (0xA0) | Report Type (Output 0x02)</span>
<a name="l01158"></a>01158         cmd_buf[1] = 0x13; <span class="comment">// Output report 13</span>
<a name="l01159"></a>01159         cmd_buf[2] = 0x04 | (HIDBuffer[2] &amp; 0x01); <span class="comment">// Keep the rumble bit and sets bit 2</span>
<a name="l01160"></a>01160         HID_Command(cmd_buf, 3);
<a name="l01161"></a>01161 }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163 <span class="keywordtype">void</span> WII::enableIRCamera2() {
<a name="l01164"></a>01164         uint8_t cmd_buf[3];
<a name="l01165"></a>01165         cmd_buf[0] = 0xA2; <span class="comment">// HID BT DATA_request (0xA0) | Report Type (Output 0x02)</span>
<a name="l01166"></a>01166         cmd_buf[1] = 0x1A; <span class="comment">// Output report 1A</span>
<a name="l01167"></a>01167         cmd_buf[2] = 0x04 | (HIDBuffer[2] &amp; 0x01); <span class="comment">// Keep the rumble bit and sets bit 2</span>
<a name="l01168"></a>01168         HID_Command(cmd_buf, 3);
<a name="l01169"></a>01169 }
<a name="l01170"></a>01170 
<a name="l01171"></a>01171 <span class="keywordtype">void</span> WII::writeSensitivityBlock1() {
<a name="l01172"></a>01172         uint8_t buf[9];
<a name="l01173"></a>01173         buf[0] = 0x00;
<a name="l01174"></a>01174         buf[1] = 0x00;
<a name="l01175"></a>01175         buf[2] = 0x00;
<a name="l01176"></a>01176         buf[3] = 0x00;
<a name="l01177"></a>01177         buf[4] = 0x00;
<a name="l01178"></a>01178         buf[5] = 0x00;
<a name="l01179"></a>01179         buf[6] = 0x90;
<a name="l01180"></a>01180         buf[7] = 0x00;
<a name="l01181"></a>01181         buf[8] = 0x41;
<a name="l01182"></a>01182 
<a name="l01183"></a>01183         writeData(0xB00000, 9, buf);
<a name="l01184"></a>01184 }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186 <span class="keywordtype">void</span> WII::writeSensitivityBlock2() {
<a name="l01187"></a>01187         uint8_t buf[2];
<a name="l01188"></a>01188         buf[0] = 0x40;
<a name="l01189"></a>01189         buf[1] = 0x00;
<a name="l01190"></a>01190 
<a name="l01191"></a>01191         writeData(0xB0001A, 2, buf);
<a name="l01192"></a>01192 }
<a name="l01193"></a>01193 
<a name="l01194"></a>01194 <span class="keywordtype">void</span> WII::write0x08Value() {
<a name="l01195"></a>01195         uint8_t cmd = 0x08;
<a name="l01196"></a>01196         writeData(0xb00030, 1, &amp;cmd);
<a name="l01197"></a>01197 }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199 <span class="keywordtype">void</span> WII::setWiiModeNumber(uint8_t mode_number) { <span class="comment">// mode_number in hex i.e. 0x03 for extended mode</span>
<a name="l01200"></a>01200         writeData(0xb00033, 1, &amp;mode_number);
<a name="l01201"></a>01201 }
<a name="l01202"></a>01202 <span class="preprocessor">#endif</span>
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_wii_8cpp.html">Wii.cpp</a>      </li>

    <li class="footer">Generated on Sun Mar 30 2014 17:05:29 for GHID Framework by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
